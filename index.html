<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards + Comparateur</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%93%9A%3C/text%3E%3C/svg%3E">
    <style>
        /* STYLES D'AUTHENTIFICATION */
        .auth-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10000;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            width: 100%;
            max-width: 450px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-input-group {
            margin-bottom: 15px;
        }

        .auth-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .auth-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            margin-top: 10px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .auth-toggle a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .auth-success {
            background: #38ef7d;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .guest-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            margin-top: 10px;
            width: 100%;
        }

        .guest-button:hover {
            transform: translateY(-2px);
        }

        /* Styles existants de l'application */
        :root {
            --bg-gradient-from: #667eea;
            --bg-gradient-to: #764ba2;
            --primary: #667eea;
            --primary-2: #764ba2;
            --accent: #11998e;
            --accent-2: #38ef7d;
            --danger: #ff6b6b;
            --text: #333333;
            --text-soft: #666666;
            --panel: #ffffff;
            --panel-muted: #f5f7fa;
            --border: #e0e0e0;
            --shadow: rgba(0,0,0,0.08);
            --card-bg: #ffffff;
            --card-grad-from: #f5f7fa;
            --card-grad-to: #c3cfe2;
            --known: #38ef7d;
            --partial: #f5a623;
            --unknown: #ff6b6b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-from) 0%, var(--bg-gradient-to) 100%);
            min-height: 100vh;
            display: flex;
            color: var(--text);
        }

        .sidebar {
            width: 280px;
            background: var(--panel);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 100;
            transition: transform 0.3s ease;
            border-right: 1px solid var(--border);
        }
        .sidebar.hidden { transform: translateX(-280px); }

        .sidebar-header {
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
            color: white;
        }
        .sidebar-header h1 { font-size: 22px; margin-bottom: 5px; }
        .sidebar-header p { font-size: 13px; opacity: 0.9; }

        .sidebar-nav { padding: 20px; border-bottom: 2px solid var(--border); }
        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; font-weight: 500; color: var(--text); }
        .nav-item:hover { background: var(--panel-muted); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; }

        .folder-section { flex: 1; overflow-y: auto; padding: 20px; background: var(--panel); }
        .folder-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .folder-section-header h3 { font-size: 14px; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.5px; }

        .btn-new-folder, .btn-new-category { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s; }
        .btn-new-folder:hover, .btn-new-category:hover { filter: brightness(90%); }
        .btn-new-category { background: var(--accent); }

        .category-item { margin-bottom: 10px; }
        .category-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: var(--panel-muted); border-radius: 6px; cursor: pointer; transition: all 0.3s; color: var(--text); }
        .category-header:hover { background: var(--border); }
        .category-header.active { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: white; }
        .category-left { display: flex; align-items: center; gap: 8px; flex: 1; }
        .category-toggle { font-size: 12px; transition: transform 0.3s; }
        .category-toggle.open { transform: rotate(90deg); }
        .category-name { font-weight: 600; font-size: 14px; }
        .category-count { background: rgba(0,0,0, 0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; color: inherit; margin-left: 5px; }
        .category-actions { display: flex; gap: 5px; opacity: 0; transition: all 0.3s; }
        .category-header:hover .category-actions { opacity: 1; }

        .btn-edit-category, .btn-delete-category { background: none; border: none; color: var(--text-soft); cursor: pointer; font-size: 14px; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .category-header.active .btn-edit-category, .category-header.active .btn-delete-category { color: rgba(255, 255, 255, 0.8); }
        .btn-edit-category:hover { color: var(--primary); }
        .category-header.active .btn-edit-category:hover { color: white; }
        .btn-delete-category:hover { color: var(--danger); }

        .category-folders { padding-left: 15px; margin-top: 5px; display: none; }
        .category-folders.open { display: block; }

        .folder-item { padding: 10px 15px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: space-between; color: var(--text); }
        .folder-item:hover { background: var(--panel-muted); }
        .folder-item.active { background: var(--panel-muted); color: var(--primary); font-weight: 600; border: 1px solid var(--primary); }
        .folder-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .folder-badge { background: rgba(0,0,0, 0.05); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; color: var(--text-soft); }
        .folder-item.active .folder-badge { background: rgba(102, 126, 234, 0.2); color: var(--primary); }
        .folder-actions { display: flex; gap: 5px; opacity: 0; transition: all 0.3s; }
        .folder-item:hover .folder-actions { opacity: 1; }
        .btn-edit-folder, .btn-delete-folder { background: none; border: none; color: var(--text-soft); cursor: pointer; font-size: 14px; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .btn-edit-folder:hover { color: var(--primary); }
        .btn-delete-folder:hover { color: var(--danger); }

        .toggle-sidebar-btn { position: fixed; left: 290px; top: 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); border: none; color: white; width: 48px; height: 48px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 101; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .toggle-sidebar-btn:hover { transform: translateY(-2px) scale(1.05); }
        .toggle-sidebar-btn.sidebar-hidden { left: 10px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .toggle-icon { transition: transform 0.3s ease; display: inline-block; }
        .toggle-sidebar-btn.sidebar-hidden .toggle-icon { transform: rotate(180deg); }

        .main-content {
			flex: 1;
			width: 100%;
		}
		
        .main-content.sidebar-hidden { margin-left: 0; }

		.container {
			max-width: none !important;
			width: 100% !important;
			margin: 0 !important;
		}
       	.app-header {
			max-width: 1200px !important; /* ajuste: 1000 / 1200 / 1400 */
			margin-left: auto !important;
			margin-right: auto !important;
			width: 100% !important;
		}
        .app-header h1 { margin: 0; font-size: 22px; color: var(--text); }
        .app-header p { margin: 0; font-size: 13px; color: var(--text-soft); }

        .btn-comparator { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: white; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s; margin-left: 10px; }
        .btn-comparator:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .home-page { text-align: center; }
        .home-hero { padding: 60px 40px; }
        .home-hero h1 { font-size: 48px; color: var(--text); margin-bottom: 20px; }
        .home-hero p { font-size: 18px; color: var(--text-soft); line-height: 1.6; margin-bottom: 10px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .stat-card { background: linear-gradient(135deg, var(--panel-muted) 0%, #e0e7ff 100%); padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .stat-card-value { font-size: 36px; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
        .stat-card-label { font-size: 14px; color: var(--text-soft); font-weight: 500; }

        .quick-actions { margin-top: 40px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn-action { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-action-secondary { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .btn-export-all { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #111; border: none; border-radius: 10px; padding: 15px 30px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-export-all:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .recent-courses { margin-top: 50px; text-align: left; }
        .recent-courses h2 { font-size: 24px; color: var(--text); margin-bottom: 20px; }
        .course-list { display: flex; flex-direction: column; gap: 15px; }
        .course-card { background: var(--panel-muted); padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .course-card:hover { background: #e8ebff; transform: translateX(5px); }
        .course-card-left { flex: 1; }
        .course-card-title { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 5px; }
        .course-card-info { font-size: 14px; color: var(--text-soft); }
        .course-card-arrow { font-size: 24px; color: var(--primary); }

        .lists-page h2 { color: var(--text); margin-bottom: 10px; font-size: 28px; display: inline-block; }
        .lists-page-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .btn-edit-page-title { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.3s; }
        .lists-page-subtitle { color: var(--text-soft); font-size: 14px; margin-bottom: 30px; }
        .lists-grid { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
        .list-card { background: linear-gradient(135deg, var(--panel-muted) 0%, #e0e7ff 100%); padding: 25px 30px; border-radius: 15px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); position: relative; display: flex; justify-content: space-between; align-items: center; }
        .list-card:hover { transform: translateX(5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
        .list-card-left { flex: 1; }
        .list-card-title { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
        .list-card-count { font-size: 14px; color: var(--text-soft); margin-bottom: 5px; }
        .list-card-progress { font-size: 13px; color: var(--primary); font-weight: 600; }
        .list-card-actions { display: flex; gap: 12px; }
        .btn-list-action { padding: 15px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; color: white; min-width: 140px; }
        .btn-study { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); }
        .btn-manage { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .list-card-buttons { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0; transition: all 0.3s; }
        .list-card:hover .list-card-buttons { opacity: 1; }
        .btn-edit-list, .btn-delete-list, .btn-embed { background: rgba(255, 255, 255, 0.9); border: none; color: var(--primary); cursor: pointer; font-size: 11px; padding: 4px 7px; border-radius: 3px; transition: all 0.3s; line-height: 1; }
        .btn-edit-list:hover, .btn-embed:hover { background: var(--primary); color: white; }
        .btn-delete-list { color: var(--danger); }
        .btn-delete-list:hover { background: var(--danger); color: white; }
        .btn-new-list { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; }
		.page-header .btn,
		.lists-page-header .btn {
			background: rgba(255, 255, 255, 0.92);
			color: #111827;            /* texte bien foncé */
			border: 2px solid rgba(17, 24, 39, 0.25);
			font-weight: 800;
			box-shadow: 0 10px 24px rgba(0,0,0,0.18);
		}

		.page-header .btn:hover,
		.lists-page-header .btn:hover {
			background: #ffffff;
			border-color: rgba(17, 24, 39, 0.45);
			transform: translateY(-1px);
		}

        .manage-cards-page h2 { color: var(--text); margin-bottom: 10px; font-size: 28px; }
        .breadcrumb { color: var(--text-soft); font-size: 14px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .breadcrumb a { color: var(--primary); text-decoration: none; cursor: pointer; }
        .manage-section { margin-bottom: 40px; }
        .manage-section h3 { font-size: 20px; color: var(--text); margin-bottom: 15px; }
        .cards-list { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .card-edit-item { background: var(--panel-muted); padding: 20px; border-radius: 12px; border: 2px solid transparent; transition: all 0.3s; }
        .card-edit-item:hover { border-color: var(--primary); }
        .card-edit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-edit-number { font-size: 14px; font-weight: 600; color: var(--primary); }
        .btn-delete-card { background: var(--danger); color: white; padding: 5px 12px; border: none; border-radius: 5px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-edit-card { background: var(--primary); color: white; padding: 5px 12px; border: none; border-radius: 5px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .card-inline-editor openEditCard(i);
		return;
        .btn-save-card { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: #fff; border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
        .btn-cancel-card { background: var(--border); color: var(--text); border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
        .btn-edit-current { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: #fff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; }

        .card-edit-content { display: flex; flex-direction: column; gap: 10px; }
        .card-edit-text { font-size: 14px; color: var(--text); }
        .card-edit-label { font-weight: 600; color: var(--text-soft); margin-right: 5px; }
        .editor-toolbar {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            padding: 8px;
            background: var(--panel-muted);
            border-radius: 8px;
            border: 1px solid var(--border);
            align-items: center;
        }
        .editor-btn{
            font-size: 12px !important;
            padding: 4px 8px !important;
            border-width: 1px !important;
            line-height: 1 !important;
            min-width: 0 !important;
            min-height: 0 !important;
        }
        .editor-btn:hover { background: var(--primary); color: white; }
        .editor-content { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; font-family: inherit; min-height: 120px; resize: vertical; overflow-y: auto; background: var(--panel); color: var(--text); }
        .editor-content:focus { outline: none; border-color: var(--primary); }
        .empty-cards-message { text-align: center; padding: 40px; color: var(--text-soft); font-size: 16px; }

        .study-page h2 { color: var(--text); margin-bottom: 20px; font-size: 28px; }
        .study-mode-indicator { display: inline-block; background: var(--partial); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .study-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .progress-bar {
			background: var(--border);
			height: 8px;
			border-radius: 10px;
			margin-bottom: 20px;
			overflow: hidden;
			padding: 0;
			line-height: 0;
		}

		.progress-fill {
			background: linear-gradient(90deg, var(--primary), var(--primary-2));
			height: 100%;
			width: 0%;
			display: block;
			border-radius: inherit;
			transition: width 0.3s ease;
			font-size: 0;
			line-height: 0;
			overflow: hidden;
			white-space: nowrap;
		}

        .card-container { perspective: 1000px; margin-bottom: 30px; }
        .card { background: transparent; border-radius: 15px; min-height: 300px; max-height: 500px; cursor: pointer; transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
        .card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 40px; overflow-y: auto; overflow-x: hidden; background: var(--card-bg); border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); color: var(--text); }
        .card-back { transform: rotateY(180deg); }
        .card-text { font-size: 24px; color: var(--text); font-weight: 500; line-height: 1.5; width: 100%; text-align: center; }
        .card-text img { max-width: 100%; height: auto; display: inline-block; margin: 5px; border-radius: 8px; vertical-align: middle; }
		.container {
			max-width: none !important;
			width: 100% !important;
			padding-left: 24px;
			padding-right: 24px;
		}

		.quick-actions,
		.quick-actions-bar {
			width: 100% !important;
		}

		.quick-actions .btn-action,
		.quick-actions .btn-action-secondary,
		.quick-actions .btn-export-all {
			flex: 1;
			min-width: 0;
		}

		.course-list {
			width: 100% !important;
		}

		.course-card {
			width: 100% !important;
		}
		
		.main-content {
			width: 100%;
		}
		
		.container {
			max-width: none !important;
			width: 100% !important;
		}

		.quick-actions { width: 100% !important; }
		.course-list, .course-card { width: 100% !important; }

        .buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        button { padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; color: white; flex: 1; min-width: 150px; }
        .btn-known { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .btn-partial { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .btn-unknown { background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%); }
        .stats { text-align: center; margin-top: 20px; color: var(--text-soft); font-size: 14px; }
        .flip-hint { text-align: center; color: var(--text-soft); font-size: 14px; margin-bottom: 20px; font-style: italic; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text); font-weight: 600; }
        .input-group input[type="text"], .input-group input[type="color"] {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--panel);
            color: var(--text);
            box-sizing: border-box;
        }
        .input-group input[type="text"]:focus { outline: none; border-color: var(--primary); }
        .input-group select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--panel);
            color: var(--text);
            box-sizing: border-box;
            cursor: pointer;
        }
        .btn-add { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); width: 100%; margin-top: 10px; }

        .end-message { text-align: center; padding: 40px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; }
        .end-message h2 { color: var(--text); margin-bottom: 30px; }

        .stat-bar-track { width: 100%; height: 30px; background: var(--panel-muted); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .stat-bar-fill-known { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .stat-bar-fill-partial { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .stat-bar-fill-unknown { background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%); }
		.stat-bar-fill {
			font-size: 0;
			line-height: 0;
			color: transparent;
			overflow: hidden;
			white-space: nowrap;
			height: 100%;
			display: block;
		}
        .legend-known { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .legend-partial { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .legend-unknown { background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%); }

        .btn-restart { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); }
        .btn-review { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .btn-next-list { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .btn-export { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn-clear { background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 15px; max-width: 400px; width: 90%; position: relative; z-index: 1001; color: var(--text); }
        .modal-header { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text); }
        .btn-cancel { background: var(--border); color: var(--text); }
        .btn-cancel:hover { filter: brightness(90%); }

        .page { display: none; }
        .page.active { display: block; }
        #fileInput, #imageInput { display: none; }

        /* THÈME MODAL */
        #themeModal { z-index: 3000; }
        #themeModal .modal-content {
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
        }

        .theme-section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--panel-muted);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .theme-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .color-option {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .color-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-soft);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .color-preview {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-preview:hover {
            transform: scale(1.05);
        }

        .color-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input-wrapper input[type="color"] {
            width: 50px;
            height: 40px;
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 0;
            cursor: pointer;
            background: var(--panel);
        }

        .color-input-wrapper input[type="text"] {
            flex: 1;
            padding: 8px 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-family: monospace;
            background: var(--panel);
            color: var(--text);
        }

        .presets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .preset-btn {
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--panel);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .preset-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .preset-preview {
            width: 100%;
            height: 60px;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .theme-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .theme-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .theme-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
            color: white;
        }

        .theme-btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .theme-btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%);
            color: white;
        }

        .theme-btn-success {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: white;
        }

        .live-preview {
            margin-top: 20px;
            padding: 15px;
            background: var(--panel);
            border-radius: 10px;
            border: 2px solid var(--border);
        }

        .live-preview h4 {
            margin: 0 0 10px 0;
            color: var(--text);
            font-size: 16px;
        }

        .preview-elements {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .preview-element {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

		/* 1) Le bloc principal ne doit pas ajouter un gros padding */
		.main-content {
			padding: 20px !important;   /* au lieu de 40px */
		}

		/* 2) Le header + le container sont centrés dans la zone main-content */
		.app-header,
		.container {
			max-width: 1200px !important;
			width: 100% !important;
			margin-left: auto !important;
			margin-right: auto !important;
		}

/* 3) Évite le double padding (si tu gardes celui de main-content) */
		.app-header,
		.container {
			padding-left: 24px !important;
			padding-right: 24px !important;
		}

/* 4) Important : supprime le vieux margin auto + max-width:800 qui traîne */
		.app-header {
			margin: 0 auto 20px auto !important;
		}

		/* Centre tous les containers visibles dans le contenu principal */
		#mainContent .container,
		#mainContent .app-header {
			max-width: 1200px !important;
			width: 100% !important;
		}

		/* Empêche les vieux margins qui décalent */
		#mainContent {
			display: block;
		}

		#mainContent .container,
		#mainContent .app-header {
			padding-left: 24px !important;
			padding-right: 24px !important;
		}

		/* 1) Remettre le décalage pour laisser la place à la sidebar */
		.main-content {
			margin-left: 280px !important;
			padding: 20px !important;
		}

/* Quand la sidebar est cachée */
		.main-content.sidebar-hidden {
			margin-left: 0 !important;
		}

/* 2) Recentrer correctement les blocs */
		#mainContent .container,
		#mainContent .app-header {
			max-width: 1200px !important;
			width: 100% !important;
			margin-left: auto !important;
			margin-right: auto !important;
		}

/* 3) IMPORTANT : annuler ton ancien "margin:0 !important" */
		#mainContent .container {
			margin: 0 auto !important;
		}

		.card-edit-item .card-inline-editor {
			display: grid;
			grid-template-columns: 1fr 220px; /* éditeur | panneau */
			gap: 12px;
			align-items: start;
		}

		.format-panel{
			background: var(--panel-muted);
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 10px;
		}

		.format-title{
			font-size: 11px;
			font-weight: 800;
			color: var(--text-soft);
			text-align: center;
			margin-bottom: 8px;
			letter-spacing: .6px;
		}

		.format-grid-3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; margin-bottom:10px; }
		.format-grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; }

		.format-subtitle{ font-size: 10px; color: var(--text-soft); text-align:center; margin: 6px 0 4px; }
		.format-mini-label{ font-size: 9px; color: var(--text-soft); text-align:center; margin-bottom:3px; }

		.format-select{
			width: 100%;
			padding: 6px;
			border: 1px solid var(--border);
			border-radius: 6px;
			background: var(--panel);
			font-size: 12px;
		}

		.format-hint{
			margin-top: 8px;
			padding: 6px;
			border: 1px dashed var(--border);
			border-radius: 6px;
			font-size: 10px;
			color: var(--text-soft);
			text-align: center;
			background: var(--panel);
		}

        /* STYLES COMPARATEUR */
        #comparatorModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow: auto; }
        #comparatorModal.show { display: block; }
        .comparator-container { background: #0b0c0f; color: #e8ecf3; min-height: 100vh; padding: 20px; }
        .comparator-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #23262d; background: #14161a; margin-bottom: 20px; border-radius: 10px; }
        .comparator-header h1 { margin: 0; font-size: 20px; }
        .btn-close-comparator { background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-close-comparator:hover { background: #ee5a6f; }
        .comparator-main { display: grid; grid-template-columns: 1fr 360px; gap: 20px; }
        .comparator-section { }
        .comparator-aside { background: #14161a; border-radius: 12px; padding: 16px; }
        .comp-panel { background: #14161a; border: 1px solid #23262d; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .comp-panel h2 { margin: 0; padding: 12px 14px; border-bottom: 1px solid #23262d; font-size: 16px; }
        #diffOutput { padding: 14px; white-space: pre-wrap; word-break: break-word; }
        .comp-controls { display: grid; gap: 12px; padding: 12px; border: 1px solid #23262d; background: #14161a; border-radius: 12px; }
        .comp-controls textarea { width: 100%; min-height: 120px; resize: vertical; background: #0e1014; border: 1px solid #2a2f39; border-radius: 8px; color: #e8ecf3; padding: 10px; font-family: inherit; }
        .comp-controls label { font-weight: 600; margin-bottom: 6px; display: block; color: #e8ecf3; }
        .comp-controls button { background: #5b8cff; color: white; border: 0; border-radius: 8px; padding: 10px 12px; font-weight: 600; cursor: pointer; }
        .comp-controls button.secondary { background: #2a2f39; }
        .comp-split { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        mark.ins, mark.del { background: transparent; border-radius: 4px; color: #fff; padding: 0 2px; border: 1px solid; }
        mark.ins { box-shadow: inset 0 -0.45em rgba(31,191,71,0.4); border-color: rgba(31,191,71,0.7); }
        mark.del { box-shadow: inset 0 -0.45em rgba(255,92,92,0.35); border-color: rgba(255,92,92,0.7); text-decoration: line-through; }
        mark.focused { box-shadow: inset 0 -0.48em rgba(255,209,102,0.9), 0 0 0 2px rgba(255,209,102,0.25) !important; border-color: rgba(255,209,102,0.85) !important; background: rgba(255,209,102,0.2) !important; }
        .comp-change.selected { border-color: #ffd166 !important; box-shadow: 0 0 0 2px rgba(255,209,102,0.25) !important; background: rgba(255,209,102,0.1); }
        .comp-summary { padding: 12px; border-bottom: 1px solid #23262d; }
        .comp-summary small { color: #8b93a6; }
        code.badge { background: #222630; border: 1px solid #2a2f39; padding: 2px 6px; border-radius: 6px; font-size: 12px; }
        .comp-toolbar { display: flex; gap: 8px; align-items: center; padding: 8px; border-bottom: 1px solid #23262d; }
        .comp-changes { padding: 8px; max-height: 500px; overflow: auto; }
        .comp-change { display: block; text-align: left; width: 100%; background: transparent; border: 1px solid #2a2f39; border-radius: 10px; color: #e8ecf3; padding: 10px; margin: 8px 0; cursor: pointer; }
        .comp-change:hover { border-color: #ffd166; }
        .comp-change.selected { border-color: #ffd166; box-shadow: 0 0 0 2px rgba(255,209,102,0.25); }
        .comp-change .type { font-weight: 700; margin-bottom: 6px; display: block; }
        .comp-change .token { display: inline; color: #fff; padding: 0 1px; border-radius: 4px; border: 1px solid; }
        .comp-change .token { box-shadow: inset 0 -0.35em rgba(31,191,71,0.4); border-color: rgba(31,191,71,0.7); }
        .comp-change .token.del { box-shadow: inset 0 -0.35em rgba(255,92,92,0.35); border-color: rgba(255,92,92,0.7); text-decoration: none; }
        .comp-change .ctx { color: #8b93a6; display: block; margin-top: 6px; font-size: 12px; }
           /* Bouton retour à la sélection */
		#backToSelected:hover { filter: brightness(0.95); }
    
    /* Fantôme suppression avec parenthèses rouges */
    .del-ghost { display: inline-block; margin: 0 2px; color: #fff; }
    .del-ghost mark.del { text-decoration: none; box-shadow: inset 0 -0.45em rgba(255,92,92,0.35); border-color: rgba(255,92,92,0.7); }
    .focus-ghost { display: inline-block; width: 10px; height: 1.2em; vertical-align: baseline; box-shadow: inset 0 -0.48em rgba(255,209,102,0.9), 0 0 0 2px rgba(255,209,102,0.25); border: 1px dashed rgba(255,209,102,0.85); border-radius: 4px; }
    
    /* Plus de contraste vert dans barre latérale */
.comp-change .token { box-shadow: inset 0 -0.35em rgba(34,197,94,0.7); border-color: rgba(34,197,94,1); background: rgba(34,197,94,0.15); }
mark.ins { box-shadow: inset 0 -0.45em rgba(34,197,94,0.6); border-color: rgba(34,197,94,0.9); }
    
    @media (max-width: 1000px) { .comparator-main { grid-template-columns: 1fr; } }
	/* Bouton Editer compact (barre d'étude) */
.btn-edit-current {
  background: #667eea;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  line-height: 1;
}
.btn-edit-current:hover { background:#5568d3; box-shadow:0 3px 10px rgba(102,126,234,0.35); transform: translateY(-1px); }

        .btn-filter-del { background: #2a2f39; color: #e8ecf3; border: 0; border-radius: 8px; padding: 8px 10px; font-weight: 700; cursor: pointer; }
        .btn-filter-del.active { background: #ff6b6b; color: #fff; }

        /* GIF de félicitations */
        .result-gif {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        .result-gif img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        .result-gif.show { display: block; }

        /* Styles pour les badges d'importance */
        .card-importance-header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
            pointer-events: none;
            opacity: 0.8;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-importance-header.important { background: #10b981; color: white; }
        .card-importance-header.normal { background: #3b82f6; color: white; }
        .card-importance-header.pas-important { background: #ef4444; color: white; }
        .card-importance-header.explication { background: #6b7280; color: white; }

        .card:hover .card-importance-header {
            opacity: 1;
        }

        /* Contrôles de filtrage par importance */
        .filter-controls {
            background: var(--panel-muted);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .filter-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-soft);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .filter-btn.important { background: #10b98120; color: #10b981; border-color: #10b981; }
        .filter-btn.normal { background: #3b82f620; color: #3b82f6; border-color: #3b82f6; }
        .filter-btn.pas-important { background: #ef444420; color: #ef4444; border-color: #ef4444; }
        .filter-btn.explication { background: #6b728020; color: #6b7280; border-color: #6b7280; }

        .filter-btn.active.important { background: #10b981; color: white; }
        .filter-btn.active.normal { background: #3b82f6; color: white; }
        .filter-btn.active.pas-important { background: #ef4444; color: white; }
        .filter-btn.active.explication { background: #6b7280; color: white; }

        .filter-btn .count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            min-width: 24px;
            text-align: center;
        }

        .filter-btn.active .count {
            background: rgba(255,255,255,0.3);
        }

        /* Indicateur de filtrage actif */
        .filter-indicator {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow-y: auto;
            overflow-x: hidden;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            color: var(--text);
        }

        /* Ajustement du padding pour laisser de la place au badge */
        .card-front {
            padding-top: 60px !important;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        /* Options de filtrage dans le mode révision */
        .review-options {
            background: var(--panel-muted);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }

        .review-options h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Styles pour la section utilisateur */
        .user-section {
            padding: 20px;
            border-bottom: 2px solid var(--border);
            background: var(--panel-muted);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .user-info:hover {
            opacity: 0.9;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--text);
            font-size: 16px;
        }

        .user-status {
            font-size: 12px;
            color: var(--text-soft);
        }

        .user-search {
            margin-top: 15px;
        }

        .user-search input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--panel);
            color: var(--text);
        }

        .user-search-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--panel);
        }

        .user-result {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-result:hover {
            background: var(--panel-muted);
        }

        .user-result-avatar {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
            border: 2px solid white;
        }

        .user-result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-result-info {
            flex: 1;
        }

        .user-result-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-result-stats {
            font-size: 11px;
            color: var(--text-soft);
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background: var(--border);
            color: var(--text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: white;
        }

        .public-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-soft);
        }

        .public-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Modal paramètres utilisateur */
        .profile-settings-modal .modal-content {
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .profile-form .input-group {
            margin-bottom: 8px;
        }

        .profile-form .input-group label {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .profile-form .input-group input,
        .profile-form .input-group textarea {
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 2px solid var(--border);
            width: 100%;
        }

        .profile-form .input-group textarea {
            min-height: 60px;
            resize: vertical;
        }

        .avatar-upload {
            text-align: center;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            overflow: hidden;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview:hover::after {
            content: '📷';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .avatar-upload input {
            display: none;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .danger-zone {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--danger);
        }

        .danger-zone h4 {
            color: var(--danger);
            margin-bottom: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%);
            color: white;
        }

        /* Message de notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-weight: 600;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%);
        }

        /* Styles pour le mode plein écran */
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, var(--bg-gradient-from) 0%, var(--bg-gradient-to) 100%);
            z-index: 10000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .fullscreen-mode.active {
            display: flex;
        }

        .fullscreen-card-container {
            width: 90%;
            height: 80%;
            perspective: 1000px;
            position: relative;
        }

        .fullscreen-card {
            width: 100%;
            height: 100%;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .fullscreen-card.flipped {
            transform: rotateY(180deg);
        }

        .fullscreen-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            overflow-y: auto;
            border-radius: 20px;
        }

        .fullscreen-card-front {
            background: var(--card-bg);
        }

        .fullscreen-card-back {
            background: var(--card-bg);
            transform: rotateY(180deg);
        }

        .fullscreen-card-text {
            font-size: 28px;
            line-height: 1.6;
            color: var(--text);
            text-align: center;
            width: 100%;
        }

        .fullscreen-card-text img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 10px 0;
        }

        .fullscreen-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 10001;
        }

        .fullscreen-btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            min-width: 140px;
        }

        .fullscreen-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-close-btn:hover {
            background: rgba(0,0,0,0.7);
        }

        .btn-fullscreen {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-fullscreen:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
		.card-top-actions{
  			display:flex;
  			justify-content:center;
  			gap:8px;
 			margin:6px 0 12px 0;
		}
		.btn-top-mini{
 			padding:6px 10px;
  			border:1px solid rgba(0,0,0,0.08);
  			border-radius:12px;
  			background:rgba(255,255,255,0.65);
  			color:var(--text);
  			font-weight:700;
  			font-size:12px;
  			cursor:pointer;
  			line-height:1;
		}
		.btn-top-mini:hover{
  		transform:translateY(-1px);
  		background:rgba(255,255,255,0.85);
		}
		
		.app-header {
			width: 100% !important;
			max-width: none !important;
			padding-left: 24px !important; 
			padding-right: 24px !important;
			box-sizing: border-box;
		}

		.app-header {
			display: flex;
			gap: 16px;
		}

		.app-header > * {
			flex: 1 1 0;
			min-width: 0;
		}

		.recent-courses,
		.course-list,
		#courseList,
		.course-card {
			width: 100% !important;
			max-width: none !important;
			box-sizing: border-box;
		}
		/* Page catégorie + conteneur des cours : pleine largeur */
		#categoryPage,
		#categoryCoursesList {
			width: 100% !important;
			max-width: none !important;
			box-sizing: border-box;
		}

		#toggleSidebarBtn.toggle-sidebar-btn {
			width: 16px !important;
			height: 24px !important;
			padding: 0 !important;
			border-radius: 8px !important;
		}

		#toggleSidebarBtn.toggle-sidebar-btn {
			font-size: 14px !important;
			line-height: 1 !important;
		}

		#toggleSidebarBtn.toggle-sidebar-btn svg {
			width: 12px !important;
			height: 12px !important;
		}
		
		button#toggleSidebarBtn {
			flex: 0 0 auto !important;
			width: 24px !important;       /* <- largeur */
			height: 24px !important;
			min-width: 24px !important;
			max-width: 24px !important;
			flex-basis: 24px !important;
			padding: 0 !important;
		}
		
		#cardsList .format-panel{
			display: block !important;
			visibility: visible !important;
			opacity: 1 !important;
			position: relative !important;
			z-index: 9999 !important;
			background: white !important;
		}

		.card-edit-item{
			display: grid;
			grid-template-columns: 1fr 240px;
			gap: 12px;
			align-items: start;
		}
		
		.card-edit-item {
			display: grid;
			grid-template-columns: 1fr 240px;
			gap: 12px;
			align-items: start;
		}

		.card-edit-item > .card-inline-editor {
			grid-column: 1;
		}

		.card-edit-item > .format-panel {
			grid-column: 2;
		}

		#cardSection { position: relative; }

		#btnPrevStudy:hover{
			transform: translateY(-50%) scale(1.05);
		}

		body .page#studyPage.active #btnPrevStudy{
			display: inline-flex;
			align-items: center;
			justify-content: center;
		}

		#btnPrevStudy{
			/* annule le style global des button */
			flex: 0 0 auto !important;
			min-width: 0 !important;
			padding: 0 !important;

			/* style “rond à droite” */
			position: absolute;
			right: 12px;
			top: 50%;
			transform: translateY(-50%);
			width: 44px;
			height: 44px;
			border-radius: 999px;
			border: 1px solid var(--border);
			background: rgba(255,255,255,0.92);
			color: var(--text);
			box-shadow: 0 10px 24px rgba(0,0,0,0.18);
			z-index: 50;

			display: inline-flex !important;
			align-items: center;
			justify-content: center;
		}

		/* le parent doit être positionné */
		#cardSection{ position: relative; }

		#btnPrevFullscreen{
			position: absolute;
			right: 30px;
			bottom: 90px;   /* ✅ en bas */
			top: auto;
			transform: none;

			width: 30px;    /* ✅ plus petit */
			height: 30px;
			padding: 0 !important;        /* ✅ annule le padding global */
			min-width: 0 !important; 
			border-radius: 999px;
			border: 1px solid rgba(255,255,255,0.25);
			background: rgba(0,0,0,0.45);
			color: white;
			cursor: pointer;
			font-weight: 900;
			font-size: 14px !important;   /* ✅ plus petit */
			line-height: 1 !important;
			z-index: 10002;

			display: none;
		}

		.fullscreen-mode.active #btnPrevFullscreen{
			display: inline-flex;
			align-items: center;
			justify-content: center;
		}
		
		.no-flip-anim {
			transition: none !important;
		}
		.card-edit-item[draggable="true"]{
			cursor: grab;
		}

		.card-edit-item.dragging{
			opacity: 0.6;
			cursor: grabbing;
		}

		.card-edit-item.drag-over{
			outline: 2px dashed var(--primary);
			outline-offset: 4px;
		}
		.flash-focus{
			outline: 2px solid var(--accent);
			outline-offset: 4px;
		}
		.floating-last-card{
			position: fixed;
			right: 12px;
			bottom: 12px;

			width: 26px !important;
			height: 26px !important;
			min-width: 0 !important;
			padding: 0 !important;

			border-radius: 999px;
			border: 1px solid rgba(255,255,255,0.15);

			background: rgba(0,0,0,0.35); /* minimaliste */
			color: white;

			font-size: 13px !important;
			line-height: 1 !important;
			font-weight: 900;

			box-shadow: 0 6px 16px rgba(0,0,0,0.25);
			z-index: 3000;

			display: none;
			align-items: center;
			justify-content: center;
		}

		.floating-last-card:hover{
			background: rgba(0,0,0,0.5);
			transform: scale(1.05);
		}

		.hist-item{
			width: 100%;
			text-align: left;
			padding: 10px 12px;
			border-radius: 10px;
			border: 1px solid rgba(255,255,255,0.12);
			background: rgba(255,255,255,0.06);
			color: #fff;
			cursor: pointer;
		}

		.hist-item.hist-add{
			border-color: rgba(31,191,71,0.55);
			box-shadow: inset 0 0 0 999px rgba(31,191,71,0.14);
		}

		.hist-item.hist-del{
			border-color: rgba(255,92,92,0.55);
			box-shadow: inset 0 0 0 999px rgba(255,92,92,0.14);
		}
		#backToSelected{
			position: fixed;
			right: 16px;
			bottom: 16px;
			z-index: 99999;
		}

		#backToSelected:not(.visible){
			display: none !important;
		}
		mark.focused{
			box-shadow: inset 0 -0.48em rgba(255,209,102,0.9), 0 0 0 2px rgba(255,209,102,0.25) !important;
			border-color: rgba(255,209,102,0.85) !important;
			background: rgba(255,209,102,0.2) !important;
		}
		#newText{ z-index: 1; }
		.focus-ghost.focused{
			box-shadow: inset 0 -0.48em rgba(255,209,102,0.9), 0 0 0 2px rgba(255,209,102,0.25) !important;
			border: 1px dashed rgba(255,209,102,0.85) !important;
			background: rgba(255,209,102,0.2) !important;
		}
		.focus-ghost.focused,
		.del-ghost.focused{
			box-shadow: inset 0 -0.48em rgba(255,209,102,0.9), 0 0 0 2px rgba(255,209,102,0.25) !important;
			border: 1px dashed rgba(255,209,102,0.85) !important;
			background: rgba(255,209,102,0.2) !important;
			border-radius: 4px;
		}
		/* Force le style sur la fiche normale */
		.card-text {
    		font-size: 24px;
    		color: var(--text);
    		font-weight: 500;
    		line-height: 1.5;
    		width: 100%;
    		text-align: center;
    /* Force la police système */
    		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
		}

/* Force tous les éléments à l'intérieur (gras, italique, span copiés) à hériter de la taille et police */
		.card-text * {
    		font-family: inherit !important;
   			font-size: inherit !important;
		}

/* Force le style sur la fiche plein écran (même taille 24px) */
		.fullscreen-card-text {
    		font-size: 24px;
    		line-height: 1.6;
    		color: var(--text);
    		text-align: center;
    		width: 100%;
    		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
		}

		.fullscreen-card-text * {
   			font-family: inherit !important;
   			font-size: inherit !important;
		}
		/* Focus jaune garanti */
		#diffOutput .focused,
		#diffOutput .focused mark,
		#diffOutput mark.focused {
			box-shadow: inset 0 -0.48em rgba(255,209,102,0.9), 0 0 0 2px rgba(255,209,102,0.25) !important;
			border-color: rgba(255,209,102,0.85) !important;
			background: rgba(255,209,102,0.2) !important;
		}
    </style>
</head>
<body onload="checkAuth()">
    <!-- PAGE D'AUTHENTIFICATION -->
    <div id="authPage" class="auth-page">
        <div class="auth-container">
            <div class="auth-header">
                <h1>📚 Flashcards+</h1>
                <p>Système d'apprentissage collaboratif</p>
            </div>

            <div id="authError" class="auth-error"></div>
            <div id="authSuccess" class="auth-success"></div>

            <div id="loginForm" class="auth-form">
                <h2 style="color: #333; margin-bottom: 10px;">Connexion</h2>
                <div class="auth-input-group">
                    <label for="loginUsername">Nom d'utilisateur</label>
                    <input type="text" id="loginUsername" placeholder="Votre nom d'utilisateur">
                </div>
                <div class="auth-input-group">
                    <label for="loginPassword">Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Votre mot de passe">
                </div>
                <button class="auth-button" onclick="login()">Se connecter</button>

                <div class="auth-toggle">
                    Pas encore de compte ? <a onclick="showRegister()">S'inscrire</a>
                </div>

                <button class="guest-button" onclick="loginAsGuest()">
                    👤 Continuer en tant qu'invité
                </button>
            </div>

            <div id="registerForm" class="auth-form" style="display: none;">
                <h2 style="color: #333; margin-bottom: 10px;">Inscription</h2>
                <div class="auth-input-group">
                    <label for="registerUsername">Nom d'utilisateur</label>
                    <input type="text" id="registerUsername" placeholder="Choisissez un nom d'utilisateur">
                </div>
                <div class="auth-input-group">
                    <label for="registerEmail">Email (optionnel)</label>
                    <input type="email" id="registerEmail" placeholder="votre@email.com">
                </div>
                <div class="auth-input-group">
                    <label for="registerPassword">Mot de passe</label>
                    <input type="password" id="registerPassword" placeholder="Choisissez un mot de passe">
                </div>
                <div class="auth-input-group">
                    <label for="registerConfirmPassword">Confirmer le mot de passe</label>
                    <input type="password" id="registerConfirmPassword" placeholder="Retapez votre mot de passe">
                </div>
                <button class="auth-button" onclick="register()">S'inscrire</button>

                <div class="auth-toggle">
                    Déjà un compte ? <a onclick="showLogin()">Se connecter</a>
                </div>
            </div>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE (cachée par défaut) -->
    <div id="appContent" style="display: none;">
        <button class="toggle-sidebar-btn" id="toggleSidebarBtn" onclick="toggleSidebar()"><span class="toggle-icon">◀</span></button>
        <div class="sidebar" id="sidebar">
            <!-- Section utilisateur -->
            <div class="user-section">
                <div class="user-info" onclick="openProfileSettings()">
                    <div class="user-avatar" id="userAvatar">
                        <!-- L'image sera ajoutée dynamiquement -->
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Utilisateur</div>
                        <div class="user-status" id="userStatus">Membre</div>
                    </div>
                </div>

                <div class="public-toggle">
                    <input type="checkbox" id="publicProfileToggle" onchange="togglePublicProfile()">
                    <label for="publicProfileToggle">Profil public</label>
                </div>

                <div class="user-search">
                    <input type="text" id="userSearchInput" placeholder="🔍 Rechercher un utilisateur..."
                           oninput="searchUsers()">
                    <div class="user-search-results" id="userSearchResults"></div>
                </div>

                <button class="logout-btn" onclick="logout()">Déconnexion</button>
            </div>

            <div class="sidebar-nav">
                <div class="nav-item active" onclick="showPage('home')"><span>🏠</span><span>Accueil</span></div>
            </div>
            <div class="folder-section">
                <div class="folder-section-header">
                    <h3>Organisation</h3>
                    <div class="folder-section-buttons">
                        <button class="btn-new-category" onclick="showNewCategoryModal()" title="Nouvelle catégorie">📁</button>
                        <button class="btn-new-folder" onclick="showNewFolderModal()" title="Nouveau cours">+</button>
                    </div>
                </div>
                <div id="categoryList"></div>
            </div>
        </div>
        <div class="main-content" id="mainContent">
            <div class="app-header" style="padding:10px 40px;">
                <button class="btn-comparator" onclick="openComparator()">
                    🔍 Comparateur de texte
                </button>
                <button class="btn-comparator" onclick="openThemeModal()">🎨 Personnaliser le thème</button>
            </div>
            <div id="homePage" class="page active">
                <div class="container home-page">
                    <div class="home-hero"><h1>Bienvenue ! 👋</h1><p>Apprends efficacement avec ton système de flashcards.</p></div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-card-value" id="totalCourses">0</div><div class="stat-card-label">Cours créés</div></div>
                        <div class="stat-card"><div class="stat-card-value" id="totalCards">0</div><div class="stat-card-label">Cartes totales</div></div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn-action" onclick="showNewFolderModal()">➕ Créer un cours</button>
                        <button class="btn-action btn-action-secondary" onclick="importCards()">📥 Importer</button>
                        <button class="btn-export-all" onclick="exportAll()">📦 Exporter tout</button>
                    </div>
                    <div class="recent-courses"><h2>Mes cours</h2><div class="course-list" id="courseList"></div></div>
                </div>
            </div>
            <div id="listsPage" class="page">
                <div class="container lists-page">
                    <div class="lists-page-header">
					<button class="btn" onclick="backToCourses()">← Cours</button>
					<h2 id="listsTitle">Cours</h2><button class="btn-edit-page-title" onclick="showRenameFolderModal()">✏️</button><button class="btn-edit-page-title" title="Intégrer ce cours" onclick="copyFolderEmbed()">🔗</button></div>
                    <p class="lists-page-subtitle">Sélectionne une liste à réviser</p>
                    <div class="lists-grid" id="listsGrid"></div>
                    <button class="btn-new-list" onclick="showNewListModal()">➕ Créer une nouvelle liste</button>
                </div>
            </div>
			<!-- PAGE : détails d'une catégorie (liste des cours) -->
			<div id="categoryPage" class="page" style="display:none;">
				<div class="page-header">
					<button class="btn" onclick="goHome()">← Accueil</button>
					<h2 id="categoryTitle">Catégorie</h2>
				</div>

				<div id="categoryCoursesList"></div>
			</div>
            <div id="managePage" class="page">
                <div class="container manage-cards-page">
                    <div class="breadcrumb"><a id="backToLists">← Retour aux listes</a></div>
                    <h2 id="manageTitle">Gérer les cartes</h2>
                    <div class="manage-section">
                        <div style="display: grid; grid-template-columns: 1fr 110px; gap: 15px; margin-bottom: 25px;">
                            <div>
                                <h3 style="margin-bottom: 12px; color: var(--text); font-size: 15px;">Ajouter une carte</h3>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                    <div class="input-group">
                                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                            <div style="background: var(--primary); color: white; width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; margin-right: 5px;">1</div>
                                            <label style="font-weight: 600; color: var(--text); font-size: 13px;">TERME</label>
                                        </div>
                                        <div class="editor-content" id="newQuestion" contenteditable="true" style="height: 100px; border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 13px; background: var(--panel); overflow-y: auto; resize: vertical; line-height: 1.4;"></div>
                                    </div>

                                    <div class="input-group">
                                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                            <div style="background: var(--primary); color: white; width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; margin-right: 5px;">2</div>
                                            <label style="font-weight: 600; color: var(--text); font-size: 13px;">DÉFINITION</label>
                                        </div>
                                        <div class="editor-content" id="newAnswer" contenteditable="true" style="height: 100px; border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 13px; background: var(--panel); overflow-y: auto; resize: vertical; line-height: 1.4;"></div>
                                    </div>
                                </div>

                                <button class="btn-add" onclick="addCard()" style="margin-top: 8px; padding: 8px 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; border: none; border-radius: 5px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                    <span>➕</span>
                                    <span>Ajouter la carte</span>
                                </button>
                            </div>

                            <div>
                                <div style="background: var(--panel-muted); padding: 8px; border-radius: 6px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 4px;">
                                    <div style="font-size: 11px; color: var(--text-soft); font-weight: 600; text-align: center; margin-bottom: 2px; text-transform: uppercase;">
                                        FORMAT
                                    </div>

                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; margin-bottom: 4px;">
                                        <button class="editor-btn" onclick="execFormatCommand('bold')" title="Gras" aria-label="Gras"><b>G</b></button>
                                        <button class="editor-btn" onclick="execFormatCommand('italic')" title="Italique" aria-label="Italique"><i>I</i></button>
                                        <button class="editor-btn" onclick="execFormatCommand('underline')" title="Souligné" aria-label="Souligné"><u>S</u></button>
										<button class="editor-btn" type="button" onclick="insertBulletNow()" title="Puce">•</button>
                                    </div>

                                    <div style="margin-bottom: 4px;">
                                        <div style="font-size: 9px; color: var(--text-soft); margin-bottom: 2px; text-align: center;">Couleurs</div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px;">
                                            <div>
                                                <div style="font-size: 8px; color: var(--text-soft); margin-bottom: 1px; text-align: center;">Texte</div>
                                                <input type="color"
													onmousedown="saveSelection()"
													oninput="applyColorToSelection('foreColor', this.value)">
												<button type="button" class="editor-btn" onclick="applySavedColor('foreColor','textColorPicker')">OK</button>
                                            </div>
                                            <div>
                                                <div style="font-size: 8px; color: var(--text-soft); margin-bottom: 1px; text-align: center;">Fond</div>
                                                <input type="color"
													onmousedown="saveSelection()"
													oninput="applyColorToSelection('backColor', this.value)">
												<button type="button" class="editor-btn" onclick="applySavedColor('backColor','bgColorPicker')">OK</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="margin-bottom: 4px;">
                                        <div style="font-size: 9px; color: var(--text-soft); margin-bottom: 2px; text-align: center;">Importance</div>
                                        <select id="importanceSelect" style="width: 100%; padding: 3px 4px; border: 1px solid var(--border); border-radius: 2px; font-size: 10px; background: var(--panel); cursor: pointer; height: 22px;">
                                            <option value="important">Important</option>
                                            <option value="normal" selected>Normal</option>
                                            <option value="pas important">Pas important</option>
                                            <option value="explication">Explication</option>
                                        </select>
                                    </div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-top: 2px;">
                                        <button class="editor-btn" onclick="insertImage()" style="padding: 3px; font-size: 9px; height: 22px; display: flex; align-items: center; justify-content: center; gap: 2px; border: 1px solid var(--border); border-radius: 2px; background: var(--panel);">
                                            <span>🖼️</span>
                                            <span style="font-size: 8px;">Image</span>
                                        </button>
                                        <button class="editor-btn" onclick="clearFormatNow()" title="Effacer la mise en forme" aria-label="Effacer la mise en forme">✖</button>
                                    </div>

                                    <div style="margin-top: 4px; padding: 3px; background: var(--panel); border-radius: 2px; border: 1px dashed var(--border);">
                                        <p style="font-size: 7px; color: var(--text-soft); text-align: center; line-height: 1.1; margin: 0;">
                                            Sélectionnez du texte<br>puis cliquez
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="manage-section">
                        <h3 style="margin-bottom: 10px; color: var(--text); font-size: 15px;">📋 Cartes existantes (<span id="cardCount">0</span>)</h3>
                        <div class="cards-list" id="cardsList"></div>
                    </div>
                    <div class="save-section" style="margin-top: 25px; padding-top: 12px; border-top: 1px solid var(--border);">
                        <h2 style="margin-bottom:10px;color:var(--text); font-size: 15px;">💾 Gestion des cartes</h2>
                        <div class="save-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn-export" onclick="exportCards()" style="padding: 6px 12px; font-size: 12px; border-radius: 3px; height: 30px;">📥 Exporter</button>
                            <button class="btn-clear" onclick="clearCurrentList()" style="padding: 6px 12px; font-size: 12px; border-radius: 3px; height: 30px;">🗑️ Vider</button>
                            <button class="btn-action" onclick="importCards()" style="padding: 6px 12px; font-size: 12px; border-radius: 3px; height: 30px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);">📥 Importer JSON</button>
                            <button class="btn-action btn-action-secondary" onclick="showImportTextModal()" style="padding: 6px 12px; font-size: 12px; border-radius: 3px; height: 30px;">📋 Importer Texte/CSV</button>
							<button class="btn-action btn-action-secondary" onclick="goToLastCard(true)"></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="studyPage" class="page">
                <div class="container study-page">
                    <div class="breadcrumb"><a id="backToListsStudy">← Retour aux listes</a></div>
                    <div class="study-controls">
                        <div>
                            <h2 id="studyTitle" style="display:inline">Liste</h2>
                            <span id="studyModeIndicator" class="study-mode-indicator" style="display:none">🔄 Mode révision</span>
                        </div>
			<div></div>
                    <div>
			<div></div>
                       </div>
                    </div>
                    <!-- Barre de progression ajoutée ici -->
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
					</div>
						<div class="review-options" id="importanceFilterUI">
  							<h4>🎯 Filtrer par importance</h4>
  							<div class="filter-buttons" style="justify-content:flex-start">
   								<label class="filter-btn important">
									<input type="checkbox" id="filterImpImportant" checked>
									Imp. <span id="countImpImportant" class="count">(0)</span>
								</label>

								<label class="filter-btn normal">
									<input type="checkbox" id="filterImpNormal" checked>
									Norm. <span id="countImpNormal" class="count">(0)</span>
								</label>

								<label class="filter-btn pas-important">
									<input type="checkbox" id="filterImpPasImportant" checked>
									Pas imp. <span id="countImpPasImportant" class="count">(0)</span>
								</label>

								<label class="filter-btn explication">
									<input type="checkbox" id="filterImpExplication" checked>
									Expl. <span id="countImpExplication" class="count">(0)</span>
								</label>
    							<button class="btn-action btn-action-secondary" onclick="applyImportanceFilter()">Appliquer</button>
  							</div>
						</div>
                    </div>
                    <div id="cardSection">
						<div class="card-top-actions">
  						<button class="btn-top-mini" id="btnEditCurrent" onclick="editCurrentCard()">✏️ Éditer</button>
  						<button class="btn-top-mini" onclick="openFullscreenStudy()">⛶ Plein écran</button>
						<button id="btnPrevStudy" onclick="goToPreviousCardUndo()" title="Fiche précédente">⟵</button>
					</div>
                        <div class="card-container">
                            <div class="card" id="flashcard" onclick="flipCard()">
                                <div class="card-face card-front">
  									<div class="card-importance-header" id="importanceBadge"></div>
  									<div class="card-text" id="question"></div>
							</div>
                                <div class="card-face card-back"><div class="card-text" id="answer"></div></div>
                            </div>
                        </div>
                        <div class="buttons">
                            <button class="btn-known" onclick="answer('known')">✓ Connu</button>
                            <button class="btn-partial" onclick="answer('partial')">~ Partiellement</button>
                            <button class="btn-unknown" onclick="answer('unknown')">✗ Pas connu</button>
                        </div>
                        <div class="stats" id="stats"></div>
                    </div>
                    <div id="emptyState" class="empty-state" style="display:none"><div class="empty-state-icon">📝</div><h3>Aucune carte</h3></div>
                    <div id="endSection" style="display:none">
                        <div class="end-message">
                            <h2>🎉 Session terminée !</h2>
                            <div class="chart-container">
                                <div class="stat-bar-container">
                                    <div class="stat-bar-item">
                                        <div class="stat-bar-label"><div class="stat-bar-label-left"><div class="stat-bar-icon legend-known"></div><span id="legendKnown">Connu: 0 (0%)</span></div></div>
                                        <div class="stat-bar-track"><div class="stat-bar-fill stat-bar-fill-known" id="barKnown" style="width:0%">0</div></div>
                                    </div>
                                    <div class="stat-bar-item">
                                        <div class="stat-bar-label"><div class="stat-bar-label-left"><div class="stat-bar-icon legend-partial"></div><span id="legendPartial">Partiel: 0 (0%)</span></div></div>
                                        <div class="stat-bar-track"><div class="stat-bar-fill stat-bar-fill-partial" id="barPartial" style="width:0%">0</div></div>
                                    </div>
                                    <div class="stat-bar-item">
                                        <div class="stat-bar-label"><div class="stat-bar-label-left"><div class="stat-bar-icon legend-unknown"></div><span id="legendUnknown">Pas connu: 0 (0%)</span></div></div>
                                        <div class="stat-bar-track"><div class="stat-bar-fill stat-bar-fill-unknown" id="barUnknown" style="width:0%">0</div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button class="btn-action" onclick="showNewFolderModal()">➕ Créer un cours</button>
                                <button class="btn-action btn-action-secondary" onclick="showImportTextModal()">📋 Importer (Texte/CSV)</button>
                                <button class="btn-action btn-action-secondary" onclick="importCards()">📥 Restaurer (JSON)</button>
                                <button class="btn-export-all" onclick="exportAll()">📦 Exporter tout</button>
								<button class="btn-list-action" onclick="restartCurrentList()">↩︎ Revoir la liste</button>
								<button class="btn-list-action" onclick="goToNextListInFolder()">⏭ Liste suivante</button>
                            </div>
                            <div id="resultGif" class="result-gif"><img id="resultGifImg" src="" alt="Bravo !"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODALS EXISTANTS -->
        <input type="file" id="fileInput" accept=".json">
        <input type="file" id="imageInput" accept="image/*">
        <input type="file" id="avatarInput" accept="image/*" style="display: none;">

        <!-- Modal Nouvelle Catégorie -->
        <div class="modal" id="newCategoryModal">
            <div class="modal-content">
                <div class="modal-header">Nouvelle catégorie</div>
                <div class="input-group">
                    <label for="categoryNameInput">Nom de la catégorie :</label>
                    <input type="text" id="categoryNameInput" placeholder="Ex: Droit S3">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeNewCategoryModal()">Annuler</button>
                    <button class="btn-add" onclick="createCategory()">Créer</button>
                </div>
            </div>
        </div>

        <!-- Modal Nouveau Cours -->
        <div class="modal" id="newFolderModal">
            <div class="modal-content">
                <div class="modal-header">Nouveau cours</div>
                <div class="input-group">
                    <label for="folderCategorySelect">Catégorie :</label>
                    <select id="folderCategorySelect"></select>
                </div>
                <div class="input-group">
                    <label for="folderNameInput">Nom du cours :</label>
                    <input type="text" id="folderNameInput" placeholder="Ex: Droit Administratif">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeNewFolderModal()">Annuler</button>
                    <button class="btn-add" onclick="createFolder()">Créer</button>
                </div>
            </div>
        </div>

        <!-- Modal Nouvelle Liste -->
        <div class="modal" id="newListModal">
            <div class="modal-content">
                <div class="modal-header">Nouvelle liste</div>
                <div class="input-group">
                    <label for="listNameInput">Nom de la liste :</label>
                    <input type="text" id="listNameInput" placeholder="Ex: Chapitre 1">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeNewListModal()">Annuler</button>
                    <button class="btn-add" onclick="createList()">Créer</button>
                </div>
            </div>
        </div>

        <!-- Modal Renommer Catégorie -->
        <div class="modal" id="renameCategoryModal">
            <div class="modal-content">
                <div class="modal-header">Renommer la catégorie</div>
                <div class="input-group">
                    <label for="renameCategoryInput">Nouveau nom :</label>
                    <input type="text" id="renameCategoryInput" placeholder="Nouveau nom">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeRenameCategoryModal()">Annuler</button>
                    <button class="btn-add" onclick="renameCategory()">Renommer</button>
                </div>
            </div>
        </div>

        <!-- Modal Renommer Cours -->
        <div class="modal" id="renameFolderModal">
            <div class="modal-content">
                <div class="modal-header">Renommer le cours</div>
                <div class="input-group">
                    <label for="renameFolderInput">Nouveau nom :</label>
                    <input type="text" id="renameFolderInput" placeholder="Nouveau nom du cours">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeRenameFolderModal()">Annuler</button>
                    <button class="btn-add" onclick="renameFolder()">Renommer</button>
                </div>
            </div>
        </div>

        <!-- Modal Renommer Liste -->
        <div class="modal" id="renameListModal">
            <div class="modal-content">
                <div class="modal-header">Renommer la liste</div>
                <div class="input-group">
                    <label for="renameListInput">Nouveau nom :</label>
                    <input type="text" id="renameListInput" placeholder="Nouveau nom de la liste">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeRenameListModal()">Annuler</button>
                    <button class="btn-add" onclick="renameList()">Renommer</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE THÈME -->
        <div class="modal" id="themeModal">
            <div class="modal-content">
                <div class="modal-header">🎨 Personnaliser le thème</div>

                <div class="theme-section">
                    <div class="theme-section-title">📱 Pré-réglages rapides</div>
                    <div class="presets-grid" id="themePresets"></div>
                </div>

                <div class="theme-section">
                    <div class="theme-section-title">🎨 Couleurs principales</div>
                    <div class="theme-grid" id="primaryColors"></div>
                </div>

                <div class="theme-section">
                    <div class="theme-section-title">📝 Interface et texte</div>
                    <div class="theme-grid" id="interfaceColors"></div>
                </div>

                <div class="theme-section">
                    <div class="theme-section-title">📊 Couleurs de progression</div>
                    <div class="theme-grid" id="progressColors"></div>
                </div>

                <div class="live-preview">
                    <h4>👁️ Aperçu en direct</h4>
                    <div class="preview-elements">
                        <div class="preview-element" style="background: var(--primary); color: white;">Primaire</div>
                        <div class="preview-element" style="background: var(--accent); color: white;">Accent</div>
                        <div class="preview-element" style="background: var(--panel); color: var(--text); border: 1px solid var(--border);">Panneau</div>
                        <div class="preview-element" style="background: var(--known); color: white;">Connu</div>
                        <div class="preview-element" style="background: var(--partial); color: white;">Partiel</div>
                        <div class="preview-element" style="background: var(--unknown); color: white;">Inconnu</div>
                    </div>
                </div>

                <div class="theme-actions">
                    <button class="theme-btn theme-btn-primary" onclick="saveTheme()">
                        💾 Enregistrer
                    </button>
                    <button class="theme-btn theme-btn-secondary" onclick="closeThemeModal()">
                        ✕ Fermer
                    </button>
                    <button class="theme-btn theme-btn-danger" onclick="resetTheme()">
                        🔄 Réinitialiser
                    </button>
                    <button class="theme-btn theme-btn-success" onclick="exportTheme()">
                        📤 Exporter
                    </button>
                    <label class="theme-btn theme-btn-secondary" style="cursor: pointer;">
                        📥 Importer
                        <input type="file" id="themeImportInput" accept="application/json" style="display: none;">
                    </label>
                </div>
            </div>
        </div>

        <!-- MODAL COMPARATEUR -->
        <div id="comparatorModal">
            <div class="comparator-container">
                <div class="comparator-header" style="padding:10px 20px;">
                    <button class="btn-close-comparator" onclick="closeComparator()">✕ Fermer</button>
                </div>
                <div class="comparator-main">
                    <div class="comparator-section">
                        <div class="comp-panel">
                            <h2>Texte récent annoté</h2>
                            <div id="diffOutput"></div>
                        </div>
                    </div>
                    <button id="backToSelected" title="Aller à la carte sélectionnée">⬅ Aller à la sélection</button>
                </div>
                <div class="comp-controls">
                    <div>
                        <label for="oldText">Texte ancien</label>
                        <textarea id="oldText" placeholder="Colle ici l'ancienne version…"></textarea>
                    </div>
                    <div>
                        <label for="newText">Texte récent</label>
                        <textarea id="newText" placeholder="Colle ici la nouvelle version…"></textarea>
                    </div>
                    <div class="comp-split">
                        <button id="compareBtn">Comparer</button>
                        <button id="copyBtn" class="secondary">Copier le résultat</button>
                    </div>
                </div>
                <div class="comparator-aside">
                    <div class="comp-summary">
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
                            <code class="badge">Insertions: <span id="insCount">0</span></code>
                            <code class="badge">Suppressions: <span id="delCount">0</span></code>
                            <code class="badge">Remplacements: <span id="repCount">0</span></code>
                        </div>
                        <small id="hint">Colle tes textes puis clique sur « Comparer ».</small>
                    </div>
                    <div class="comp-toolbar">
                        <strong>Changements</strong>
                        <span style="flex:1"></span>
                        <button id="toggleOnlyDeletions" class="btn-filter-del">➖ Suppressions uniquement</button>
                        <button id="toggleContext" class="secondary">± Contexte</button>
                    </div>
                    <div id="changesList" class="comp-changes"></div>
                </div>
            </div>
        </div>

        <!-- MODAL IMPORT TEXTE -->
        <div class="modal" id="importTextModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">Importer depuis Texte / Quizlet</div>

                <div class="input-group">
                    <label>1. Destination :</label>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <select id="importCatSelect" onchange="updateImportFolderSelect()" style="flex:1"></select>
                        <select id="importFolderSelect" style="flex:1"></select>
                    </div>
                    <input type="text" id="importListName" placeholder="Nom de la liste (ex: Chapitre 1)">
                </div>
                <div class="input-group">
                    <label>2. Séparateur entre Question et Réponse :</label>
                    <select id="importSeparator">
                        <option value="tab">Tabulation (Quizlet par défaut)</option>
                        <option value=",">Virgule (,)</option>
                        <option value=";">Point-virgule (;)</option>
                        <option value=":">Deux-points (:)</option>
                        <option value="-">Tiret (-)</option>
                        <option value="|">Barre verticale (|)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>3. Collez votre texte ici :</label>
                    <textarea id="importTextContent" style="width:100%; height:200px; padding:10px; border:2px solid var(--border); border-radius:8px; font-family:monospace; resize:vertical;" placeholder="Terme 1 Définition 1&#10;Terme 2 Définition 2"></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeImportTextModal()">Annuler</button>
                    <button class="btn-add" onclick="performTextImport()">Importer les cartes</button>
                </div>
            </div>
        </div>

        <!-- MODAL PROFIL UTILISATEUR -->
        <div class="modal" id="userProfileModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header" style="display: flex; align-items: center; gap: 15px;">
                    <div class="user-avatar" id="profileAvatar">U</div>
                    <div>
                        <h2 id="profileUsername" style="margin: 0;">Utilisateur</h2>
                        <p id="profileInfo" style="margin: 0; color: var(--text-soft); font-size: 14px;">Membre</p>
                    </div>
                </div>

                <div style="margin: 20px 0;">
                    <h3>Cours publics</h3>
                    <div id="profileCoursesList" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
                </div>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeUserProfileModal()">Fermer</button>
                    <button class="btn-add" onclick="importFromUser()">Importer la sélection</button>
                </div>
            </div>
        </div>

        <!-- MODAL PARAMÈTRES PROFIL -->
        <div class="modal profile-settings-modal" id="profileSettingsModal">
            <div class="modal-content">
                <div class="modal-header">👤 Paramètres du profil</div>

                <div class="avatar-upload">
                    <div class="avatar-preview" id="avatarPreview" onclick="document.getElementById('avatarInput').click()">
                        <!-- L'image sera ajoutée dynamiquement -->
                    </div>
                    <p style="font-size: 12px; color: var(--text-soft); margin-top: 5px;">Cliquez pour changer la photo</p>
                </div>

                <div class="profile-form">
                    <div class="input-group">
                        <label for="settingsUsername">Nom d'utilisateur</label>
                        <input type="text" id="settingsUsername" placeholder="Votre nom d'utilisateur">
                    </div>

                    <div class="input-group">
                        <label for="settingsEmail">Email</label>
                        <input type="email" id="settingsEmail" placeholder="votre@email.com">
                    </div>

                    <div class="input-group">
                        <label for="settingsBio">Bio (optionnel)</label>
                        <textarea id="settingsBio" placeholder="Parlez un peu de vous..." rows="3"></textarea>
                    </div>

                    <div class="input-group">
                        <label for="settingsCurrentPassword">Mot de passe actuel (pour modifier)</label>
                        <input type="password" id="settingsCurrentPassword" placeholder="Entrez votre mot de passe actuel">
                    </div>

                    <div class="input-group">
                        <label for="settingsNewPassword">Nouveau mot de passe</label>
                        <input type="password" id="settingsNewPassword" placeholder="Laissez vide pour ne pas changer">
                    </div>

                    <div class="input-group">
                        <label for="settingsConfirmPassword">Confirmer le nouveau mot de passe</label>
                        <input type="password" id="settingsConfirmPassword" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>

                <div class="profile-actions">
                    <button class="btn-add" onclick="saveProfileSettings()">💾 Enregistrer</button>
                    <button class="btn-cancel" onclick="closeProfileSettings()">Annuler</button>
                </div>

                <div class="danger-zone">
                    <h4>⚠️ Zone dangereuse</h4>
                    <p style="font-size: 12px; color: var(--text-soft); margin-bottom: 15px;">
                        Ces actions sont irréversibles. Soyez certain de ce que vous faites.
                    </p>
                    <button class="btn-danger" onclick="deleteAccount()" style="width: 100%;">
                        🗑️ Supprimer mon compte
                    </button>
                </div>
            </div>
        </div>

        <!-- Mode plein écran pour les fiches -->
        <div id="fullscreenMode" class="fullscreen-mode">
            <button class="fullscreen-close-btn" onclick="event.stopPropagation(); closeFullscreenOverlay()">✕</button>
			<button id="btnPrevFullscreen" type="button" onclick="goToPreviousCardUndo()" title="Fiche précédente">⟵</button>
            <div class="fullscreen-card-container" id="fullscreenCardContainer">
                <div class="fullscreen-card" id="fullscreenCard" onclick="flipFullscreenCard()">
                    <div class="fullscreen-card-face fullscreen-card-front">
  						<div class="card-importance-header" id="fullscreenImportanceBadge"></div>
  						<div class="fullscreen-card-text" id="fullscreenQuestion"></div>
					</div>
                    <div class="fullscreen-card-face fullscreen-card-back">
                        <div class="fullscreen-card-text" id="fullscreenAnswer"></div>
                    </div>
                </div>
            </div>
            <div class="fullscreen-controls">
                <button class="fullscreen-btn" style="background: linear-gradient(135deg, var(--known) 0%, var(--accent-2) 100%);" onclick="fullscreenAnswer('known')">✓ Connu</button>
                <button class="fullscreen-btn" style="background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%);" onclick="fullscreenAnswer('partial')">~ Partiel</button>
                <button class="fullscreen-btn" style="background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%);" onclick="fullscreenAnswer('unknown')">✗ Inconnu</button>
            </div>
        </div>
    </div>
		<button id="btnGoLastCard" class="floating-last-card" onclick="goToLastCard(true)" title="Dernière fiche">
		⬇️
		</button>
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <script>
        // ====== VARIABLES GLOBALES ======
        let currentUser = null;
        let allUsers = {};
        let categories = {};
        let results = {};
        let openCategories = {};
        let currentCategory = null;
        let currentFolder = null;
        let currentList = null;
        let currentPage = 'home';
        let currentIndex = 0;
        let isFlipped = false;
        let isReviewMode = false;
        let reviewIndices = [];
        let stats = {known: 0, partial: 0, unknown: 0};
        let currentEditingSide = null;
        let renameTarget = null;
		let studyIndices = [];
		let editMode = false;
		let editTargetIndex = null;
		let importanceFilter = ['important','normal','pas important','explication'];
		let activeInlineEditIndex = null;
		let draggedCardIndex = null;
		let lastSelectedHistoryEl = null;
		let activeInlineSide = 'question';
        window.activeImportanceFilter = [];
        window.currentImportance = 'normal';
		window.lastSelectedHistoryEl = null;
		window.lastSelectedDiffEl = null;

        const GIF_KNOWN_URL = 'https://www.gif-vif.com/trending/cursed-mario-cursed';

		let savedRange = null;

		// Sauvegarde seulement si sélection dans un editor
		function saveSelection() {
			const sel = window.getSelection();
			if (!sel || sel.rangeCount === 0) return;

			const range = sel.getRangeAt(0);
			let node = range.commonAncestorContainer;
			if (node && node.nodeType === 3) node = node.parentNode; // texte -> element
			if (!node || !node.closest || !node.closest('.editor-content')) return;

			savedRange = range.cloneRange();
		}

		function restoreSelection() {
			if (!savedRange) return false;
			const sel = window.getSelection();
			sel.removeAllRanges();
			sel.addRange(savedRange);
			return true;
		}

		// Track du "côté" actif (création + édition inline)
		document.addEventListener('focusin', (e) => {
			const t = e.target;
			if (!t || !t.id) return;

			if (t.id === 'newQuestion') { activeInlineEditIndex = null; activeInlineSide = 'question'; }
			if (t.id === 'newAnswer')   { activeInlineEditIndex = null; activeInlineSide = 'answer'; }

			if (t.id.startsWith('editQuestion')) activeInlineSide = 'question';
			if (t.id.startsWith('editAnswer'))   activeInlineSide = 'answer';
		});

		document.addEventListener('mouseup', saveSelection);
		document.addEventListener('keyup', saveSelection);
		document.addEventListener('keydown', (e) => {
			const editor = e.target?.closest?.('.editor-content');
			if (!editor) return;

	// Laisse les raccourcis clavier tranquilles
			if (e.ctrlKey || e.metaKey || e.altKey) return;

			if (e.key === 'Enter') {
				e.preventDefault();

		// 1) le plus fiable pour un <br>
				const ok = document.execCommand('insertLineBreak');

		// 2) fallback si insertLineBreak ne marche pas
				if (!ok) document.execCommand('insertHTML', false, '<br>');
			}
		}, true);

		function applyColorToSelection(cmd, color) {
			// 1) Focus sur le bon éditeur
			if (activeInlineEditIndex !== null && activeInlineEditIndex !== undefined) {
				setActiveInlineEditor(activeInlineEditIndex, activeInlineSide);
			} else {
				const el = document.getElementById(activeInlineSide === 'answer' ? 'newAnswer' : 'newQuestion');
				if (el) el.focus();
			}

			// 2) Restore + apply
			if (!restoreSelection()) return;
			document.execCommand(cmd, false, color);

			// 3) resave
			saveSelection();
		}

        // ====== FONCTIONS D'AUTHENTIFICATION ======
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showAuthError('Veuillez remplir tous les champs');
                return;
            }

            loadUsers();

            if (!allUsers[username]) {
                showAuthError('Utilisateur non trouvé');
                return;
            }

            if (allUsers[username].password !== password) {
                showAuthError('Mot de passe incorrect');
                return;
            }

            currentUser = {
                username: username,
                ...allUsers[username]
            };

            localStorage.setItem('current_user', JSON.stringify(currentUser));
            showApp();
			initApp();
            showNotification('Connexion réussie !', 'success');
        }

        function loginAsGuest() {
            const guestId = 'guest_' + Date.now();
            currentUser = {
                username: guestId,
                guest: true,
                createdAt: new Date().toISOString(),
                folders: {
                    '📚 Exemples': {
                        'Droit Administratif': {
                            'Chapitre 1': [
                                {question: "Qu'est-ce que le principe de légalité ?", answer: "Le principe selon lequel l'administration doit agir conformément aux règles de droit.", importance: 'important'},
                                {question: "Qu'est-ce que la théorie du service public ?", answer: "Une théorie développée par Léon Duguit selon laquelle l'État doit assurer certains services essentiels à la population.", importance: 'normal'}
                            ]
                        }
                    }
                }
            };

            allUsers[guestId] = currentUser;
            localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
            localStorage.setItem('current_user', JSON.stringify(currentUser));

            showApp();
			initApp();
            showNotification('Connecté en tant qu\'invité', 'success');
			
        }

		function setActiveInlineEditor(i, side) {
			activeInlineEditIndex = i;
			activeInlineSide = side;
			const el = document.getElementById(side === 'answer' ? `editAnswer${i}` : `editQuestion${i}`);
			if (el) el.focus();
		}

		function syncInlineImportance(i) {
			const sel = document.getElementById(`inlineImportance${i}`);
			const original = document.getElementById(`editImportance${i}`);
			if (sel && original) original.value = sel.value;
		}

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();

            if (!username || !password) {
                showAuthError('Nom d\'utilisateur et mot de passe requis');
                return;
            }

            if (password !== confirmPassword) {
                showAuthError('Les mots de passe ne correspondent pas');
                return;
            }

            if (username.length < 3) {
                showAuthError('Le nom d\'utilisateur doit faire au moins 3 caractères');
                return;
            }

            loadUsers();

            if (allUsers[username]) {
                showAuthError('Ce nom d\'utilisateur est déjà pris');
                return;
            }

            allUsers[username] = {
                password: password,
                email: email || '',
                createdAt: new Date().toISOString(),
                publicProfile: true,
                folders: {}
            };

            localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
            currentUser = {
                username: username,
                ...allUsers[username]
            };

            localStorage.setItem('current_user', JSON.stringify(currentUser));
            showApp();
			initApp()
            showNotification('Compte créé avec succès !', 'success');
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            } else {
                alert(message);
            }
        }

        function showAuthSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }
        }

        function loadUsers() {
            const usersData = localStorage.getItem('flashcards_users');
            if (usersData) {
                try {
                    allUsers = JSON.parse(usersData);
                } catch (e) {
                    allUsers = {};
                }
            } else {
                allUsers = {};
            }

            if (!allUsers['admin']) {
                allUsers['admin'] = {
                    password: 'admin123',
                    email: 'admin@example.com',
                    createdAt: new Date().toISOString(),
                    publicProfile: true,
                    folders: {
                        '📚 Exemples': {
                            'Droit Administratif': {
                                'Chapitre 1': [
                                    {question: "Qu'est-ce que le principe de légalité ?", answer: "Le principe selon lequel l'administration doit agir conformément aux règles de droit.", importance: 'important'},
                                    {question: "Qu'est-ce que la théorie du service public ?", answer: "Une théorie développée par Léon Duguit selon laquelle l'État doit assurer certains services essentiels à la population.", importance: 'normal'}
                                ]
                            }
                        }
                    }
                };
                localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
            }
        }

        function showApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('appContent').style.display = 'flex';
			
            loadUserData();
			initApp();
			loadTheme();
			refreshUserUI();
        }

        function loadUserData() {
				allUsers = JSON.parse(localStorage.getItem('flashcards_users') || '{}');
				currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');

				if (!currentUser) return;

			// IMPORTANT : recharger categories depuis le user
				categories = currentUser.folders || {};
			}
            const savedUser = localStorage.getItem('current_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);

                    const userNameElement = document.getElementById('userName');
                    if (userNameElement && currentUser.username) {
                        userNameElement.textContent = currentUser.username;
                    }

                    const userStatusElement = document.getElementById('userStatus');
                    if (userStatusElement) {
                        userStatusElement.textContent = currentUser.guest ? 'Invité' : 'Membre';
                    }

                    const avatarDiv = document.getElementById('userAvatar');
                    if (avatarDiv) {
                        if (currentUser.avatar) {
                            avatarDiv.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
                        } else {
                            avatarDiv.innerHTML = currentUser.username.charAt(0).toUpperCase();
                        }
                    }

                    initApp();

                } catch (e) {
                    console.error('Erreur lors du chargement des données utilisateur:', e);
       		}
		}
		
		function loadTheme() {
			if (!currentUser) return;

			const raw = localStorage.getItem(`flashcards_theme_${currentUser.username}`);
			if (!raw) return;

			try {
				const theme = JSON.parse(raw);
				if (!theme || typeof theme !== 'object') return;

				Object.entries(theme).forEach(([key, val]) => {
					document.documentElement.style.setProperty(key, val);
				});
			} catch (e) {
				console.error('Theme load error', e);
			}
		}

        function initApp() {
            loadData();
            updateCategoryList();
            updateHomeStats();
            loadTheme();
            showPage('home');
        }

        function checkAuth() {
            loadUserData();
			updateCategoryList();
			updateHomeStats();
            const savedUser = localStorage.getItem('current_user');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    if (allUsers[user.username]) {
                        currentUser = user;
                        showApp();
                        return;
                    }
                } catch (e) {}
            }

            document.getElementById('authPage').style.display = 'flex';
        }

		function refreshUserUI() {
			if (!currentUser) return;

			const userNameElement = document.getElementById('userName');
			if (userNameElement && currentUser.username) {
				userNameElement.textContent = currentUser.username;
			}

			const userStatusElement = document.getElementById('userStatus');
			if (userStatusElement) {
				userStatusElement.textContent = currentUser.guest ? 'Invité' : 'Membre';
			}

			const avatarDiv = document.getElementById('userAvatar');
			if (avatarDiv) {
				if (currentUser.avatar) {
					avatarDiv.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
				} else {
					avatarDiv.textContent = (currentUser.username || '?').charAt(0).toUpperCase();
				}
			}
		}

        // ====== NOTIFICATIONS ======
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.error('Element notification non trouvé');
                return;
            }

            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ====== FONCTIONS DE GESTION DES DONNÉES ======
        function loadData() {
            if (currentUser && currentUser.folders) {
                categories = currentUser.folders;
            } else {
                categories = {};
            }

            const userResultsKey = `flashcards_results_${currentUser.username}`;
            const resData = localStorage.getItem(userResultsKey);
            if (resData) {
                try {
                    results = JSON.parse(resData);
                } catch (e) {
                    results = {};
                }
            }

            const openData = localStorage.getItem(`flashcards_open_${currentUser.username}`);
            if (openData) {
                try {
                    openCategories = JSON.parse(openData);
                } catch (e) {
                    openCategories = {};
                }
            }

            if (Object.keys(categories).length === 0 && !currentUser.guest) {
                categories = {
                    '📚 Mes cours': {
                        'Droit Administratif': {
                            'Chapitre 1': [
                                {question: "Qu'est-ce que le principe de légalité ?", answer: "Le principe selon lequel l'administration doit agir conformément aux règles de droit.", importance: 'important'},
                                {question: "Qu'est-ce que la théorie du service public ?", answer: "Une théorie développée par Léon Duguit selon laquelle l'État doit assurer certains services essentiels à la population.", importance: 'normal'}
                            ]
                        }
                    }
                };
                openCategories['📚 Mes cours'] = true;
                currentUser.folders = categories;
                allUsers[currentUser.username] = currentUser;
                localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
            }
        }

        function saveData() {
            if (currentUser) {
                currentUser.folders = categories;
                allUsers[currentUser.username] = currentUser;
				localStorage.setItem('current_user', JSON.stringify(currentUser));
                localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
                localStorage.setItem(`flashcards_open_${currentUser.username}`, JSON.stringify(openCategories));
            }

            updateHomeStats();
        }

        function saveResults() {
            if (currentUser) {
                const userResultsKey = `flashcards_results_${currentUser.username}`;
                localStorage.setItem(userResultsKey, JSON.stringify(results));
            }
        }

        // ====== FONCTIONS DE GESTION DE L'APPLICATION ======
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleBtn = document.getElementById('toggleSidebarBtn');

            sidebar.classList.toggle('hidden');
            mainContent.classList.toggle('sidebar-hidden');
            toggleBtn.classList.toggle('sidebar-hidden');
        }

        function showPage(pageName) {
			// pageName: "home", "lists", "category", "manage", ...
			const pageId = pageName.endsWith('Page') ? pageName : (pageName + 'Page');
			const target = document.getElementById(pageId);

			document.querySelectorAll('.page').forEach(p => {
				p.classList.remove('active');
				p.style.display = 'none';
			});

			if (!target) {
				console.error("Page introuvable:", pageId);
				return;
			}

			target.classList.add('active');
			target.style.display = 'block';

			const b = document.getElementById('btnGoLastCard');
			if (b) b.style.display = (pageName === 'manage') ? 'flex' : 'none';
		}

		function setActiveInlineSide(side) {
			activeInlineSide = side; // 'question' ou 'answer'
		}

		function insertBulletNow() {
			// Réutilise ton système déjà présent (activeInlineSide / activeInlineEditIndex)
			let el = null;

			if (activeInlineEditIndex !== null && activeInlineEditIndex !== undefined) {
				el = document.getElementById(activeInlineSide === 'answer'
					? `editAnswer${activeInlineEditIndex}`
					: `editQuestion${activeInlineEditIndex}`);
			} else {
				el = document.getElementById(activeInlineSide === 'answer' ? 'newAnswer' : 'newQuestion');
			}

			if (!el) return;
			el.focus();

			// Insère une puce + espace à la position du curseur
			document.execCommand('insertText', false, '• ');
		}

		let answerHistory = [];

		function goToPreviousCardUndo() {
			resetFlipNoFlash();
			forceQuestionSide();
			if (currentIndex <= 0 || answerHistory.length === 0) return;

			const last = answerHistory.pop();

			// restaurer le statut précédent en localStorage/results si tu enregistres les réponses
			const key = `flashcards_results_${currentUser.username}`;
			const resultsRoot = JSON.parse(localStorage.getItem(key) || '{}');

			const listResults = resultsRoot?.[currentCategory]?.[currentFolder]?.[currentList];
			if (listResults) {
				if (last.prev === null) delete listResults[String(last.cardIndex)];
				else listResults[String(last.cardIndex)] = last.prev;

				localStorage.setItem(key, JSON.stringify(resultsRoot));
			}

			currentIndex--;
			forceQuestionSide();
			resetFlipState();
			showCard();

			// ✅ si le plein écran est ouvert, rafraîchir aussi l’overlay
			const fs = document.getElementById('fullscreenMode');
			if (fs && fs.classList.contains('active')) {
				updateFullscreenCard(); // à créer (voir ci-dessous)
			}
		}

		function resetFlipNoFlash() {
			const card = document.getElementById('flashcard');
			const fsCard = document.getElementById('fullscreenCard');

			if (card) {
				card.classList.add('no-flip-anim');
				card.classList.remove('flipped');
			}
			if (fsCard) {
				fsCard.classList.add('no-flip-anim');
				fsCard.classList.remove('flipped');
			}

	// force un repaint, puis on réactive l’animation
			requestAnimationFrame(() => {
				if (card) card.classList.remove('no-flip-anim');
				if (fsCard) fsCard.classList.remove('no-flip-anim');
			});

			isFlipped = false;
		}

		function copyComparatorResult() {
			const out = document.getElementById('diffOutput');
			const text = out ? out.innerText : '';

			if (!text.trim()) return;

			navigator.clipboard.writeText(text)
				.then(() => console.log('Résultat copié'))
				.catch(err => console.error('Clipboard error:', err));
		}

		function forceQuestionSide() {
			isFlipped = false;

			const card = document.getElementById('flashcard');
			if (card) card.classList.remove('flipped');

			const fsCard = document.getElementById('fullscreenCard');
			if (fsCard) fsCard.classList.remove('flipped');
		}

		function updateFullscreenCard() {
			// Reprend le contenu déjà affiché par showCard()
			const q = document.getElementById('question')?.innerHTML || '';
			const a = document.getElementById('answer')?.innerHTML || '';
			const badge = document.getElementById('importanceBadge')?.className || '';

			const fq = document.getElementById('fullscreenQuestion');
			const fa = document.getElementById('fullscreenAnswer');
			const fb = document.getElementById('fullscreenImportanceBadge');

			if (fq) fq.innerHTML = q;
			if (fa) fa.innerHTML = a;
			if (fb) fb.className = document.getElementById('importanceBadge')?.className || 'card-importance-header';
		}
        // ====== FONCTIONS DE GESTION DES CATÉGORIES ET DOSSIERS ======
        function toggleCategory(catName) {
            openCategories[catName] = !openCategories[catName];
            localStorage.setItem(`flashcards_open_${currentUser.username}`, JSON.stringify(openCategories));
            updateCategoryList();
        }

        function showNewCategoryModal() {
            document.getElementById('newCategoryModal').classList.add('show');
            const input = document.getElementById('categoryNameInput');
            input.value = '';
            setTimeout(() => input.focus(), 150);
        }

        function closeNewCategoryModal() {
            document.getElementById('newCategoryModal').classList.remove('show');
            document.getElementById('categoryNameInput').value = '';
        }

        function createCategory() {
            const input = document.getElementById('categoryNameInput');
            const name = input.value.trim();
            if (!name) {
                showNotification('Veuillez entrer un nom.', 'error');
                setTimeout(() => input.focus(), 150);
                return;
            }
            if (categories[name]) {
                showNotification('Cette catégorie existe déjà.', 'error');
                input.value = '';
                setTimeout(() => input.focus(), 150);
                return;
            }
            categories[name] = {};
            openCategories[name] = true;
            saveData();
            updateCategoryList();
            closeNewCategoryModal();
            showNotification('Catégorie créée avec succès ✓', 'success');
        }

        function deleteCategory(catName) {
            if (!confirm('Supprimer "' + catName + '" et tous ses cours ?')) return;
            delete categories[catName];
            delete results[catName];
            delete openCategories[catName];
            saveData();
            saveResults();
            if (currentCategory === catName) showPage('home');
            updateCategoryList();
            showNotification('Catégorie supprimée ✓', 'success');
        }

        function showEditCategoryModal(catName) {
            renameTarget = catName;
            document.getElementById('renameCategoryModal').classList.add('show');
            const input = document.getElementById('renameCategoryInput');
            input.value = catName;
            setTimeout(() => input.focus(), 150);
        }

        function closeRenameCategoryModal() {
            document.getElementById('renameCategoryModal').classList.remove('show');
            document.getElementById('renameCategoryInput').value = '';
            renameTarget = null;
        }

        function renameCategory() {
            const input = document.getElementById('renameCategoryInput');
            const newName = input.value.trim();
            if (!newName) {
                showNotification('Veuillez entrer un nom.', 'error');
                setTimeout(() => input.focus(), 150);
                return;
            }
            if (categories[newName] && newName !== renameTarget) {
                showNotification('Ce nom existe déjà.', 'error');
                input.value = '';
                setTimeout(() => input.focus(), 150);
                return;
            }
            if (renameTarget && categories[renameTarget]) {
                categories[newName] = categories[renameTarget];
                delete categories[renameTarget];
                if (results[renameTarget]) {
                    results[newName] = results[renameTarget];
                    delete results[renameTarget];
                    saveResults();
                }
                if (openCategories[renameTarget]) {
                    openCategories[newName] = openCategories[renameTarget];
                    delete openCategories[renameTarget];
                }
                if (currentCategory === renameTarget) currentCategory = newName;
                saveData();
                updateCategoryList();
                closeRenameCategoryModal();
                showNotification('Catégorie renommée ✓', 'success');
            }
        }

		function resetFlipState() {
			isFlipped = false;

			const card = document.getElementById('flashcard');
			if (card) card.classList.remove('flipped');

			const fsCard = document.getElementById('fullscreenCard');
			if (fsCard) fsCard.classList.remove('flipped');
		}

        function updateFolderCategorySelect() {
            const select = document.getElementById('folderCategorySelect');
            select.innerHTML = '';
            const catNames = Object.keys(categories);
            if (catNames.length === 0) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Aucune catégorie - Créez-en une !';
                select.appendChild(opt);
            } else {
                catNames.forEach(catName => {
                    const opt = document.createElement('option');
                    opt.value = catName;
                    opt.textContent = catName;
                    if (catName === currentCategory) opt.selected = true;
                    select.appendChild(opt);
                });
            }
        }

        function showNewFolderModal() {
            updateFolderCategorySelect();
            document.getElementById('newFolderModal').classList.add('show');
            const input = document.getElementById('folderNameInput');
            input.value = '';
            setTimeout(() => input.focus(), 150);
        }

        function closeNewFolderModal() {
            document.getElementById('newFolderModal').classList.remove('show');
            document.getElementById('folderNameInput').value = '';
        }

        function createFolder() {
            const input = document.getElementById('folderNameInput');
            const name = input.value.trim();
            const catSelect = document.getElementById('folderCategorySelect');
            const selectedCat = catSelect.value;
            if (!selectedCat) {
                showNotification('Veuillez créer une catégorie d\'abord.', 'error');
                return;
            }
            if (!name) {
                showNotification('Veuillez entrer un nom de cours.', 'error');
                setTimeout(() => input.focus(), 150);
                return;
            }
            if (categories[selectedCat][name]) {
                showNotification('Ce cours existe déjà dans cette catégorie.', 'error');
                input.value = '';
                setTimeout(() => input.focus(), 150);
                return;
            }
            categories[selectedCat][name] = {'Liste par défaut': []};
            saveData();
            updateCategoryList();
            closeNewFolderModal();
            showListsPage(selectedCat, name);
            showNotification('Cours créé avec succès ✓', 'success');
        }

        function deleteFolder(catName, folderName) {
            if (!confirm('Supprimer "' + folderName + '" ?')) return;
            delete categories[catName][folderName];
            if (results[catName]) {
                delete results[catName][folderName];
                saveResults();
            }
            if (Object.keys(categories[catName]).length === 0) {
                delete categories[catName];
                delete openCategories[catName];
            }
            saveData();
            if (currentCategory === catName && currentFolder === folderName) showPage('home');
            updateCategoryList();
            showNotification('Cours supprimé ✓', 'success');
        }

        function showEditFolderModal(catName, folderName) {
            renameTarget = {cat: catName, folder: folderName};
            document.getElementById('renameFolderModal').classList.add('show');
            const input = document.getElementById('renameFolderInput');
            input.value = folderName;
            setTimeout(() => input.focus(), 150);
        }

        function closeRenameFolderModal() {
            document.getElementById('renameFolderModal').classList.remove('show');
            document.getElementById('renameFolderInput').value = '';
            renameTarget = null;
        }

        function showRenameFolderModal() {
            if (!currentCategory || !currentFolder) return;
            showEditFolderModal(currentCategory, currentFolder);
        }

        function renameFolder() {
            const input = document.getElementById('renameFolderInput');
            const newName = input.value.trim();
            if (!newName) {
                showNotification('Veuillez entrer un nom.', 'error');
                setTimeout(() => input.focus(), 150);
                return;
            }
            const catName = renameTarget.cat;
            const oldName = renameTarget.folder;
            if (categories[catName][newName] && newName !== oldName) {
                showNotification('Ce nom existe déjà.', 'error');
                input.value = '';
                setTimeout(() => input.focus(), 150);
                return;
            }
            if (categories[catName][oldName]) {
                categories[catName][newName] = categories[catName][oldName];
                delete categories[catName][oldName];
                if (results[catName] && results[catName][oldName]) {
                    results[catName][newName] = results[catName][oldName];
                    delete results[catName][oldName];
                    saveResults();
                }
                if (currentCategory === catName && currentFolder === oldName) currentFolder = newName;
                saveData();
                updateCategoryList();
                if (currentPage === 'lists') {
                    document.getElementById('listsTitle').textContent = newName;
                }
                closeRenameFolderModal();
                showNotification('Cours renommée ✓', 'success');
            }
        }

		function applySavedColor(cmd, pickerId) {
			const picker = document.getElementById(pickerId);
			if (!picker) return;

			// Remet le focus dans l’éditeur actif (indispensable)
			if (activeInlineEditIndex !== null && activeInlineEditIndex !== undefined) {
				setActiveInlineEditor(activeInlineEditIndex, activeInlineSide);
			} else {
				const el = document.getElementById(activeInlineSide === 'answer' ? 'newAnswer' : 'newQuestion');
				if (el) el.focus();
			}

			// Restore sélection + applique
			if (!restoreSelection()) return;
			document.execCommand(cmd, false, picker.value);
			saveSelection();
		}

        function showNewListModal() {
            if (!currentCategory || !currentFolder) {
                showNotification('Erreur : aucun cours sélectionné.', 'error');
                return;
            }
            document.getElementById('newListModal').classList.add('show');
            const input = document.getElementById('listNameInput');
            input.value = '';
            setTimeout(() => input.focus(), 150);
        }

        function closeNewListModal() {
            document.getElementById('newListModal').classList.remove('show');
            document.getElementById('listNameInput').value = '';
        }

        function createList() {
            const input = document.getElementById('listNameInput');
            const name = input.value.trim();
            if (!name) {
                showNotification('Veuillez entrer un nom de liste.', 'error');
                setTimeout(() => input.focus(), 150);
                return;
            }
            if (!currentCategory || !currentFolder || !categories[currentCategory] || !categories[currentCategory][currentFolder]) {
                showNotification('Erreur.', 'error');
                return;
            }
            if (categories[currentCategory][currentFolder][name]) {
                showNotification('Cette liste existe déjà.', 'error');
                input.value = '';
                setTimeout(() => input.focus(), 150);
                return;
            }
            categories[currentCategory][currentFolder][name] = [];
            saveData();
            updateCategoryList();
            closeNewListModal();
            loadListsPage();
            showNotification('Liste créée avec succès ✓', 'success');
        }

        function deleteList(listName) {
            if (!confirm('Supprimer "' + listName + '" ?')) return;
            delete categories[currentCategory][currentFolder][listName];
            if (results[currentCategory] && results[currentCategory][currentFolder]) {
                delete results[currentCategory][currentFolder][listName];
                saveResults();
            }
            if (Object.keys(categories[currentCategory][currentFolder]).length === 0) {
                categories[currentCategory][currentFolder]['Liste par défaut'] = [];
            }
            saveData();
            updateCategoryList();
            loadListsPage();
            showNotification('Liste supprimée ✓', 'success');
        }

        function showEditListModal(listName) {
            renameTarget = listName;
            document.getElementById('renameListModal').classList.add('show');
            const input = document.getElementById('renameListInput');
            input.value = listName;
            setTimeout(() => input.focus(), 150);
        }

		function openCreateCard() {
			editMode = false;
			editTargetIndex = null;

			// vider les champs du même formulaire
			document.getElementById('qInput').value = '';
			document.getElementById('aInput').value = '';
			document.getElementById('importanceSelect').value = 'normal'; // si tu as
			// etc.

			document.getElementById('cardModalTitle').textContent = 'Créer une fiche';
			document.getElementById('btnSaveCard').textContent = 'Créer';
			openCardModal(); // ta fonction existante pour afficher le modal
		}

		function openEditCard(i) {
			// Pré-remplir le modal de création (même UI)
			const cards = categories[currentCategory][currentFolder][currentList];
			const c = cards[i];

			// Ouvre le même modal que “créer”
			showNewCardModal(); // si ton bouton “ajouter fiche” utilise cette fonction

			// IMPORTANT : on force le bouton “Créer/Enregistrer” à faire une MAJ et pas un ajout
			window._editingCardIndex = i;

			// Si tu as un bouton avec onclick="addCard()" ou similaire, on remplace temporairement
			const btn = document.querySelector('.btn-save-card, #saveCardBtn, button[onclick*="addCard"]');
			if (btn) {
				btn.textContent = '💾 Enregistrer';
				btn.onclick = () => saveCardEdit();
			}
		}

		function editCard(i) {
			openEditCard(i);

			// Injection après rerender : on attend que l’élément soit de retour dans le DOM
			const tryInject = () => {
				const cardItem = document.querySelector(`#cardsList .card-edit-item[data-index="${i}"]`);
				if (!cardItem) {
					// pas encore rendu
					requestAnimationFrame(tryInject);
					return;
				}
				showInlineFormatPanel(i);
			};

			requestAnimationFrame(tryInject);
		}

        function closeRenameListModal() {
            document.getElementById('renameListModal').classList.remove('show');
            document.getElementById('renameListInput').value = '';
            renameTarget = null;
        }

        function renameList() {
            const input = document.getElementById('renameListInput');
            const newName = input.value.trim();
            if (!newName) {
                showNotification('Veuillez entrer un nom.', 'error');
                setTimeout(() => input.focus(), 150);
                return;
            }
            if (!currentCategory || !currentFolder || !categories[currentCategory] || !categories[currentCategory][currentFolder]) {
                showNotification('Erreur.', 'error');
                return;
            }
            if (categories[currentCategory][currentFolder][newName] && newName !== renameTarget) {
                showNotification('Ce nom existe déjà.', 'error');
                input.value = '';
                setTimeout(() => input.focus(), 150);
                return;
            }
            if (renameTarget && categories[currentCategory][currentFolder][renameTarget]) {
                categories[currentCategory][currentFolder][newName] = categories[currentCategory][currentFolder][renameTarget];
                delete categories[currentCategory][currentFolder][renameTarget];
                if (results[currentCategory] && results[currentCategory][currentFolder] && results[currentCategory][currentFolder][renameTarget]) {
                    results[currentCategory][currentFolder][newName] = results[currentCategory][currentFolder][renameTarget];
                    delete results[currentCategory][currentFolder][renameTarget];
                    saveResults();
                }
                if (currentList === renameTarget) currentList = newName;
                saveData();
                updateCategoryList();
                loadListsPage();
                closeRenameListModal();
                showNotification('Liste renommée ✓', 'success');
            }
        }

        // ====== FONCTIONS D'AFFICHAGE ======
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function updateCategoryList() {
            const container = document.getElementById('categoryList');
            container.innerHTML = '';
            Object.keys(categories).forEach(catName => {
                const catDiv = document.createElement('div');
                catDiv.className = 'category-item';
                const catHeader = document.createElement('div');
                catHeader.className = 'category-header';
                if (catName === currentCategory && (currentPage === 'lists' || currentPage === 'study' || currentPage === 'manage')) {
                    catHeader.classList.add('active');
                }

                let totalCards = 0;
                Object.values(categories[catName]).forEach(folder => {
                    Object.values(folder).forEach(lists => {
                        totalCards += lists.length;
                    });
                });

                const leftDiv = document.createElement('div');
                leftDiv.className = 'category-left';
                const isOpen = openCategories[catName];
                const toggleSpan = document.createElement('span');
                toggleSpan.className = 'category-toggle' + (isOpen ? ' open' : '');
                toggleSpan.innerHTML = '▶';
                toggleSpan.onclick = function(e) { e.stopPropagation(); toggleCategory(catName); };
                const nameSpan = document.createElement('span');
                nameSpan.className = 'category-name';
                nameSpan.textContent = catName;
                const countSpan = document.createElement('span');
                countSpan.className = 'category-count';
                countSpan.textContent = totalCards;

                leftDiv.appendChild(toggleSpan);
                leftDiv.appendChild(nameSpan);
                leftDiv.appendChild(countSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'category-actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn-edit-category';
                editBtn.innerHTML = '✏️';
                editBtn.onclick = function(e) { e.stopPropagation(); showEditCategoryModal(catName); };
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-category';
                deleteBtn.innerHTML = '✕';
                deleteBtn.onclick = function(e) { e.stopPropagation(); deleteCategory(catName); };
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);

                catHeader.appendChild(leftDiv);
                catHeader.appendChild(actionsDiv);
                catDiv.appendChild(catHeader);

                const foldersDiv = document.createElement('div');
                foldersDiv.className = 'category-folders' + (isOpen ? ' open' : '');

                Object.keys(categories[catName]).forEach(folderName => {
                    let cardCount = 0;
                    Object.values(categories[catName][folderName]).forEach(lists => {
                        cardCount += lists.length;
                    });

                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'folder-item';
                    if (catName === currentCategory && folderName === currentFolder && (currentPage === 'lists' || currentPage === 'study' || currentPage === 'manage')) {
                        folderDiv.classList.add('active');
                    }

                    const folderInfo = document.createElement('div');
                    folderInfo.className = 'folder-info';
                    folderInfo.onclick = function() { showListsPage(catName, folderName); };
                    folderInfo.innerHTML = '<span>📖</span><span style="flex:1">' + escapeHtml(folderName) + '</span><span class="folder-badge">' + cardCount + '</span>';

                    const folderActions = document.createElement('div');
                    folderActions.className = 'folder-actions';
                    const folderEditBtn = document.createElement('button');
                    folderEditBtn.className = 'btn-edit-folder';
                    folderEditBtn.innerHTML = '✏️';
                    folderEditBtn.onclick = function(e) { e.stopPropagation(); showEditFolderModal(catName, folderName); };
                    const folderDeleteBtn = document.createElement('button');
                    folderDeleteBtn.className = 'btn-delete-folder';
                    folderDeleteBtn.innerHTML = '✕';
                    folderDeleteBtn.onclick = function(e) { e.stopPropagation(); deleteFolder(catName, folderName); };
                    folderActions.appendChild(folderEditBtn);
                    folderActions.appendChild(folderDeleteBtn);

                    folderDiv.appendChild(folderInfo);
                    folderDiv.appendChild(folderActions);
                    foldersDiv.appendChild(folderDiv);
                });

                catDiv.appendChild(foldersDiv);
                container.appendChild(catDiv);
            });
        }

        function updateHomeStats() {
            let totalCourses = 0;
            let totalCards = 0;
            Object.values(categories).forEach(cat => {
                Object.values(cat).forEach(folder => {
                    totalCourses++;
                    Object.values(folder).forEach(lists => {
                        totalCards += lists.length;
                    });
                });
            });
            document.getElementById('totalCourses').textContent = totalCourses;
            document.getElementById('totalCards').textContent = totalCards;
			
            const list = document.getElementById('courseList');
			list.innerHTML = '';

			const catNames = Object.keys(categories);
			if (catNames.length === 0) {
				list.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Aucune catégorie créée.</p>';
				return;
			}

			catNames.forEach(catName => {
				const category = categories[catName] || {};

				let courseCount = 0;
				let listCount = 0;
				let cardCount = 0;

				Object.values(category).forEach(folder => {
					courseCount++;
					Object.values(folder).forEach(cards => {
						listCount++;
						cardCount += cards.length;
					});
				});

				const div = document.createElement('div');
				div.className = 'course-card';

				// Au clic : ouvre la catégorie dans la sidebar (sans choisir un cours précis)
				div.onclick = () => {
					showCategoryPage(catName);
				};

				div.innerHTML =
					'<div class="course-card-left">' +
						'<div class="course-card-title">' + escapeHtml(catName) + '</div>' +
						'<div class="course-card-info">' +
						courseCount + ' cours • ' +
						listCount + ' liste' + (listCount > 1 ? 's' : '') + ' • ' +
						cardCount + ' carte' + (cardCount > 1 ? 's' : '') +
					'</div>' +
				'</div>' +
				'<div class="course-card-arrow">→</div>';

			list.appendChild(div);
			});
        }

        function showListsPage(catName, folderName) {
            if (!categories[catName] || !categories[catName][folderName]) {
                showNotification('Cours introuvable', 'error');
                return;
            }
            currentCategory = catName;
            currentFolder = folderName;
            currentPage = 'lists';
            updateCategoryList();

            const title = document.getElementById('listsTitle');
            if (title) {
                title.textContent = folderName;
            }

            loadListsPage();
            showPage('lists');
        }

		function goToLastCard(openEdit = true) {
			if (!currentCategory || !currentFolder || !currentList) return;

			const cards = categories?.[currentCategory]?.[currentFolder]?.[currentList];
			if (!Array.isArray(cards) || cards.length === 0) return;

			const lastIndex = cards.length - 1;

			// important : s'assurer que la page manage est bien rendue avant de chercher l'élément
			setTimeout(() => {
				const el = document.querySelector(`#cardsList .card-edit-item[data-index="${lastIndex}"]`);
				if (el) {
					el.scrollIntoView({ behavior: 'smooth', block: 'center' });
					el.classList.add('flash-focus');
					setTimeout(() => el.classList.remove('flash-focus'), 800);
				}

				if (openEdit) {
					editCard(lastIndex); // ou openEditCard(lastIndex) selon ton flux
				}
			}, 0);
		}

		function sanitizeResultsForList(resultsObj, cardsLength) {
			if (!resultsObj || typeof resultsObj !== 'object') return {};

			// Copie
			const clean = { ...resultsObj };

			// Enlève la clé "undefined"
			delete clean.undefined;

			// Enlève tout index hors plage
			Object.keys(clean).forEach(k => {
				const idx = Number(k);
				if (!Number.isInteger(idx) || idx < 0 || idx >= cardsLength) {
					delete clean[k];
				}
			});

			return clean;
		}

        function loadListsPage() {
            const container = document.getElementById('listsGrid');
            container.innerHTML = '';
            if (!currentCategory || !currentFolder || !categories[currentCategory] || !categories[currentCategory][currentFolder]) return;
            const lists = categories[currentCategory][currentFolder];
            Object.keys(lists)
				.sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }))
				.forEach(listName => {
                const cards = lists[listName];
				const resultsRoot =
					JSON.parse(localStorage.getItem('flashcards_results_Brochy') || '{}');

				const resultsForThisList =
					((((resultsRoot[currentCategory] || {})[currentFolder] || {})[listName]) || {});

				const cleanResults = sanitizeResultsForList(resultsForThisList, cards.length);

				const reviewIndices = cards
					.map((_, i) => i)
					.filter(i => {
						const status = cleanResults[String(i)];
						return status === 'partial' || status === 'unknown';
				});

				console.log('LIST', listName, 'reviewIndices=', reviewIndices, 'cleanResults=', cleanResults);
				
				const reviewCount = reviewIndices.length;

				let progressHTML = '';
				if (reviewCount > 0) {
					progressHTML = `<div class="list-card-progress">🔄 ${reviewCount} à revoir</div>`;
				}
				
                const cardCount = cards.length;

                const card = document.createElement('div');
                card.className = 'list-card';

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'list-card-buttons';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn-edit-list';
                editBtn.innerHTML = '✏️';
                editBtn.onclick = function(e) { e.stopPropagation(); showEditListModal(listName); };
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-list';
                deleteBtn.innerHTML = '✕';
                deleteBtn.onclick = function(e) { e.stopPropagation(); deleteList(listName); };
                buttonsDiv.appendChild(editBtn);
                buttonsDiv.appendChild(deleteBtn);

                card.innerHTML = `
                    <div class="list-card-left">
                        <div class="list-card-title">${escapeHtml(listName)}</div>
                        <div class="list-card-count">${cardCount} carte${cardCount > 1 ? 's' : ''}</div>
                        ${progressHTML}
                    </div>
                    <div class="list-card-actions">
                        <button class="btn-list-action btn-study">📖 Réviser</button>
						<button class="btn-list-action btn-review">🔄 À revoir</button>
                        <button class="btn-list-action btn-manage" onclick="showManagePage('${escapeHtml(currentCategory)}','${escapeHtml(currentFolder)}','${escapeHtml(listName)}')">✏️ Gérer</button>
                    </div>
                `;

				const btnStudy = card.querySelector('.btn-study');
				btnStudy.onclick = (e) => {
					e.stopPropagation();

					// Si rien à revoir, on révise tout (au lieu de bloquer)
					const indicesToStudy = (reviewIndices.length > 0)
						? reviewIndices
						: cards.map((_, i) => i);
				};

				card.querySelector('.btn-study').onclick = (e) => {
					e.stopPropagation();
					isCustomStudyIndices = false;
					showStudyPage(currentCategory, currentFolder, listName);
				};

				// 🔄 À revoir = uniquement partial/unknown
				const btnReview = card.querySelector('.btn-review');

				btnReview.onclick = (e) => {
					e.stopPropagation();
					if (reviewIndices.length === 0) return;
					startReviewFromIndices(currentCategory, currentFolder, listName, reviewIndices);
				};

				if (reviewIndices.length === 0) {
					btnReview.disabled = true;
					btnReview.style.opacity = '0.5';
					btnReview.style.cursor = 'not-allowed';
				}

// désactive si rien à revoir
				if (reviewIndices.length === 0) {
					btnReview.disabled = true;
					btnReview.style.opacity = '0.5';
					btnReview.style.cursor = 'not-allowed';
				}
                card.appendChild(buttonsDiv);
                container.appendChild(card);
        	});
        }
		
		function showCategoryPage(catName) {
			if (!categories[catName]) {
				showNotification("Catégorie introuvable", "error");
				return;
			}

		currentCategory = catName;
		currentPage = 'category';

		const title = document.getElementById('categoryTitle');
		if (title) title.textContent = catName;

		renderCategoryCourses(catName);
		showPage('category'); // doit correspondre à ton système existant
	}

	function renderCategoryCourses(catName) {
		const container = document.getElementById('categoryCoursesList');
		if (!container) return;

		container.innerHTML = '';

		const category = categories[catName] || {};
		const courseNames = Object.keys(category);

		if (courseNames.length === 0) {
			container.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Aucun cours dans cette catégorie.</p>';
			return;
		}

		courseNames.forEach(folderName => {
			const div = document.createElement('div');
			div.className = 'course-card';

			// Comptage listes/cartes dans ce cours
			let listCount = 0;
			let cardCount = 0;
			const folder = category[folderName] || {};
			Object.values(folder).forEach(cards => {
				listCount++;
				cardCount += (cards ? cards.length : 0);
			});

			div.onclick = () => showListsPage(catName, folderName);

			div.innerHTML =
				'<div class="course-card-left">' +
					'<div class="course-card-title">' + escapeHtml(folderName) + '</div>' +
					'<div class="course-card-info">' +
						listCount + ' liste' + (listCount > 1 ? 's' : '') + ' • ' +
						cardCount + ' carte' + (cardCount > 1 ? 's' : '') +
						'</div>' +
					'</div>' +
					'<div class="course-card-arrow">→</div>';

				container.appendChild(div);
			});
		}

        // ====== FONCTIONS DE GESTION DES CARTES ======
        function addCard() {
            const q = document.getElementById('newQuestion').innerHTML.trim();
            const a = document.getElementById('newAnswer').innerHTML.trim();
            const impEl = document.getElementById('importanceSelect');
            const importance = impEl ? (impEl.value || 'normal') : 'normal';
            if (!q || !a || q === '<br>' || a === '<br>') {
                showNotification('Veuillez remplir la question et la réponse.', 'error');
                return;
            }
            if (!currentCategory || !currentFolder || !currentList) {
                showNotification("Sélectionne d'abord une liste.", 'error');
                return;
            }
            categories[currentCategory][currentFolder][currentList].push({
                question: q,
                answer: a,
                importance: importance
            });
			saveUserData();
            saveData();
            document.getElementById('newQuestion').innerHTML = '';
            document.getElementById('newAnswer').innerHTML = '';
            if (impEl) impEl.value = 'normal';
            updateCategoryList();
            if (currentPage === 'manage') loadManagePage();
            showNotification('Carte ajoutée avec succès ✓', 'success');
        }

		function saveUserData() {
			if (!currentUser || !currentUser.username) return;

			// Categories -> user
			currentUser.folders = categories;

			// Persistance
			localStorage.setItem('current_user', JSON.stringify(currentUser));

			// Optionnel : garder aussi la base users à jour
			allUsers = JSON.parse(localStorage.getItem('flashcards_users') || '{}');
			allUsers[currentUser.username] = currentUser;
			localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
		}

		function saveCardFromModal() {
			const q = document.getElementById('qInput').value.trim();
			const a = document.getElementById('aInput').value.trim();
			const importance = document.getElementById('importanceSelect').value;

			const cards = categories[currentCategory][currentFolder][currentList];

			if (!q || !a) {
				showNotification("Question et réponse obligatoires", "error");
				return;
			}

			if (editMode && editTargetIndex !== null) {
					// UPDATE (modifier)
				cards[editTargetIndex] = { ...cards[editTargetIndex], q, a, importance };
				} else {
					// CREATE (ajouter)
					cards.push({ q, a, importance });
			}

			saveUserData();      // ta sauvegarde (localStorage / etc.)
			loadManagePage();    // ou refresh de la page de gestion
			closeCardModal();
		}

		function saveCardEdit() {
			const i = window._editingCardIndex;
			if (i === undefined || i === null) return;

			const cards = categories[currentCategory][currentFolder][currentList];

			const question = document.getElementById('newQuestion').innerHTML.trim();
			const answer = document.getElementById('newAnswer').innerHTML.trim();
			const importance = document.getElementById('importanceSelect').value;

			cards[i] = { ...cards[i], question, answer, importance };

			// sauvegarde comme tu fais déjà (mets ici ta fonction existante)
			saveUserData?.(); // si tu as
			localStorage.setItem(`flashcards_open_${currentUser.username}`, JSON.stringify(openCategories)); // uniquement si c’est comme ça chez toi

			// refresh UI
			loadManagePage?.();
			loadListsPage?.();

			// ferme le modal (mets ici ta fonction existante)
			closeNewCardModal?.();
			hideAllInlineFormatPanels();

			window._editingCardIndex = null;
		}

        function showManagePage(catName, folderName, listName) {
            currentCategory = catName;
            currentFolder = folderName;
            currentList = listName;
            currentPage = 'manage';
            updateCategoryList();

            const title = document.getElementById('manageTitle');
            if (title) {
                title.textContent = listName;
            }
			enableCardsDragAndDrop();
            loadManagePage();
            showPage('manage');
        }

		function injectFormatPanelsInCardsList() {
			document.querySelectorAll('#cardsList .card-edit-item').forEach(cardItem => {
				const i = Number(cardItem.dataset.index);
				if (!Number.isInteger(i)) return;

				// évite doublons
				if (cardItem.querySelector(`.format-panel[data-format-for="${i}"]`)) return;

				cardItem.insertAdjacentHTML('beforeend', renderFormatPanel(i));

				// synchro importance si tu l’utilises
				const inlineSel = document.getElementById(`inlineImportance${i}`);
				const origSel = document.getElementById(`editImportance${i}`);
				if (inlineSel && origSel) inlineSel.value = origSel.value;
			});
		}

        function loadManagePage() {
            const cardsList = document.getElementById('cardsList');
            const cardCount = document.getElementById('cardCount');
            if (!currentCategory || !currentFolder || !currentList || !categories[currentCategory] ||
                !categories[currentCategory][currentFolder] || !categories[currentCategory][currentFolder][currentList]) {
                cardsList.innerHTML = '<div class="empty-cards-message">Sélectionnez d\'abord une liste</div>';
                cardCount.textContent = '0';
                return;
            }

            const cards = categories[currentCategory][currentFolder][currentList];
            cardCount.textContent = cards.length;

            if (cards.length === 0) {
                cardsList.innerHTML = '<div class="empty-cards-message">Aucune carte dans cette liste. Ajoutez-en une !</div>';
                return;
            }

            cardsList.innerHTML = '';
            cards.forEach((card, idx) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-edit-item';
                cardDiv.dataset.index = idx;
                cardDiv.innerHTML = `
                    <div class="card-edit-header">
                        <div class="card-edit-number">#${idx + 1} <span class="card-importance-badge ${card.importance}">${card.importance}</span></div>
                        <div>
                            <button class="btn-edit-card" onclick="editCard(${idx})">✏️</button>
                            <button class="btn-delete-card" onclick="deleteCard(${idx})">✕</button>
                        </div>
                    </div>
                    <div class="card-edit-content">
                        <div class="card-edit-text"><span class="card-edit-label">Question:</span> ${card.question}</div>
                        <div class="card-edit-text"><span class="card-edit-label">Réponse:</span> ${card.answer}</div>
                    </div>
                `;
                cardsList.appendChild(cardDiv);
            });
			// APRES avoir rendu toutes les cartes dans #cardsList
			document.querySelectorAll('#cardsList .card-edit-item').forEach(cardItem => {
				const i = Number(cardItem.dataset.index);
				if (!Number.isInteger(i)) return;

				// Evite doublon
				if (cardItem.querySelector(`.format-panel[data-format-for="${i}"]`)) return;

				cardItem.querySelector('.card-inline-editor')?.insertAdjacentHTML('afterend', renderFormatPanel(i));

				const inlineSel = document.getElementById(`inlineImportance${i}`);
				const origSel = document.getElementById(`editImportance${i}`);
				if (inlineSel && origSel) inlineSel.value = origSel.value;
			});
			enableCardsDragAndDrop();
        }

        function deleteCard(idx) {
            if (!confirm('Supprimer cette carte ?')) return;
            categories[currentCategory][currentFolder][currentList].splice(idx, 1);
			saveUserData();
            saveData();
            updateCategoryList();
            if (currentPage === 'manage') loadManagePage();
            showNotification('Carte supprimée ✓', 'success');
        }

        function editCard(idx) {
            const cards = categories[currentCategory][currentFolder][currentList];
            if (idx < 0 || idx >= cards.length) return;

            const card = cards[idx];

            const editorDiv = document.createElement('div');
            editorDiv.className = 'card-inline-editor';
            editorDiv.innerHTML = `
                <div class="input-group">
                    <label>Question:</label>
                    <div class="editor-content" id="editQuestion${idx}" contenteditable="true">${card.question}</div>
                </div>
                <div class="input-group">
                    <label>Réponse:</label>
                    <div class="editor-content" id="editAnswer${idx}" contenteditable="true">${card.answer}</div>
                </div>
                <div class="input-group">
                    <label>Importance:</label>
                    <select id="editImportance${idx}">
                        <option value="important" ${card.importance === 'important' ? 'selected' : ''}>Important</option>
                        <option value="normal" ${card.importance === 'normal' ? 'selected' : ''}>Normal</option>
                        <option value="pas important" ${card.importance === 'pas important' ? 'selected' : ''}>Pas important</option>
                        <option value="explication" ${card.importance === 'explication' ? 'selected' : ''}>Explication</option>
                    </select>
                </div>
                <div class="actions">
                    <button class="btn-save-card" onclick="saveEditedCard(${idx})">💾 Enregistrer</button>
                    <button class="btn-cancel-card" onclick="cancelEditCard(${idx})">✕ Annuler</button>
                </div>
            `;

            const cardElement = document.querySelector(`.card-edit-item[data-index="${idx}"]`);
            cardElement.innerHTML = '';
            cardElement.appendChild(editorDiv);

			// Affiche le panneau format à côté (après le rerender)
			requestAnimationFrame(() => showInlineFormatPanel(idx));
        }

		function renderFormatPanel(i) {
			// i = index de la fiche (0,1,2...)
			return `
				<div class="format-panel" data-format-for="${i}">
					<div class="format-title">FORMAT</div>

					<div class="format-grid-3">
						<button class="editor-btn" type="button" onclick="execFormatCommand('bold')"><b>G</b></button>
						<button class="editor-btn" type="button" onclick="execFormatCommand('italic')"><i>I</i></button>
						<button class="editor-btn" type="button" onclick="execFormatCommand('underline')"><u>S</u></button>
						<button class="editor-btn" type="button" onclick="insertBulletNow()" title="Puce">•</button>
					</div>

					<div class="format-subtitle">Couleurs</div>
					<div class="format-grid-2">
						<div>
							<div class="format-mini-label">Texte</div>
							<input type="color" id="textColorPicker${i}" onmousedown="saveSelection()">
							<button type="button" class="editor-btn" onclick="applySavedColor('foreColor','textColorPicker${i}')">OK</button>
						</div>
						<div>
							<div class="format-mini-label">Fond</div>
							<input type="color" id="bgColorPicker${i}" onmousedown="saveSelection()">
							<button type="button" class="editor-btn" onclick="applySavedColor('backColor','bgColorPicker${i}')">OK</button>
						</div>
					</div>

					<div class="format-subtitle">Importance</div>
					<select class="format-select" id="inlineImportance${i}"
						onchange="syncInlineImportance(${i})">
						<option value="important">Important</option>
						<option value="normal">Normal</option>
						<option value="pas important">Pas important</option>
						<option value="explication">Explication</option>
					</select>

					<div class="format-grid-2" style="margin-top:6px;">
						<button class="editor-btn" type="button" onclick="setActiveInlineEditor(${i}, 'question'); insertImage()">🖼️ Image</button>
						<button class="editor-btn" type="button" onclick="clearFormatNow()">✖</button>
					</div>

					<div class="format-hint">Sélectionne du texte puis clique.</div>
				</div>
			`;
		}

        function saveEditedCard(i) { 
			const cards = categories[currentCategory][currentFolder][currentList];
			if (!cards || !cards[i]) return;

			const qEl = document.getElementById(`editQuestion${i}`);
			const aEl = document.getElementById(`editAnswer${i}`);
			const impEl = document.getElementById(`editImportance${i}`);

			const question = (qEl ? qEl.innerHTML : '').trim();
			const answer = (aEl ? aEl.innerHTML : '').trim();
			const importance = impEl ? impEl.value : (cards[i].importance || 'normal');

			cards[i] = { ...cards[i], question, answer, importance };

			saveData();                 // <-- indispensable pour persister
			loadManagePage?.();         // ou ta fonction qui rerend #cardsList
			showNotification('Carte enregistrée ✓', 'success');
			openEditCard(i); 
			saveUserData(); 
			hideAllInlineFormatPanels(); 
		} 
		function cancelEditCard(i) { hideAllInlineFormatPanels(); /* rien ou masquer l’inline */ }

        function cancelEditCard(idx) {
            loadManagePage();
        }

		function goHome() {
			currentPage = 'home';
			showPage('home');
		}

		function backToCourses() {
			// On revient à la page "Catégorie" qui affiche tous les cours
			if (currentCategory) {
				showCategoryPage(currentCategory);
			} else {
				// sécurité si jamais currentCategory n'est pas défini
				goHome();
			}
		}

        // ====== FONCTIONS POUR LE MODE ÉTUDE ======
        function showStudyPage(catName, folderName, listName) {
            currentCategory = catName;
            currentFolder = folderName;
            currentList = listName;
            currentPage = 'study';
            updateCategoryList();
            loadStudyPage();
            showPage('study');
        }

        function loadStudyPage() {
    		if (!currentCategory || !currentFolder || !currentList) {
        	document.getElementById('emptyState').style.display = 'block';
        	document.getElementById('cardSection').style.display = 'none';
        	document.getElementById('endSection').style.display = 'none';
        	return;
    	}

    		const cards = categories[currentCategory][currentFolder][currentList];

    		// ✅ Met à jour les compteurs du filtre (Important/Normal/Pas important/Explication)
    		updateImportanceCounts(cards);

    		if (!cards || cards.length === 0) {
        		document.getElementById('emptyState').style.display = 'block';
        		document.getElementById('cardSection').style.display = 'none';
        		document.getElementById('endSection').style.display = 'none';
        		return;
    		}

    		// ✅ Construit la liste des indices à étudier selon le filtre d’importance
			if (!isCustomStudyIndices) {
    			studyIndices = cards
        			.map((_, i) => i)
        			.filter(i => importanceFilter.includes((cards[i].importance || 'normal').toLowerCase()));

    		}
			
    		if (studyIndices.length === 0) {
        		showNotification("Aucune carte ne correspond au filtre d'importance", "error");
       			document.getElementById('emptyState').style.display = 'block';
        		document.getElementById('cardSection').style.display = 'none';
        		document.getElementById('endSection').style.display = 'none';
        		return;
    		}

    		// ✅ Reset session
    		currentIndex = 0;
    		isReviewMode = false;
    		reviewIndices = [];

    		updateStudyStats(cards);
    		showCard();

    		document.getElementById('emptyState').style.display = 'none';
    		document.getElementById('cardSection').style.display = 'block';
   			document.getElementById('endSection').style.display = 'none';
    		document.getElementById('studyTitle').textContent = currentList;
    		document.getElementById('studyModeIndicator').style.display = 'none';
		}

		function startReviewFromIndices(cat, folder, listName, indices) {
			// Rien à revoir
			if (!indices || indices.length === 0) {
				showNotification("Rien à revoir ✅", "success");
				return;
			}

			// Contexte liste
			currentCategory = cat;
			currentFolder = folder;
			currentList = listName; // si tu utilises currentList, sinon enlève

			// Indices filtrés
			studyIndices = indices;
			isCustomStudyIndices = true;
			

			// Lance l'étude
			currentIndex = 0;
			showPage('study');
			loadStudyPage(); // important: ne doit pas écraser studyIndices
			showCard();      // si ta logique d'étude utilise showCard()
		}

		function restartCurrentList() {
			// relance la même liste depuis le début
			isCustomStudyIndices = false; // si tu as mis ce flag
			showStudyPage(currentCategory, currentFolder, currentList);
		}
		
		function goToNextListInFolder() {
			const folder = categories?.[currentCategory]?.[currentFolder];
			if (!folder) return;

			const listNames = Object.keys(folder);
			const idx = listNames.indexOf(currentList);

			if (idx === -1 || idx === listNames.length - 1) {
				// pas de liste suivante -> retour aux listes du cours
				showPage('lists');
				loadListsPage();
				return;
			}

			const nextListName = listNames[idx + 1];

			isCustomStudyIndices = false; // révision normale de la prochaine liste
			showStudyPage(currentCategory, currentFolder, nextListName);
		}
		
		function normalizeImportance(v) {
			return (v || 'normal').toLowerCase().trim();
		}

		function updateImportanceCounts(cards) {
			const counts = { important: 0, normal: 0, 'pas important': 0, explication: 0 };

		for (const c of cards) {
			const imp = normalizeImportance(c.importance);
			if (counts[imp] !== undefined) counts[imp]++;
			else counts.normal++; // fallback si valeur bizarre
		}

		const set = (id, n) => {
			const el = document.getElementById(id);
			if (el) el.textContent = `(${n})`;
		};

		set('countImpImportant', counts.important);
		set('countImpNormal', counts.normal);
		set('countImpPasImportant', counts['pas important']);
		set('countImpExplication', counts.explication);
	}

        function showCard() {
			resetFlipNoFlash();
			forceQuestionSide();
			resetFlipState();
            const cards = categories[currentCategory][currentFolder][currentList];

            if (!cards || cards.length === 0) {
                endStudy();
                return;
            }

            let currentCard;
            let total = 0;

            if (isReviewMode) {
                if (reviewIndices.length === 0) {
                    endStudy();
                    return;
                }
                currentCard = cards[reviewIndices[currentIndex]];
                total = reviewIndices.length;
            } else {
                if (currentIndex >= cards.length) {
                    endStudy();
                    return;
                }
                currentCard = cards[studyIndices[currentIndex]];
				total = studyIndices.length;
            }

            document.getElementById('question').innerHTML = currentCard.question;
            document.getElementById('answer').innerHTML = currentCard.answer;

            const card = document.getElementById('flashcard');
            card.classList.remove('flipped');

            // Barre de progression : 0% sur la 1ère fiche
			const progressFill = document.getElementById('progress-fill');
			if (progressFill) {
				progressFill.style.width = ((currentIndex / total) * 100) + '%';
			}

			// Texte : garde "Carte 1/total" sur la 1ère fiche
			document.getElementById('stats').textContent = `Carte ${currentIndex + 1}/${total}`;

            document.getElementById('btnEditCurrent').onclick = function() {
                editCurrentCard();
            };
			const badge = document.getElementById('importanceBadge');
			if (badge) {
  				const imp = (currentCard.importance || 'normal').toLowerCase();
  				badge.className = 'card-importance-header ' + (imp === 'pas important' ? 'pas-important' : imp);
  				badge.textContent = imp;
			}

			// Ajout/refresh des boutons “liste” et “suivante”
			let nav = document.getElementById('studyQuickNav');
			if (!nav) {
				nav = document.createElement('div');
				nav.id = 'studyQuickNav';
				nav.style.display = 'flex';
				nav.style.gap = '10px';
				nav.style.marginTop = '12px';

	// adapte le parent si besoin : le conteneur de la fiche en étude
				const parent = document.getElementById('studyCard') || document.getElementById('studyPage') || document.body;
				parent.appendChild(nav);
			}
        }
		
		function enableCardsDragAndDrop() {
			const listEl = document.getElementById('cardsList');
			if (!listEl) return;

			listEl.querySelectorAll('.card-edit-item').forEach(item => {
				item.setAttribute('draggable', 'true');

				item.addEventListener('dragstart', (e) => {
					draggedCardIndex = Number(item.dataset.index);
					item.classList.add('dragging');
					e.dataTransfer.effectAllowed = 'move';
				});

				item.addEventListener('dragend', () => {
					item.classList.remove('dragging');
					draggedCardIndex = null;
					listEl.querySelectorAll('.card-edit-item').forEach(x => x.classList.remove('drag-over'));
				});

				item.addEventListener('dragover', (e) => {
					e.preventDefault();
					item.classList.add('drag-over');
					e.dataTransfer.dropEffect = 'move';
				});

				item.addEventListener('dragleave', () => {
					item.classList.remove('drag-over');
				});

				item.addEventListener('drop', (e) => {
					e.preventDefault();
					item.classList.remove('drag-over');

					const targetIndex = Number(item.dataset.index);
					if (draggedCardIndex === null || Number.isNaN(targetIndex)) return;
					if (targetIndex === draggedCardIndex) return;

					const arr = categories[currentCategory][currentFolder][currentList];
					if (!Array.isArray(arr)) return;

					// réordonnancement du tableau
					const [moved] = arr.splice(draggedCardIndex, 1);
					arr.splice(targetIndex, 0, moved);

					saveData();

					// re-render la page manage (important pour remettre les data-index)
					showManagePage(currentCategory, currentFolder, currentList);
				});
			});
		}

        function flipCard() {
            const card = document.getElementById('flashcard');
            card.classList.toggle('flipped');
        }

        function answer(type) {
			resetFlipNoFlash();
			forceQuestionSide();
            const cards = categories[currentCategory][currentFolder][currentList];
			const actualIndex = isReviewMode ? reviewIndices[currentIndex] : studyIndices[currentIndex];
			const key = 'flashcards_results_Brochy'; // ou flashcards_results_${currentUser.username} si tu utilises ça
			const resultsRoot = JSON.parse(localStorage.getItem(key) || '{}');

			if (!resultsRoot[currentCategory]) resultsRoot[currentCategory] = {};
			if (!resultsRoot[currentCategory][currentFolder]) resultsRoot[currentCategory][currentFolder] = {};
			if (!resultsRoot[currentCategory][currentFolder][currentList]) resultsRoot[currentCategory][currentFolder][currentList] = {};

			const listResults = resultsRoot[currentCategory][currentFolder][currentList];

			answerHistory.push({
				cardIndex: actualIndex,
				prev: listResults[String(actualIndex)] ?? null
			});
			// IMPORTANT : utilise l’index réel de la carte
			// - si tu as studyIndices, c’est : const actualIndex = studyIndices[currentIndex];
			listResults[String(actualIndex)] = type; // type = 'known' | 'partial' | 'unknown'
			localStorage.setItem(key, JSON.stringify(resultsRoot));

            if (isReviewMode) {
                const actualIndex = reviewIndices[currentIndex];
                if (!results[currentCategory]) results[currentCategory] = {};
                if (!results[currentCategory][currentFolder]) results[currentCategory][currentFolder] = {};
                if (!results[currentCategory][currentFolder][currentList]) results[currentCategory][currentFolder][currentList] = {};
                results[currentCategory][currentFolder][currentList][actualIndex] = type;
                saveResults();
            } else {
                if (!results[currentCategory]) results[currentCategory] = {};
                if (!results[currentCategory][currentFolder]) results[currentCategory][currentFolder] = {};
                if (!results[currentCategory][currentFolder][currentList]) results[currentCategory][currentFolder][currentList] = {};
                results[currentCategory][currentFolder][currentList][actualIndex] = type;
                saveResults();
            }

            currentIndex++;

            // ✅ Fin de session : toujours afficher les résultats
			const totalToStudy = isReviewMode ? reviewIndices.length : studyIndices.length;
			if (currentIndex >= totalToStudy) {
  				endStudy();
 				return;
			}

			showCard();
        }

        function endStudy() {
            document.getElementById('cardSection').style.display = 'none';
            document.getElementById('endSection').style.display = 'block';

			// ✅ Barre de progression : pleine quand la session est terminée
			const pf = document.getElementById('progress-fill');
			if (pf) pf.style.width = '100%';

            const cards = categories[currentCategory][currentFolder][currentList];
            const listResults = results[currentCategory]?.[currentFolder]?.[currentList] || {};

            let known = 0, partial = 0, unknown = 0;

            for (let i = 0; i < cards.length; i++) {
                const result = listResults[i] || 'unknown';
                if (result === 'known') known++;
                else if (result === 'partial') partial++;
                else unknown++;
            }

            const total = cards.length;

            document.getElementById('legendKnown').textContent = `Connu: ${known} (${Math.round(known/total*100)}%)`;
            document.getElementById('legendPartial').textContent = `Partiel: ${partial} (${Math.round(partial/total*100)}%)`;
            document.getElementById('legendUnknown').textContent = `Pas connu: ${unknown} (${Math.round(unknown/total*100)}%)`;

            document.getElementById('barKnown').style.width = (known/total*100) + '%';
            document.getElementById('barPartial').style.width = (partial/total*100) + '%';
            document.getElementById('barUnknown').style.width = (unknown/total*100) + '%';

            if (known === total) {
                document.getElementById('resultGifImg').src = GIF_KNOWN_URL;
                document.getElementById('resultGif').classList.add('show');
            }
			loadListsPage();
        }

        function editCurrentCard() {
            const cards = categories[currentCategory][currentFolder][currentList];
            let cardIndex;

            if (isReviewMode && reviewIndices.length > 0) {
                cardIndex = reviewIndices[currentIndex];
            } else {
                cardIndex = currentIndex;
            }

            if (cardIndex >= 0 && cardIndex < cards.length) {
                const currentCardState = {
                    question: cards[cardIndex].question,
                    answer: cards[cardIndex].answer,
                    importance: cards[cardIndex].importance
                };

                const newQuestion = prompt("Modifier la question:", currentCardState.question);
                if (newQuestion === null) return;

                const newAnswer = prompt("Modifier la réponse:", currentCardState.answer);
                if (newAnswer === null) return;

                const importanceOptions = ["important", "normal", "pas important", "explication"];
                const currentImportanceIndex = importanceOptions.indexOf(currentCardState.importance);
                const newImportance = prompt(
                    "Importance (important, normal, pas important, explication):",
                    currentCardState.importance
                );

                if (newImportance && importanceOptions.includes(newImportance.toLowerCase())) {
                    cards[cardIndex] = {
                        question: newQuestion,
                        answer: newAnswer,
                        importance: newImportance.toLowerCase()
                    };

                    saveData();
                    showCard();
                    showNotification('Carte modifiée ✓', 'success');
                } else if (newImportance === null) {
                    return;
                } else {
                    showNotification('Importance non reconnue. Utilisez: important, normal, pas important, explication', 'error');
                }
            }
        }

        function updateStudyStats(cards) {
            const total = cards.length;
            const reviewed = Object.keys(results[currentCategory]?.[currentFolder]?.[currentList] || {}).length;

            if (total > 0) {
                const progressPercent = Math.round((reviewed / total) * 100);
                document.getElementById('stats').textContent = `${reviewed}/${total} révisées (${progressPercent}%)`;
            }
        }

		function applyImportanceFilter() {
 			const f = [];
  			if (document.getElementById('filterImpImportant')?.checked) f.push('important');
  			if (document.getElementById('filterImpNormal')?.checked) f.push('normal');
  			if (document.getElementById('filterImpPasImportant')?.checked) f.push('pas important');
  			if (document.getElementById('filterImpExplication')?.checked) f.push('explication');

  			if (f.length === 0) {
    			showNotification("Sélectionne au moins une importance", "error");
    			return;
  			}

  			importanceFilter = f;
  			loadStudyPage();
  			showNotification("Filtre appliqué ✓", "success");
		}

		function getActiveOpenKey() {
  			return localStorage.getItem("flashcards_open_active_key");
		}

		function getActiveCards() {
  			const openKey = getActiveOpenKey();
  			if (!openKey) return [];
  			return JSON.parse(localStorage.getItem(openKey) || "[]");
		}

		function hideAllInlineFormatPanels() {
			document.querySelectorAll('#cardsList .format-panel').forEach(p => p.remove());
		}

		function showInlineFormatPanel(i) {
			// enlève partout
			hideAllInlineFormatPanels();

			// cible la carte i
			const cardItem = document.querySelector(`#cardsList .card-edit-item[data-index="${i}"]`);
			if (!cardItem) return;

			// ajoute le panneau
			cardItem.insertAdjacentHTML('beforeend', renderFormatPanel(i));

			// sync importance si tu l’utilises
			const inlineSel = document.getElementById(`inlineImportance${i}`);
			const origSel = document.getElementById(`editImportance${i}`);
			if (inlineSel && origSel) inlineSel.value = origSel.value;

			setActiveInlineEditor(i, 'question');
		}

        // ====== FONCTIONS DU THÈME ======
		const THEME_KEY = 'flashcards_theme_v2';

		// Liste des variables que tu autorises à modifier dans l'UI
		const THEME_VARS = [
			{ group: "primary",  label: "Primaire",           varName: "--primary" },
			{ group: "primary",  label: "Secondaire",         varName: "--primary-2" },
			{ group: "primary",  label: "Accent",             varName: "--accent" },
			{ group: "primary",  label: "Accent 2",           varName: "--accent-2" },

			{ group: "ui",       label: "Fond (gradient 1)",  varName: "--bg-gradient-from" },
			{ group: "ui",       label: "Fond (gradient 2)",  varName: "--bg-gradient-to" },
			{ group: "ui",       label: "Panneau",            varName: "--panel" },
			{ group: "ui",       label: "Panneau (léger)",    varName: "--panel-muted" },
			{ group: "ui",       label: "Texte",              varName: "--text" },
			{ group: "ui",       label: "Texte (soft)",       varName: "--text-soft" },
			{ group: "ui",       label: "Bordures",           varName: "--border" },

			{ group: "progress", label: "Connu",              varName: "--known" },
			{ group: "progress", label: "Partiel",            varName: "--partial" },
			{ group: "progress", label: "Inconnu",            varName: "--unknown" },
			{ group: "progress", label: "Danger",             varName: "--danger" },
		];

		const THEME_PRESETS = [
			{
				name: "Violet",
				vars: {
					"--bg-gradient-from": "#667eea",
					"--bg-gradient-to": "#764ba2",
					"--primary": "#667eea",
					"--primary-2": "#764ba2",
					"--accent": "#11998e",
					"--accent-2": "#38ef7d",
					"--danger": "#ff6b6b",
					"--known": "#38ef7d",
					"--partial": "#f5a623",
					"--unknown": "#ff6b6b"
				}
			},
			{
				name: "Sombre",
				vars: {
					"--bg-gradient-from": "#0b0c0f",
					"--bg-gradient-to": "#14161a",
					"--panel": "#14161a",
					"--panel-muted": "#0e1014",
					"--text": "#e8ecf3",
					"--text-soft": "#a8b0c3",
					"--border": "#2a2f39",
					"--primary": "#5b8cff",
					"--primary-2": "#3b82f6",
					"--accent": "#22c55e",
					"--accent-2": "#16a34a",
					"--danger": "#ff5c5c",
					"--known": "#22c55e",
					"--partial": "#f59e0b",
					"--unknown": "#ff5c5c"
				}
			}
		];

		function setVar(name, value) {
			document.documentElement.style.setProperty(name, value);
		}

		function getComputedVar(name) {
			return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
		}

		function openThemeModal() {
			const modal = document.getElementById('themeModal');
			if (!modal) return;

			modal.classList.add('show');
			buildThemeUI(); // ✅ important : remplit le modal
		}

		function closeThemeModal() {
			const modal = document.getElementById('themeModal');
			if (modal) modal.classList.remove('show');
		}

		function buildThemeUI() {
			// Presets
			const presetsEl = document.getElementById("themePresets");
			if (presetsEl) {
				presetsEl.innerHTML = "";
				THEME_PRESETS.forEach(p => {
					const btn = document.createElement("button");
					btn.className = "preset-btn";
					btn.type = "button";
					btn.innerHTML = `
						<div class="preset-preview" style="background: linear-gradient(135deg, ${p.vars["--bg-gradient-from"]}, ${p.vars["--bg-gradient-to"]});"></div>
						<div>${p.name}</div>
					`;
					btn.onclick = () => {
						applyThemeObject(p.vars);
						refreshThemeInputs();
					};
					presetsEl.appendChild(btn);
				});
			}

			// Sections
			renderThemeGroup("primaryColors", "primary");
			renderThemeGroup("interfaceColors", "ui");
			renderThemeGroup("progressColors", "progress");

			// Import theme handler (si pas déjà branché)
			const importInput = document.getElementById("themeImportInput");
			if (importInput && !importInput.dataset.bound) {
				importInput.dataset.bound = "1";
				importInput.addEventListener("change", async (e) => {
					const file = e.target.files?.[0];
					if (!file) return;
					const text = await file.text();
					try {
						const theme = JSON.parse(text);
						applyThemeObject(theme);
						saveTheme();
						refreshThemeInputs();
						showNotification("Thème importé ✓", "success");
					} catch {
						showNotification("Fichier de thème invalide", "error");
					}
					importInput.value = "";
				});
			}

			refreshThemeInputs();
		}

		function renderThemeGroup(containerId, groupName) {
			const container = document.getElementById(containerId);
			if (!container) return;

			container.innerHTML = "";
			THEME_VARS.filter(v => v.group === groupName).forEach(v => {
				const row = document.createElement("div");
				row.className = "color-option";

				const current = getComputedVar(v.varName) || "#000000";

				row.innerHTML = `
					<div class="color-label">
						<span>${v.label}</span>
						<code>${v.varName}</code>
					</div>
					<div class="color-input-wrapper">
						<input type="color" data-var="${v.varName}">
						<input type="text" data-var="${v.varName}" placeholder="#RRGGBB">
					</div>
				`;

				const colorInput = row.querySelector('input[type="color"]');
				const textInput = row.querySelector('input[type="text"]');

				// Valeurs initiales
				colorInput.value = normalizeToHex(current);
				textInput.value = normalizeToHex(current);

				colorInput.addEventListener("input", () => {
					setVar(v.varName, colorInput.value);
					textInput.value = colorInput.value;
				});

				textInput.addEventListener("change", () => {
					const hex = normalizeToHex(textInput.value);
					setVar(v.varName, hex);
					colorInput.value = hex;
					textInput.value = hex;
				});

				container.appendChild(row);
			});
		}

		function normalizeToHex(value) {
			// attend un "#RRGGBB" ; si autre, on garde mais on évite de crasher
			if (typeof value !== "string") return "#000000";
			const v = value.trim();
			if (/^#[0-9A-Fa-f]{6}$/.test(v)) return v;
			// Essai : si rgb(...) -> conversion rapide via canvas
			if (v.startsWith("rgb")) {
				const m = v.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
				if (m) {
					const r = Number(m[1]).toString(16).padStart(2, "0");
					const g = Number(m[2]).toString(16).padStart(2, "0");
					const b = Number(m[3]).toString(16).padStart(2, "0");
					return `#${r}${g}${b}`;
				}
			}
			return "#000000";
		}

		function getCurrentThemeObject() {
			const obj = {};
			THEME_VARS.forEach(v => {
				obj[v.varName] = getComputedVar(v.varName);
			});
			return obj;
		}

		function applyThemeObject(themeObj) {
			if (!themeObj || typeof themeObj !== "object") return;
			Object.entries(themeObj).forEach(([k, v]) => {
				if (typeof k === "string" && k.startsWith("--") && typeof v === "string") {
					setVar(k, v);
				}
			});
		}

		function refreshThemeInputs() {
			// met à jour les inputs pour refléter les valeurs actuelles
			document.querySelectorAll('#themeModal input[data-var]').forEach(inp => {
				const varName = inp.getAttribute("data-var");
				const current = normalizeToHex(getComputedVar(varName));
				if (inp.type === "color") inp.value = current;
				if (inp.type === "text") inp.value = current;
			});
		}

		function saveTheme() {
			if (!currentUser) return;

			const theme = {
				'--bg-gradient-from': getComputedStyle(document.documentElement).getPropertyValue('--bg-gradient-from').trim(),
				'--bg-gradient-to': getComputedStyle(document.documentElement).getPropertyValue('--bg-gradient-to').trim(),
				'--primary': getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
				'--primary-2': getComputedStyle(document.documentElement).getPropertyValue('--primary-2').trim(),
				'--accent': getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
				'--accent-2': getComputedStyle(document.documentElement).getPropertyValue('--accent-2').trim(),
				'--danger': getComputedStyle(document.documentElement).getPropertyValue('--danger').trim(),
				'--text': getComputedStyle(document.documentElement).getPropertyValue('--text').trim(),
				'--text-soft': getComputedStyle(document.documentElement).getPropertyValue('--text-soft').trim(),
				'--panel': getComputedStyle(document.documentElement).getPropertyValue('--panel').trim(),
				'--panel-muted': getComputedStyle(document.documentElement).getPropertyValue('--panel-muted').trim(),
				'--border': getComputedStyle(document.documentElement).getPropertyValue('--border').trim(),
				'--known': getComputedStyle(document.documentElement).getPropertyValue('--known').trim(),
				'--partial': getComputedStyle(document.documentElement).getPropertyValue('--partial').trim(),
				'--unknown': getComputedStyle(document.documentElement).getPropertyValue('--unknown').trim(),
			};

			localStorage.setItem(`flashcards_theme_${currentUser.username}`, JSON.stringify(theme));
			showNotification('Thème enregistré ✓', 'success');
		}

		function resetTheme() {
			localStorage.removeItem(THEME_KEY);
			location.reload(); // simple et fiable : on revient au CSS par défaut
		}

		function exportTheme() {
			const theme = getCurrentThemeObject();
			const blob = new Blob([JSON.stringify(theme, null, 2)], { type: "application/json" });
			const url = URL.createObjectURL(blob);
			const a = document.createElement("a");
			a.href = url;
			a.download = `flashcards_theme_${new Date().toISOString().slice(0,10)}.json`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
			showNotification("Thème exporté ✓", "success");
		}

        // ====== FONCTIONS DU COMPARATEUR ======
        function openComparator() {
            document.getElementById('comparatorModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeComparator() {
            document.getElementById('comparatorModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

		// Variables comparateur
let showContext = false;
let lastFocusedId = null;
let lastFocusedType = null;
let lastSelectedBtn = null;

const $ = sel => document.querySelector(sel);
const oldTA = $("#oldText");
const newTA = $("#newText");
const outComp = $("#diffOutput");
const changesListComp = $("#changesList");
const insCountComp = $("#insCount");
const delCountComp = $("#delCount");
const repCountComp = $("#repCount");
const hintComp = $("#hint");
const copyBtnComp = $("#copyBtn");
const toggleContextBtnComp = $("#toggleContext");
const backBtn = $("#backToSelected");

function escapeHtmlComp(s) { return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function normalizeSpaces(s) { return s.replace(/[ \t]+/g, ' '); }
function emojiFor(t) { return t==='insertion' ? '➕' : t==='suppression' ? '➖' : '♻️'; }
function cap(s) { return s.charAt(0).toUpperCase()+s.slice(1); }
function isOnlySpaces(s) { return !s || /^\s+$/.test(s); }
function isWhitespaceOnlyChange(removed, added) {
    const r = (removed||"").replace(/\s+/g,'');
    const a = (added||"").replace(/\s+/g,'');
    return r === a && (removed!==added);
}

function updateBackButton() {
    if (lastSelectedBtn) {
        backBtn.classList.add('visible');
        backBtn.disabled = false;
    } else {
        backBtn.classList.remove('visible');
    }
}

function clearFocusComp() {
    if (lastFocusedId) {
        const prev = document.getElementById(lastFocusedId);
        if (prev && prev.classList) prev.classList.remove('focused');
        const ghost = document.getElementById(lastFocusedId + '-ghost');
        if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
        const delGhost = document.getElementById(lastFocusedId + '-delghost');
        if (delGhost && delGhost.parentNode) delGhost.parentNode.removeChild(delGhost);
    }
    lastFocusedId = null;
    lastFocusedType = null;
}

function showDeletionGhostAfter(anchorEl, id, removedText) {
    const old = document.getElementById(id + '-delghost');
    if (old && old.parentNode) old.parentNode.removeChild(old);
    const ghost = document.createElement('span');
    ghost.id = id + '-delghost';
    ghost.className = 'del-ghost';
	ghost.classList.add('focused');
    const content = '(' + removedText + ')';
    ghost.innerHTML = `<mark class="del">${escapeHtmlComp(content)}</mark>`;
    anchorEl.insertAdjacentElement('afterend', ghost);
}

function focusChangeComp(id, type, options) {
    clearFocusComp();
    const el = document.getElementById(id);
    if (!el) return;
    
    if (el.tagName === 'MARK') {
        el.classList.add('focused');
        lastFocusedId = id;
        lastFocusedType = type || null;
    } else {
        lastFocusedId = id;
        lastFocusedType = type || 'suppression';
        
        if ((type === 'suppression') && options && options.removedText) {
            showDeletionGhostAfter(el, id, options.removedText);
        } else {
            let ghost = document.getElementById(id + '-ghost');
            if (!ghost) {
                ghost = document.createElement('span');
                ghost.id = id + '-ghost';
				ghost.className = 'focus-ghost focused';
				el.insertAdjacentElement('afterend', ghost);
            }
        }
    }
    (el.tagName === 'MARK' ? el : document.getElementById(id)).scrollIntoView({behavior:'smooth', block:'center'});
}

function computeComp() {
	const oldTxt = oldTA.value || "";
	const newTxt = newTA.value || "";

	const parts = (window.Diff && Diff.diffWordsWithSpace)
		? Diff.diffWordsWithSpace(oldTxt, newTxt)
		: [{ removed: true, value: oldTxt }, { added: true, value: newTxt }];

	let html = "";
	let changes = [];
	let ins = 0, del = 0, rep = 0, idxChange = 0;

	for (let i = 0; i < parts.length; i++) {
		const p = parts[i];
		if ((p.added || p.removed) && isOnlySpaces(p.value)) continue;

		// --- Suppression (potentiellement suivie d'un added => remplacement)
		if (p.removed && !p.added) {
			const next = parts[i + 1];

			// Remplacement = removed puis added
			if (next && next.added && !next.removed) {
				if (!isOnlySpaces(next.value) && !isWhitespaceOnlyChange(p.value, next.value)) {
					const anchorId = `chg-${++idxChange}`;

					// On ancre sur le texte "nouveau" (mark.ins)
					html += `<mark class="ins" id="${anchorId}">${escapeHtmlComp(normalizeSpaces(next.value))}</mark>`;

					rep++;
					changes.push({ id: anchorId, type: 'remplacement', added: next.value, removed: p.value });

					i++; // on consomme le "next"
					continue;
				} else {
					i++; // ignore changement uniquement d'espaces
					continue;
				}
			}

			// Suppression pure : ancre invisible dans le texte central
			const anchorId = `chg-${++idxChange}`;
			html += `<a id="${anchorId}"></a>`;

			del++;
			changes.push({ id: anchorId, type: 'suppression', added: '', removed: p.value });
			continue;
		}

		// --- Insertion
		if (p.added && !p.removed) {
			if (isOnlySpaces(p.value)) continue;

			const anchorId = `chg-${++idxChange}`;
			html += `<mark class="ins" id="${anchorId}">${escapeHtmlComp(normalizeSpaces(p.value))}</mark>`;

			ins++;
			changes.push({ id: anchorId, type: 'insertion', added: p.value, removed: '' });
			continue;
		}

		// --- Texte inchangé
		html += escapeHtmlComp(normalizeSpaces(p.value));
	}

	outComp.innerHTML = html;

	// ✅ sanity check rapide (tu peux laisser temporairement)
	// console.log('anchors:', document.querySelectorAll('#diffOutput [id^="chg-"]').length);

	renderChangesListComp(changes);

	insCountComp.textContent = ins;
	delCountComp.textContent = del;
	repCountComp.textContent = rep;
	hintComp.textContent = `${ins + del + rep} modifications détectées${rep ? " • remplacements: " + rep : ""}.`;
}

function flashSidebarCard(btn) {
    const prevShadow = btn.style.boxShadow;
    btn.style.boxShadow = '0 0 0 3px rgba(255,209,102,0.45)';
    setTimeout(() => { btn.style.boxShadow = prevShadow; }, 750);
}

function renderChangesListComp(changes) {
    changesListComp.innerHTML = "";
    const filtered = changes.filter(c => {
        if (c.type === 'remplacement') return !isWhitespaceOnlyChange(c.removed, c.added);
        if (c.type === 'insertion') return !isOnlySpaces(c.added);
        if (c.type === 'suppression') return !isOnlySpaces(c.removed);
        return true;
    });
    
    if (!filtered.length) {
        changesListComp.innerHTML = '<div style="color:#8b93a6;padding:8px">Aucun changement.</div>';
        updateBackButton();
        return;
    }
    
    const ctxSpan = showContext ? 24 : 0;
    let toRestoreId = (lastSelectedBtn && lastSelectedBtn.dataset.id) ? lastSelectedBtn.dataset.id : null;
    lastSelectedBtn = null;
    
    for (const c of filtered) {
        const btn = document.createElement('button');
        btn.className = 'comp-change';
        btn.type = 'button';
        btn.dataset.id = c.id;
        btn.dataset.type = c.type;
        if (c.type === 'suppression') {
            btn.dataset.removed = c.removed;
        }
        
        let tokenHtml = '';
        if (c.type === 'insertion') {
            tokenHtml = `<mark class="token">${escapeHtmlComp(c.added)}</mark>`;
        } else if (c.type === 'suppression') {
            tokenHtml = `<mark class="token del">${escapeHtmlComp(c.removed)}</mark>`;
        } else {
            tokenHtml = `<mark class="token del">${escapeHtmlComp(c.removed)}</mark> <span style="display:inline-block;width:6px"></span> <mark class="token">${escapeHtmlComp(c.added)}</mark>`;
        }
        
        let ctx = '';
        if (ctxSpan > 0) {
            const src = c.type==='suppression' ? (oldTA.value||"") : (newTA.value||"");
            const needle = (c.type==='suppression') ? c.removed : c.added;
            const flat = (needle||"").replace(/\s+/g,' ').trim();
            const pos = flat ? src.indexOf(flat) : -1;
            if (pos>=0) {
                const start = Math.max(0,pos-ctxSpan);
                const end = Math.min(src.length, pos+flat.length+ctxSpan);
                ctx = (start>0?'…':'') + src.slice(start,end).replace(/\s+/g,' ') + (end<src.length?'…':'');
            }
        }
        
        btn.innerHTML = `<span class="type">${emojiFor(c.type)} ${cap(c.type)}</span> ${tokenHtml} ${ctx ? `<span class="ctx">${escapeHtmlComp(ctx)}</span>` : ``}`;
        
        btn.addEventListener('click', () => {

            const prev = document.querySelector('.comp-change.selected');
            if (prev) prev.classList.remove('selected');
            btn.classList.add('selected');
            lastSelectedBtn = btn;
            
            const opts = (btn.dataset.type === 'suppression') ? { removedText: btn.dataset.removed || '' } : undefined;
			document.getElementById('diffOutput')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            focusChangeComp(btn.dataset.id, btn.dataset.type, opts);
            updateBackButton();

			const target = document.getElementById(btn.dataset.id);
			if (!target) {
			// le diff a été recalculé, on le recalcule puis on refait un focus
				computeComp();
			}
        });
        
        changesListComp.appendChild(btn);
        
        if (toRestoreId && c.id === toRestoreId) {
            btn.classList.add('selected');
            lastSelectedBtn = btn;
        }
    }
    
    updateBackButton();
}

document.getElementById("compareBtn").addEventListener('click', () => {
    if (lastSelectedBtn) { lastSelectedBtn.classList.remove('selected'); lastSelectedBtn = null; }
    clearFocusComp();
    computeComp();
    updateBackButton();
});

document.getElementById("toggleContext").addEventListener('click', () => {
    showContext = !showContext;
    document.getElementById("toggleContext").textContent = showContext ? "Contexte —" : "± Contexte";
    const prevSelectedId = lastSelectedBtn ? lastSelectedBtn.dataset.id : null;
    const prevFocused = lastFocusedId;
    computeComp();
    if (prevSelectedId) {
        const candidate = Array.from(document.querySelectorAll('.comp-change')).find(b => b.dataset.id === prevSelectedId);
        if (candidate) {
            candidate.classList.add('selected');
            lastSelectedBtn = candidate;
        } else {
            lastSelectedBtn = null;
        }
    }
    if (prevFocused) {
        const el = document.getElementById(prevFocused);
        if (el && el.tagName === 'MARK') {
            el.classList.add('focused');
            lastFocusedId = prevFocused;
        } else {
            lastFocusedId = null;
            lastFocusedType = null;
        }
    }
    updateBackButton();
});

document.getElementById("copyBtn").addEventListener('click', async () => {
    try {
        await navigator.clipboard.writeText(outComp.innerHTML);
        copyBtnComp.textContent = 'Copié ✓';
        setTimeout(() => copyBtnComp.textContent = 'Copier le résultat', 900);
    } catch(e) {
        alert("Impossible de copier. Sélectionne et copie manuellement.");
    }
});

backBtn.addEventListener('click', () => {
    if (!lastSelectedBtn) return;
    lastSelectedBtn.scrollIntoView({behavior:'smooth', block:'center'});
    flashSidebarCard(lastSelectedBtn);
});

// Exemples par défaut
oldTA.value = "Le contrat entre en vigueur le 1er janvier 2024.\nLe prix est de 100€.\nLe client accepte les conditions.";
newTA.value = "Le contrat prend effet le 1er janvier 2025.\nLe prix est de 120 €.\nLe client accepte pleinement les conditions générales.";

        // ====== FONCTIONS MANQUANTES IMPLÉMENTÉES ======
        function logout() {
            if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                localStorage.removeItem('current_user');
                location.reload();
            }
        }
		// ====== FIX: conserver rouges + remettre le focus jaune ======
		window._comp_lastFullHTML = '';
		window._comp_lastFocusedId = null;

		function saveFullDiffHTML() {
			const out = document.getElementById('diffOutput');
			if (out) window._comp_lastFullHTML = out.innerHTML;
		}

		function applyFocusById(id) {
			if (!id) return;

	// Nettoyage
			document.querySelectorAll('#diffOutput .focused, #diffOutput mark.focused')
				.forEach(x => x.classList.remove('focused'));

			const el = document.getElementById(id);
			if (!el) return;

	// 1) Focus sur le conteneur (span / a / etc.)
			el.classList.add('focused');

	// 2) Focus sur le mark INS/DEL à l’intérieur (c’est souvent lui qui est stylé)
			let mk = null;
			if (el.tagName && el.tagName.toLowerCase() === 'mark') mk = el;
			else mk = el.querySelector('mark.ins, mark.del') || el.querySelector('mark');

			if (mk) mk.classList.add('focused');

			el.scrollIntoView({ behavior: 'smooth', block: 'center' });
		}

		function restoreFullDiffHTMLIfNeeded() {
			const out = document.getElementById('diffOutput');
			if (!out || !window._comp_lastFullHTML) return;

			const now = out.innerHTML;

			const nowHasDel = /class="del"|class='del'|del-ghost/.test(now);
			const savedHasDel = /class="del"|class='del'|del-ghost/.test(window._comp_lastFullHTML);

			if (!nowHasDel && savedHasDel) {
				out.innerHTML = window._comp_lastFullHTML;
			}
		}

// 1) Après "Comparer", sauvegarde du diff complet
		document.addEventListener('click', (e) => {
			if (e.target && e.target.id === 'compareBtn') {
				setTimeout(() => {
					saveFullDiffHTML();
			// reset du focus
					window._comp_lastFocusedId = null;
				}, 0);
			}
		}, true);

		function getCurrentFocusedIdFromDiff() {
	// Ton CSS semble viser mark.focused, donc on check d'abord ça
			let el = document.querySelector('#diffOutput mark.focused');

	// Sinon on prend n'importe quel élément .focused
			if (!el) el = document.querySelector('#diffOutput .focused');
			if (!el) return null;

	// Si l'élément n'a pas d'id, on remonte au parent qui en a un
			if (el.id) return el.id;

			const parentWithId = el.closest('[id]');
			return parentWithId ? parentWithId.id : null;
		}

		const changesList = document.getElementById('changesList');
		if (changesList) {
			changesList.addEventListener('click', () => {
				setTimeout(() => {
			// 1) On récupère l'ID actuellement "focus" dans le texte central
					window._comp_lastFocusedId = getCurrentFocusedIdFromDiff();

			// 2) Si le clic a fait disparaître les rouges, on restaure le HTML complet
					restoreFullDiffHTMLIfNeeded();

			// 3) Et on remet le focus jaune sur l'élément correspondant
					applyFocusById(window._comp_lastFocusedId);
				}, 0);
			}, true);
		}
		
        function togglePublicProfile() {
            if (!currentUser) return;

            const isPublic = document.getElementById('publicProfileToggle').checked;
            currentUser.publicProfile = isPublic;
            allUsers[currentUser.username] = currentUser;
            localStorage.setItem('flashcards_users', JSON.stringify(allUsers));

            showNotification('Profil ' + (isPublic ? 'public' : 'privé') + ' ✓', 'success');
        }

        function openProfileSettings() {
            if (!currentUser) return;

            document.getElementById('profileSettingsModal').classList.add('show');
            document.getElementById('settingsUsername').value = currentUser.username;
            document.getElementById('settingsEmail').value = currentUser.email || '';
            document.getElementById('settingsBio').value = currentUser.bio || '';

            const avatarPreview = document.getElementById('avatarPreview');
            if (avatarPreview) {
                if (currentUser.avatar) {
                    avatarPreview.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    avatarPreview.innerHTML = currentUser.username.charAt(0).toUpperCase();
                }
            }
        }

        function closeProfileSettings() {
            document.getElementById('profileSettingsModal').classList.remove('show');
        }

        function saveProfileSettings() {
            if (!currentUser) return;

            const username = document.getElementById('settingsUsername').value.trim();
            const email = document.getElementById('settingsEmail').value.trim();
            const bio = document.getElementById('settingsBio').value.trim();
            const currentPassword = document.getElementById('settingsCurrentPassword').value;
            const newPassword = document.getElementById('settingsNewPassword').value;
            const confirmPassword = document.getElementById('settingsConfirmPassword').value;

            if (!username) {
                showNotification('Le nom d\'utilisateur est requis', 'error');
                return;
            }

            if (newPassword && newPassword !== confirmPassword) {
                showNotification('Les mots de passe ne correspondent pas', 'error');
                return;
            }

            if (newPassword && !currentPassword && currentUser.password !== 'guest') {
                showNotification('Veuillez entrer votre mot de passe actuel', 'error');
                return;
            }

            if (newPassword && currentUser.password !== currentPassword && currentUser.password !== 'guest') {
                showNotification('Mot de passe actuel incorrect', 'error');
                return;
            }

            currentUser.username = username;
            currentUser.email = email;
            currentUser.bio = bio;

            if (newPassword) {
                currentUser.password = newPassword;
            }

            allUsers[currentUser.username] = currentUser;
            localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
            localStorage.setItem('current_user', JSON.stringify(currentUser));

            showNotification('Profil mis à jour ✓', 'success');
            closeProfileSettings();
            loadUserData();
        }

        function searchUsers() {
            const query = document.getElementById('userSearchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('userSearchResults');
            resultsDiv.innerHTML = '';

            if (!query) return;

            const filteredUsers = Object.entries(allUsers)
                .filter(([username, user]) =>
                    username.toLowerCase().includes(query) &&
                    user.publicProfile &&
                    username !== currentUser.username
                )
                .slice(0, 10);

            if (filteredUsers.length === 0) {
                resultsDiv.innerHTML = '<div class="user-result">Aucun utilisateur trouvé</div>';
                return;
            }

            filteredUsers.forEach(([username, user]) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'user-result';
                resultDiv.onclick = () => viewUserProfile(username);

                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'user-result-avatar';
                if (user.avatar) {
                    avatarDiv.innerHTML = `<img src="${user.avatar}" alt="${username}">`;
                } else {
                    avatarDiv.textContent = username.charAt(0).toUpperCase();
                }

                const infoDiv = document.createElement('div');
                infoDiv.className = 'user-result-info';
                infoDiv.innerHTML = `
                    <div class="user-result-name">${username}</div>
                    <div class="user-result-stats">${Object.keys(user.folders || {}).length} cours</div>
                `;

                resultDiv.appendChild(avatarDiv);
                resultDiv.appendChild(infoDiv);
                resultsDiv.appendChild(resultDiv);
            });
        }

        function viewUserProfile(username) {
            const user = allUsers[username];
            if (!user) return;

            document.getElementById('userProfileModal').classList.add('show');
            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileInfo').textContent = user.email || 'Membre';

            const avatarDiv = document.getElementById('profileAvatar');
            if (avatarDiv) {
                if (user.avatar) {
                    avatarDiv.innerHTML = `<img src="${user.avatar}" alt="${username}" style="width:100%;height:100%;object-fit:cover;">`;
                } else {
                    avatarDiv.innerHTML = username.charAt(0).toUpperCase();
                }
            }

            const coursesList = document.getElementById('profileCoursesList');
            coursesList.innerHTML = '';

            if (!user.folders || Object.keys(user.folders).length === 0) {
                coursesList.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Aucun cours public</p>';
                return;
            }

            Object.entries(user.folders).forEach(([catName, category]) => {
                Object.entries(category).forEach(([folderName, folder]) => {
                    const courseDiv = document.createElement('div');
                    courseDiv.className = 'course-card';
                    courseDiv.style.marginBottom = '10px';
                    courseDiv.innerHTML = `
                        <div class="course-card-left">
                            <div class="course-card-title">${folderName}</div>
                            <div class="course-card-info">${Object.keys(folder).length} listes</div>
                        </div>
                        <div class="course-card-arrow">→</div>
                    `;
                    courseDiv.onclick = () => importFromUser(username, catName, folderName);
                    coursesList.appendChild(courseDiv);
                });
            });
        }

        function closeUserProfileModal() {
            document.getElementById('userProfileModal').classList.remove('show');
        }

        function importFromUser(username, catName, folderName) {
            const user = allUsers[username];
            if (!user || !user.folders[catName] || !user.folders[catName][folderName]) return;

            const sourceFolder = user.folders[catName][folderName];

            const targetCat = prompt("Nom de la catégorie pour l'importation:", catName);
            if (!targetCat) return;

            const targetFolder = prompt("Nom du cours pour l'importation:", folderName);
            if (!targetFolder) return;

            if (!categories[targetCat]) {
                categories[targetCat] = {};
            }

            if (!categories[targetCat][targetFolder]) {
                categories[targetCat][targetFolder] = {};
            }

            Object.entries(sourceFolder).forEach(([listName, cards]) => {
                categories[targetCat][targetFolder][listName] = [...cards];
            });

            saveData();
            updateCategoryList();
            closeUserProfileModal();
            showNotification('Cours importé avec succès ✓', 'success');
        }

        function importCards() {
			const fileInput = document.getElementById('fileInput');
			if (!fileInput) {
				showNotification("Input fichier introuvable (#fileInput)", "error");
				return;
			}

			fileInput.onchange = function (e) {
				const file = e.target.files[0];
				if (!file) return;

				const reader = new FileReader();

				reader.onload = function (event) {
					try {
						const data = JSON.parse(event.target.result);

				// --- 1) Normaliser les formats encapsulés fréquents ---
						let payload = data;
						if (payload && typeof payload === "object" && !Array.isArray(payload)) {
							if (payload.data) payload = payload.data;
							if (payload.export) payload = payload.export;
							if (payload.payload) payload = payload.payload;
							if (payload.state) payload = payload.state;
						}

				// --- 2) Détection de ce qu'on importe ---
						let importedCategories = null;
						let importedCardsArray = null;

				// Formats natifs attendus
						if (payload?.categories && typeof payload.categories === "object") {
							importedCategories = payload.categories;
						} else if (payload?.folders && typeof payload.folders === "object") {
							importedCategories = payload.folders;
						} else if (Array.isArray(payload)) {
							importedCardsArray = payload;
						} else if (payload && typeof payload === "object") {
					// Formats alternatifs fréquents: {cards:[...]}, {deck:[...]}, {items:[...]} etc.
							const candidates = ["cards", "card", "items", "deck", "set", "sets", "list", "lists"];
							for (const k of candidates) {
								if (Array.isArray(payload[k])) {
									importedCardsArray = payload[k];
									break;
								}
							}
						}

						if (!importedCategories && !importedCardsArray) {
							throw new Error("Format JSON non reconnu. Attendu: {categories} / {folders} / [cartes]");
						}

				// --- 3) Appliquer l'import ---
						if (importedCategories) {
					// Choix fusion/remplacement
							const mode = (prompt("Importer en mode : 'fusion' (recommandé) ou 'remplacer' ?", "fusion") || "fusion").toLowerCase();

							const sanitized = sanitizeCategories(importedCategories);

							if (mode.startsWith("remp")) {
								categories = sanitized;
							} else {
								mergeCategories(categories, sanitized);
							}

							afterImportSuccess("Données importées avec succès ✓");
							return;
						}

				// --- 4) Cas: tableau de cartes ---
						if (importedCardsArray) {
							const catName = prompt("Nom de la catégorie :", "Import");
							const folderName = prompt("Nom du cours :", "Importé");
							const listName = prompt("Nom de la liste :", "Liste importée");
							if (!catName || !folderName || !listName) return;

							if (!categories[catName]) categories[catName] = {};
							if (!categories[catName][folderName]) categories[catName][folderName] = {};

							categories[catName][folderName][listName] = sanitizeCardsArray(importedCardsArray);

							afterImportSuccess("Cartes importées avec succès ✓");
							return;
						}

					} catch (error) {
						showNotification("Erreur lors de l'importation: " + error.message, "error");
						console.error(error);
					} finally {
						fileInput.value = "";
					}
				};

				reader.readAsText(file);
			};

			fileInput.click();

			// --- helpers internes (ou tu peux les mettre ailleurs) ---
			function afterImportSuccess(message) {
				if (currentUser) {
					currentUser.folders = categories;
					allUsers[currentUser.username] = currentUser;
					localStorage.setItem("flashcards_users", JSON.stringify(allUsers));
				}

				saveData();
				updateCategoryList();
				if (typeof updateHomeStats === "function") updateHomeStats();

				showNotification(message, "success");
			}

			function sanitizeCardsArray(arr) {
				if (!Array.isArray(arr)) return [];
				return arr
					.map(c => ({
						question: (c?.question ?? c?.q ?? c?.front ?? "").toString(),
						answer: (c?.answer ?? c?.a ?? c?.back ?? "").toString(),
						importance: (c?.importance ?? "normal").toString()
					}))
					.filter(c => c.question.trim() || c.answer.trim());
			}

			function sanitizeCategories(obj) {
				const out = {};
				if (!obj || typeof obj !== "object") return out;

				for (const [catName, folders] of Object.entries(obj)) {
					out[catName] = {};
					if (!folders || typeof folders !== "object") continue;

					for (const [folderName, lists] of Object.entries(folders)) {
						out[catName][folderName] = {};
						if (!lists || typeof lists !== "object") continue;

						for (const [listName, cards] of Object.entries(lists)) {
							out[catName][folderName][listName] = sanitizeCardsArray(cards);
						}
					}
				}
				return out;
			}

			function mergeCategories(target, incoming) {
				for (const [catName, folders] of Object.entries(incoming)) {
					if (!target[catName]) target[catName] = {};
					for (const [folderName, lists] of Object.entries(folders)) {
						if (!target[catName][folderName]) target[catName][folderName] = {};
						for (const [listName, cards] of Object.entries(lists)) {
							target[catName][folderName][listName] = cards;
						}
					}
				}
			}
		}

        function exportAll() {
            const data = {
                categories: categories,
                results: results,
                exportedAt: new Date().toISOString(),
                user: currentUser.username
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flashcards_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Exportation réussie ✓', 'success');
        }

        function exportCards() {
            if (!currentCategory || !currentFolder || !currentList) {
                showNotification('Sélectionnez d\'abord une liste', 'error');
                return;
            }

            const cards = categories[currentCategory][currentFolder][currentList];
            const data = {
                cards: cards,
                metadata: {
                    category: currentCategory,
                    folder: currentFolder,
                    list: currentList,
                    exportedAt: new Date().toISOString()
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flashcards_${currentFolder}_${currentList}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Cartes exportées ✓', 'success');
        }

        function showImportTextModal() {
            document.getElementById('importTextModal').classList.add('show');

            const catSelect = document.getElementById('importCatSelect');
            catSelect.innerHTML = '';
            Object.keys(categories).forEach(catName => {
                const option = document.createElement('option');
                option.value = catName;
                option.textContent = catName;
                catSelect.appendChild(option);
            });

            updateImportFolderSelect();
        }

        function closeImportTextModal() {
            document.getElementById('importTextModal').classList.remove('show');
        }

        function updateImportFolderSelect() {
            const catSelect = document.getElementById('importCatSelect');
            const folderSelect = document.getElementById('importFolderSelect');
            const selectedCat = catSelect.value;

            folderSelect.innerHTML = '';
            if (categories[selectedCat]) {
                Object.keys(categories[selectedCat]).forEach(folderName => {
                    const option = document.createElement('option');
                    option.value = folderName;
                    option.textContent = folderName;
                    folderSelect.appendChild(option);
                });
            }

            const newFolderOption = document.createElement('option');
            newFolderOption.value = '__new__';
            newFolderOption.textContent = '-- Nouveau cours --';
            folderSelect.appendChild(newFolderOption);
        }

        function performTextImport() {
			const catSelect = document.getElementById('importCatSelect');
			const folderSelect = document.getElementById('importFolderSelect');
			const listNameInput = document.getElementById('importListName');
			const separatorSelect = document.getElementById('importSeparator');
			const textArea = document.getElementById('importTextContent');

			if (!catSelect || !folderSelect || !listNameInput || !separatorSelect || !textArea) {
				showNotification("Import: éléments UI introuvables", "error");
				return;
			}

			const textContent = (textArea.value || '').trim();

			const catName = catSelect.value;
			const folderName = folderSelect.value;
			const listName = listNameInput.value.trim();
			const separatorValue = separatorSelect.value;

			if (!catName) return showNotification('Sélectionnez une catégorie', 'error');
			if (!listName) return showNotification('Entrez un nom pour la liste', 'error');
			if (!textContent) return showNotification('Collez du texte à importer', 'error');

			let actualFolderName = folderName;
			if (folderName === '__new__' || folderName === 'new' || folderName === '**new**') {
				actualFolderName = prompt('Nom du nouveau cours :', 'Nouveau cours');
				if (!actualFolderName) return;
				actualFolderName = actualFolderName.trim();
				if (!actualFolderName) return;
			}

			if (!categories[catName]) categories[catName] = {};
			if (!categories[catName][actualFolderName]) categories[catName][actualFolderName] = {};

			if (categories[catName][actualFolderName][listName]) {
				if (!confirm(`La liste "${listName}" existe déjà. Remplacer ?`)) return;
			}

	// 1) Séparateur robuste (tab = \t réel)
			let sepChar = '\t';
			if (separatorValue === 'tab') sepChar = '\t';
			else sepChar = separatorValue;

	// 2) Normalisation des retours lignes Windows + split
			const lines = textContent
				.replace(/\r\n/g, '\n')
				.split('\n')
				.map(l => l.trim())
				.filter(Boolean);

			const cards = [];
			for (const line of lines) {
		// split sur le 1er séparateur trouvé (évite de casser une définition qui contient le séparateur)
				const idx = line.indexOf(sepChar);
				if (idx === -1) continue;

				const q = line.slice(0, idx).trim();
				const a = line.slice(idx + sepChar.length).trim();

				if (!q && !a) continue;

				cards.push({
					question: q,
					answer: a,
					importance: 'normal'
				});
			}

			if (cards.length === 0) {
				showNotification("Aucune carte détectée. Vérifie le séparateur (Quizlet = tabulation).", "error");
				return;
			}

			categories[catName][actualFolderName][listName] = cards;

	// ✅ Persistance correcte
			if (currentUser) {
				currentUser.folders = categories;
				allUsers[currentUser.username] = currentUser;
				localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
			}
			saveData();

			updateCategoryList();
			closeImportTextModal();
			showNotification(`${cards.length} cartes importées avec succès ✓`, 'success');
		}

        function openFullscreenStudy() {
            const cards = categories[currentCategory][currentFolder][currentList];
            if (!cards || cards.length === 0) {
                showNotification('Aucune carte à étudier', 'error');
                return;
            }

            const fullscreenMode = document.getElementById('fullscreenMode');
            const fullscreenCard = document.getElementById('fullscreenCard');
            const fullscreenQuestion = document.getElementById('fullscreenQuestion');
            const fullscreenAnswer = document.getElementById('fullscreenAnswer');

            fullscreenMode.classList.add('active');
            document.body.style.overflow = 'hidden';

        	let currentFullscreenIndex = isReviewMode && reviewIndices.length > 0
  				? reviewIndices[currentIndex]
  				: studyIndices[currentIndex];

			// ✅ Si on est à la fin : résultats + sortie plein écran
			if (currentFullscreenIndex === undefined || currentFullscreenIndex >= cards.length) {
  			endStudy();
  			closeFullscreenOverlay();
  			return;
		}

            const card = cards[currentFullscreenIndex];
            fullscreenQuestion.innerHTML = card.question;
            fullscreenAnswer.innerHTML = card.answer;
            fullscreenCard.classList.remove('flipped');

			const fullscreenBadge = document.getElementById('fullscreenImportanceBadge');
			if (fullscreenBadge) {
  				const imp = (card.importance || 'normal').toLowerCase();
  				fullscreenBadge.className = 'card-importance-header ' + (imp === 'pas important' ? 'pas-important' : imp);
  				fullscreenBadge.textContent = imp;
			}
        }

        function closeFullscreenOverlay() {
  			const fullscreenMode = document.getElementById('fullscreenMode');
  			if (fullscreenMode) fullscreenMode.classList.remove('active');
  			document.body.style.overflow = 'auto';
		}

        function flipFullscreenCard() {
            const fullscreenCard = document.getElementById('fullscreenCard');
            fullscreenCard.classList.toggle('flipped');
        }

        function fullscreenAnswer(type) {
    		answer(type);          // avance à la carte suivante
    		openFullscreenStudy(); // recharge la carte courante en plein écran
   		 // surtout ne pas appeler exitFullscreen() ici
		}

        function execFormatCommand(cmd) {
            document.execCommand(cmd, false, null);
        }

        function applyColorToSelection(cmd, color) {
            document.execCommand(cmd, false, color);
        }

        function insertImage() {
            const fileInput = document.getElementById('imageInput');
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    showNotification('Veuillez sélectionner une image', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const imgUrl = event.target.result;
                    document.execCommand('insertHTML', false, `<img src="${imgUrl}" style="max-width:100%;height:auto;border-radius:8px;">`);
                };
                reader.readAsDataURL(file);
                fileInput.value = '';
            };
            fileInput.click();
        }

        function clearFormatNow() {
            document.execCommand('removeFormat', false, null);
        }

        function clearCurrentList() {
            if (!currentCategory || !currentFolder || !currentList) {
                showNotification('Sélectionnez d\'abord une liste', 'error');
                return;
            }

            if (!confirm(`Vider toutes les cartes de la liste "${currentList}" ?`)) return;

            categories[currentCategory][currentFolder][currentList] = [];
			saveUserData();
            saveData();
            loadManagePage();
            showNotification('Liste vidée ✓', 'success');
        }

        function copyFolderEmbed() {
            if (!currentCategory || !currentFolder) {
                showNotification('Sélectionnez d\'abord un cours', 'error');
                return;
            }

            const embedCode = `<iframe src="${window.location.origin}?embed=${currentUser.username}:${currentCategory}:${currentFolder}" width="800" height="600" frameborder="0"></iframe>`;

            navigator.clipboard.writeText(embedCode)
                .then(() => showNotification('Code d\'intégration copié ✓', 'success'))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = embedCode;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showNotification('Code d\'intégration copié ✓', 'success');
                });
        }

        function copyListEmbed(listName) {
            if (!currentCategory || !currentFolder || !listName) {
                showNotification('Sélectionnez d\'abord une liste', 'error');
                return;
            }

            const embedCode = `<iframe src="${window.location.origin}?embed=${currentUser.username}:${currentCategory}:${currentFolder}:${listName}" width="800" height="600" frameborder="0"></iframe>`;

            navigator.clipboard.writeText(embedCode)
                .then(() => showNotification('Code d\'intégration copié ✓', 'success'))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = embedCode;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showNotification('Code d\'intégration copié ✓', 'success');
                });
        }

        function deleteAccount() {
            if (!confirm('⚠️ ATTENTION: Cette action est irréversible. Toutes vos données seront supprimées. Continuer ?')) return;

            if (!currentUser) return;

            delete allUsers[currentUser.username];
            localStorage.setItem('flashcards_users', JSON.stringify(allUsers));

            const userResultsKey = `flashcards_results_${currentUser.username}`;
            localStorage.removeItem(userResultsKey);

            const openDataKey = `flashcards_open_${currentUser.username}`;
            localStorage.removeItem(openDataKey);

            localStorage.removeItem('current_user');
            location.reload();
        }

        // ====== INITIALISATION ======
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser le comparateur
            document.getElementById('compareBtn').addEventListener('click', function() {
                const oldText = document.getElementById('oldText').value;
                const newText = document.getElementById('newText').value;

                if (!oldText || !newText) {
                    showNotification('Veuillez entrer les deux textes à comparer', 'error');
                    return;
                }

                const diff = Diff.diffWords(oldText, newText);
                let output = '';
                let insCount = 0;
                let delCount = 0;
                let repCount = 0;

                diff.forEach(part => {
                    if (part.added) {
                        output += `<mark class="ins">${part.value}</mark>`;
                        insCount++;
                    } else if (part.removed) {
                        output += `<mark class="del">${part.value}</mark>`;
                        delCount++;
                    } else {
                        output += part.value;
                    }
                });

                document.getElementById('diffOutput').innerHTML = output;
                document.getElementById('insCount').textContent = insCount;
                document.getElementById('delCount').textContent = delCount;
                document.getElementById('repCount').textContent = Math.min(insCount, delCount);
            });

            document.getElementById('copyBtn').addEventListener('click', function() {
                const diffOutput = document.getElementById('diffOutput').innerHTML;
                navigator.clipboard.writeText(diffOutput)
                    .then(() => showNotification('Comparaison copiée ✓', 'success'))
                    .catch(() => showNotification('Erreur lors de la copie', 'error'));
            });

            // Initialiser les événements des boutons de retour
            document.getElementById('backToLists').addEventListener('click', function() {
                showPage('lists');
            });

            document.getElementById('backToListsStudy').addEventListener('click', function() {
                showPage('lists');
            });

            // Initialiser l'upload d'avatar
            document.getElementById('avatarInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    showNotification('Veuillez sélectionner une image', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    currentUser.avatar = event.target.result;
                    allUsers[currentUser.username] = currentUser;
                    localStorage.setItem('flashcards_users', JSON.stringify(allUsers));
                    localStorage.setItem('current_user', JSON.stringify(currentUser));

                    const avatarPreview = document.getElementById('avatarPreview');
                    if (avatarPreview) {
                        avatarPreview.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
                    }

                    const userAvatar = document.getElementById('userAvatar');
                    if (userAvatar) {
                        userAvatar.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
                    }

                    showNotification('Photo de profil mise à jour ✓', 'success');
                };
                reader.readAsDataURL(file);
            });
        });
    </script>
</body>
</html>
