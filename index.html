<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards + Comparateur</title>
    <style>
        :root {
            /* Couleurs principales du th√®me */
            --bg-gradient-from: #667eea;
            --bg-gradient-to: #764ba2;
            --primary: #667eea;
            --primary-2: #764ba2;
            --accent: #11998e;
            --accent-2: #38ef7d;
            --danger: #ff6b6b;
            --text: #333333;
            --text-soft: #666666;
            --panel: #ffffff;
            --panel-muted: #f5f7fa;
            --border: #e0e0e0;
            --shadow: rgba(0,0,0,0.08);
            /* Cartes d'√©tude */
            --card-bg: #ffffff;
            --card-grad-from: #f5f7fa;
            --card-grad-to: #c3cfe2;
            /* Stats */
            --known: #38ef7d;
            --partial: #f5a623;
            --unknown: #ff6b6b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-from) 0%, var(--bg-gradient-to) 100%);
            min-height: 100vh;
            display: flex;
            color: var(--text);
        }
       
        .sidebar {
            width: 280px;
            background: var(--panel);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 100;
            transition: transform 0.3s ease;
            border-right: 1px solid var(--border);
        }
        .sidebar.hidden { transform: translateX(-280px); }
       
        .sidebar-header {
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
            color: white;
        }
        .sidebar-header h1 { font-size: 22px; margin-bottom: 5px; }
        .sidebar-header p { font-size: 13px; opacity: 0.9; }
       
        .sidebar-nav { padding: 20px; border-bottom: 2px solid var(--border); }
        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; font-weight: 500; color: var(--text); }
        .nav-item:hover { background: var(--panel-muted); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; }
       
        .folder-section { flex: 1; overflow-y: auto; padding: 20px; background: var(--panel); }
        .folder-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .folder-section-header h3 { font-size: 14px; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.5px; }
       
        .btn-new-folder, .btn-new-category { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s; }
        .btn-new-folder:hover, .btn-new-category:hover { filter: brightness(90%); }
        .btn-new-category { background: var(--accent); }
       
        .category-item { margin-bottom: 10px; }
        .category-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: var(--panel-muted); border-radius: 6px; cursor: pointer; transition: all 0.3s; color: var(--text); }
        .category-header:hover { background: var(--border); }
        .category-header.active { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: white; }
        .category-left { display: flex; align-items: center; gap: 8px; flex: 1; }
        .category-toggle { font-size: 12px; transition: transform 0.3s; }
        .category-toggle.open { transform: rotate(90deg); }
        .category-name { font-weight: 600; font-size: 14px; }
        .category-count { background: rgba(0,0,0, 0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; color: inherit; margin-left: 5px; }
        .category-actions { display: flex; gap: 5px; opacity: 0; transition: all 0.3s; }
        .category-header:hover .category-actions { opacity: 1; }
       
        .btn-edit-category, .btn-delete-category { background: none; border: none; color: var(--text-soft); cursor: pointer; font-size: 14px; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .category-header.active .btn-edit-category, .category-header.active .btn-delete-category { color: rgba(255, 255, 255, 0.8); }
        .btn-edit-category:hover { color: var(--primary); }
        .category-header.active .btn-edit-category:hover { color: white; }
        .btn-delete-category:hover { color: var(--danger); }
       
        .category-folders { padding-left: 15px; margin-top: 5px; display: none; }
        .category-folders.open { display: block; }
       
        .folder-item { padding: 10px 15px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: space-between; color: var(--text); }
        .folder-item:hover { background: var(--panel-muted); }
        .folder-item.active { background: var(--panel-muted); color: var(--primary); font-weight: 600; border: 1px solid var(--primary); }
        .folder-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .folder-badge { background: rgba(0,0,0, 0.05); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; color: var(--text-soft); }
        .folder-item.active .folder-badge { background: rgba(102, 126, 234, 0.2); color: var(--primary); }
        .folder-actions { display: flex; gap: 5px; opacity: 0; transition: all 0.3s; }
        .folder-item:hover .folder-actions { opacity: 1; }
        .btn-edit-folder, .btn-delete-folder { background: none; border: none; color: var(--text-soft); cursor: pointer; font-size: 14px; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .btn-edit-folder:hover { color: var(--primary); }
        .btn-delete-folder:hover { color: var(--danger); }
       
        .toggle-sidebar-btn { position: fixed; left: 290px; top: 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); border: none; color: white; width: 48px; height: 48px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 101; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .toggle-sidebar-btn:hover { transform: translateY(-2px) scale(1.05); }
        .toggle-sidebar-btn.sidebar-hidden { left: 10px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .toggle-icon { transition: transform 0.3s ease; display: inline-block; }
        .toggle-sidebar-btn.sidebar-hidden .toggle-icon { transform: rotate(180deg); }
       
        .main-content { margin-left: 280px; flex: 1; padding: 40px; overflow-y: auto; height: 100vh; transition: margin-left 0.3s ease; }
        .main-content.sidebar-hidden { margin-left: 0; }
       
        .container { background: var(--panel); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 40px; max-width: 800px; margin: 0 auto; color: var(--text); }
       
        .app-header { background: var(--panel); border-radius: 20px 20px 0 0; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px 40px; max-width: 800px; margin: 0 auto 20px auto; display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { margin: 0; font-size: 22px; color: var(--text); }
        .app-header p { margin: 0; font-size: 13px; color: var(--text-soft); }
       
        .btn-comparator { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: white; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s; margin-left: 10px; }
        .btn-comparator:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
       
        .home-page { text-align: center; }
        .home-hero { padding: 60px 40px; }
        .home-hero h1 { font-size: 48px; color: var(--text); margin-bottom: 20px; }
        .home-hero p { font-size: 18px; color: var(--text-soft); line-height: 1.6; margin-bottom: 10px; }
       
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .stat-card { background: linear-gradient(135deg, var(--panel-muted) 0%, #e0e7ff 100%); padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .stat-card-value { font-size: 36px; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
        .stat-card-label { font-size: 14px; color: var(--text-soft); font-weight: 500; }
       
        .quick-actions { margin-top: 40px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn-action { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-action-secondary { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .btn-export-all { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #111; border: none; border-radius: 10px; padding: 15px 30px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-export-all:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
       
        .recent-courses { margin-top: 50px; text-align: left; }
        .recent-courses h2 { font-size: 24px; color: var(--text); margin-bottom: 20px; }
        .course-list { display: flex; flex-direction: column; gap: 15px; }
        .course-card { background: var(--panel-muted); padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .course-card:hover { background: #e8ebff; transform: translateX(5px); }
        .course-card-left { flex: 1; }
        .course-card-title { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 5px; }
        .course-card-info { font-size: 14px; color: var(--text-soft); }
        .course-card-arrow { font-size: 24px; color: var(--primary); }
       
        .lists-page h2 { color: var(--text); margin-bottom: 10px; font-size: 28px; display: inline-block; }
        .lists-page-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .btn-edit-page-title { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.3s; }
        .lists-page-subtitle { color: var(--text-soft); font-size: 14px; margin-bottom: 30px; }
        .lists-grid { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
        .list-card { background: linear-gradient(135deg, var(--panel-muted) 0%, #e0e7ff 100%); padding: 25px 30px; border-radius: 15px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); position: relative; display: flex; justify-content: space-between; align-items: center; }
        .list-card:hover { transform: translateX(5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
        .list-card-left { flex: 1; }
        .list-card-title { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
        .list-card-count { font-size: 14px; color: var(--text-soft); margin-bottom: 5px; }
        .list-card-progress { font-size: 13px; color: var(--primary); font-weight: 600; }
        .list-card-actions { display: flex; gap: 12px; }
        .btn-list-action { padding: 15px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; color: white; min-width: 140px; }
        .btn-study { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); }
        .btn-manage { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .list-card-buttons { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0; transition: all 0.3s; }
        .list-card:hover .list-card-buttons { opacity: 1; }
        .btn-edit-list, .btn-delete-list, .btn-embed { background: rgba(255, 255, 255, 0.9); border: none; color: var(--primary); cursor: pointer; font-size: 11px; padding: 4px 7px; border-radius: 3px; transition: all 0.3s; line-height: 1; }
        .btn-edit-list:hover, .btn-embed:hover { background: var(--primary); color: white; }
        .btn-delete-list { color: var(--danger); }
        .btn-delete-list:hover { background: var(--danger); color: white; }
        .btn-new-list { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; }
       
        .manage-cards-page h2 { color: var(--text); margin-bottom: 10px; font-size: 28px; }
        .breadcrumb { color: var(--text-soft); font-size: 14px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .breadcrumb a { color: var(--primary); text-decoration: none; cursor: pointer; }
        .manage-section { margin-bottom: 40px; }
        .manage-section h3 { font-size: 20px; color: var(--text); margin-bottom: 15px; }
        .cards-list { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .card-edit-item { background: var(--panel-muted); padding: 20px; border-radius: 12px; border: 2px solid transparent; transition: all 0.3s; }
        .card-edit-item:hover { border-color: var(--primary); }
        .card-edit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-edit-number { font-size: 14px; font-weight: 600; color: var(--primary); }
        .btn-delete-card { background: var(--danger); color: white; padding: 5px 12px; border: none; border-radius: 5px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-edit-card { background: var(--primary); color: white; padding: 5px 12px; border: none; border-radius: 5px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .card-inline-editor { margin-top: 12px; padding: 14px; border: 2px dashed var(--border); border-radius: 10px; background: var(--panel); }
        .card-inline-editor .actions { display: flex; gap: 8px; margin-top: 10px; }
        .btn-save-card { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: #fff; border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
        .btn-cancel-card { background: var(--border); color: var(--text); border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer; }
        .btn-edit-current { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: #fff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; }
       
        .card-edit-content { display: flex; flex-direction: column; gap: 10px; }
        .card-edit-text { font-size: 14px; color: var(--text); }
        .card-edit-label { font-weight: 600; color: var(--text-soft); margin-right: 5px; }
        .editor-toolbar {
	display: flex;
	gap: 6px;                /* avant: 5px */
	margin-bottom: 10px;
	flex-wrap: wrap;
	padding: 8px;            /* avant: 10px */
	background: var(--panel-muted);
	border-radius: 8px;
	border: 1px solid var(--border); /* avant: 2px */
	align-items: center;
}
.editor-btn{
	font-size: 12px !important;
	padding: 4px 8px !important;
	border-width: 1px !important;
	line-height: 1 !important;
	min-width: 0 !important;
	min-height: 0 !important;
}
        .editor-btn:hover { background: var(--primary); color: white; }
        .editor-content { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; font-family: inherit; min-height: 120px; resize: vertical; overflow-y: auto; background: var(--panel); color: var(--text); }
        .editor-content:focus { outline: none; border-color: var(--primary); }
        .empty-cards-message { text-align: center; padding: 40px; color: var(--text-soft); font-size: 16px; }
       
        .study-page h2 { color: var(--text); margin-bottom: 20px; font-size: 28px; }
        .study-mode-indicator { display: inline-block; background: var(--partial); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .study-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .progress-bar { background: var(--border); height: 8px; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, var(--primary), var(--primary-2)); height: 100%; transition: width 0.3s ease; }
       
        .card-container { perspective: 1000px; margin-bottom: 30px; }
        .card { background: transparent; border-radius: 15px; min-height: 300px; max-height: 500px; cursor: pointer; transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
        .card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 40px; overflow-y: auto; overflow-x: hidden; background: var(--card-bg); border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); color: var(--text); }
        .card-back { transform: rotateY(180deg); }
        .card-text { font-size: 24px; color: var(--text); font-weight: 500; line-height: 1.5; width: 100%; text-align: center; }
        .card-text img { max-width: 100%; height: auto; display: inline-block; margin: 5px; border-radius: 8px; vertical-align: middle; }
       
        .buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        button { padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; color: white; flex: 1; min-width: 150px; }
        .btn-known { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .btn-partial { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .btn-unknown { background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%); }
        .stats { text-align: center; margin-top: 20px; color: var(--text-soft); font-size: 14px; }
        .flip-hint { text-align: center; color: var(--text-soft); font-size: 14px; margin-bottom: 20px; font-style: italic; }
       
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text); font-weight: 600; }
        .input-group input[type="text"], .input-group input[type="color"] {
	width: 100%;
	padding: 8px 10px;       /* avant: 12px 15px */
	border: 2px solid var(--border);
	border-radius: 8px;
	font-size: 14px;         /* avant: 16px */
	font-family: inherit;
	background: var(--panel);
	color: var(--text);
	box-sizing: border-box;
}
        .input-group input[type="text"]:focus { outline: none; border-color: var(--primary); }
        .input-group select {
	width: 100%;
	padding: 8px 10px;       /* avant: 12px 15px */
	border: 2px solid var(--border);
	border-radius: 8px;
	font-size: 14px;         /* avant: 16px */
	font-family: inherit;
	background: var(--panel);
	color: var(--text);
	box-sizing: border-box;
	cursor: pointer;
}
        .btn-add { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); width: 100%; margin-top: 10px; }
       
        .end-message { text-align: center; padding: 40px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; }
        .end-message h2 { color: var(--text); margin-bottom: 30px; }
       
        .stat-bar-track { width: 100%; height: 30px; background: var(--panel-muted); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .stat-bar-fill-known { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .stat-bar-fill-partial { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .stat-bar-fill-unknown { background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%); }
        .legend-known { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .legend-partial { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .legend-unknown { background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%); }
       
        .btn-restart { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); }
        .btn-review { background: linear-gradient(135deg, var(--partial) 0%, #f7b733 100%); }
        .btn-next-list { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); }
        .btn-export { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn-clear { background: linear-gradient(135deg, var(--danger) 0%, #ee5a6f 100%); }
       
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 15px; max-width: 400px; width: 90%; position: relative; z-index: 1001; color: var(--text); }
        .modal-header { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text); }
        .btn-cancel { background: var(--border); color: var(--text); }
        .btn-cancel:hover { filter: brightness(90%); }
       
        .page { display: none; }
        .page.active { display: block; }
        #fileInput, #imageInput { display: none; }
       
        /* THEME MODAL SPECIFIC */
        #themeModal { z-index: 3000; }
        #themeModal .modal-content { max-height: 80vh; overflow: auto; }
        #themeModal .input-group input[type="color"] {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 48px; height: 36px;
            padding: 0;
        }
       
        /* COMPARATOR STYLES */
        #comparatorModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow: auto; }
        #comparatorModal.show { display: block; }
        .comparator-container { background: #0b0c0f; color: #e8ecf3; min-height: 100vh; padding: 20px; }
        .comparator-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #23262d; background: #14161a; margin-bottom: 20px; border-radius: 10px; }
        .btn-close-comparator { background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .comparator-main { display: grid; grid-template-columns: 1fr 360px; gap: 20px; }
        .comparator-aside { background: #14161a; border-radius: 12px; padding: 16px; }
        .comp-panel { background: #14161a; border: 1px solid #23262d; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .comp-panel h2 { margin: 0; padding: 12px 14px; border-bottom: 1px solid #23262d; font-size: 16px; }
        #diffOutput { padding: 14px; white-space: pre-wrap; word-break: break-word; }
        .comp-controls { display: grid; gap: 12px; padding: 12px; border: 1px solid #23262d; background: #14161a; border-radius: 12px; }
        .comp-controls textarea { width: 100%; min-height: 120px; resize: vertical; background: #0e1014; border: 1px solid #2a2f39; border-radius: 8px; color: #e8ecf3; padding: 10px; font-family: inherit; }
        .comp-controls label { font-weight: 600; margin-bottom: 6px; display: block; color: #e8ecf3; }
        .comp-controls button { background: #5b8cff; color: white; border: 0; border-radius: 8px; padding: 10px 12px; font-weight: 600; cursor: pointer; }
        .comp-controls button.secondary { background: #2a2f39; }
        .comp-split { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        mark.ins, mark.del { background: transparent; border-radius: 4px; color: #fff; padding: 0 2px; border: 1px solid; }
        mark.ins { box-shadow: inset 0 -0.45em rgba(31,191,71,0.4); border-color: rgba(31,191,71,0.7); }
        mark.del { box-shadow: inset 0 -0.45em rgba(255,92,92,0.35); border-color: rgba(255,92,92,0.7); text-decoration: line-through; }
        mark.focused { box-shadow: inset 0 -0.48em rgba(255,209,102,0.9), 0 0 0 2px rgba(255,209,102,0.25) !important; border-color: rgba(255,209,102,0.85) !important; background: rgba(255,209,102,0.2) !important; }
        .comp-change.selected { border-color: #ffd166 !important; box-shadow: 0 0 0 2px rgba(255,209,102,0.25) !important; background: rgba(255,209,102,0.1); }
        .comp-summary { padding: 12px; border-bottom: 1px solid #23262d; }
        .comp-change { display: block; text-align: left; width: 100%; background: transparent; border: 1px solid #2a2f39; border-radius: 10px; color: #e8ecf3; padding: 10px; margin: 8px 0; cursor: pointer; }
        .comp-change:hover { border-color: #ffd166; }
        .comp-change.selected { border-color: #ffd166; box-shadow: 0 0 0 2px rgba(255,209,102,0.25); }
        .comp-change .type { font-weight: 700; margin-bottom: 6px; display: block; }
        .comp-change .token { display: inline; color: #fff; padding: 0 1px; border-radius: 4px; border: 1px solid; }
        .comp-change .token { box-shadow: inset 0 -0.35em rgba(31,191,71,0.4); border-color: rgba(31,191,71,0.7); }
        .comp-change .token.del { box-shadow: inset 0 -0.35em rgba(255,92,92,0.35); border-color: rgba(255,92,92,0.7); text-decoration: none; }
        .comp-change .ctx { color: #8b93a6; display: block; margin-top: 6px; font-size: 12px; }
        #backToSelected { position: fixed; right: 390px; bottom: 20px; z-index: 2001; background: #ffd166; color: #111; border: 0; border-radius: 999px; padding: 10px 14px; font-weight: 800; cursor: pointer; box-shadow: 0 6px 18px rgba(0,0,0,0.35); display: none; }
        #backToSelected.visible { display: inline-flex; }
        #backToSelected:hover { filter: brightness(0.95); }
        .del-ghost { display: inline-block; margin: 0 2px; color: #fff; }
        .del-ghost mark.del { text-decoration: none; box-shadow: inset 0 -0.45em rgba(255,92,92,0.35); border-color: rgba(255,92,92,0.7); }
        .focus-ghost { display: inline-block; width: 10px; height: 1.2em; vertical-align: baseline; box-shadow: inset 0 -0.48em rgba(255,209,102,0.9), 0 0 0 2px rgba(255,209,102,0.25); border: 1px dashed rgba(255,209,102,0.85); border-radius: 4px; }
        .comp-change .token { box-shadow: inset 0 -0.35em rgba(34,197,94,0.7); border-color: rgba(34,197,94,1); background: rgba(34,197,94,0.15); }
        mark.ins { box-shadow: inset 0 -0.45em rgba(34,197,94,0.6); border-color: rgba(34,197,94,0.9); }
        @media (max-width: 1000px) { .comparator-main { grid-template-columns: 1fr; } #backToSelected { right: 12px; bottom: 12px; } }
        .btn-filter-del { background: #2a2f39; color: #e8ecf3; border: 0; border-radius: 8px; padding: 8px 10px; font-weight: 700; cursor: pointer; }
        .btn-filter-del.active { background: #ff6b6b; color: #fff; }
        /* GIF de f√©licitations en fin de session */
        .result-gif {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        .result-gif img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        .result-gif.show { display: block; }
    </style>
</head>
<body>
    <button class="toggle-sidebar-btn" id="toggleSidebarBtn" onclick="toggleSidebar()"><span class="toggle-icon">‚óÄ</span></button>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><h1>üìö Flashcards</h1><p>Syst√®me d'apprentissage</p></div>
    <div class="sidebar-nav"><div class="nav-item active" onclick="showPage('home')"><span>üè†</span><span>Accueil</span></div></div>
    <div class="folder-section">
        <div class="folder-section-header">
            <h3>Organisation</h3>
            <div class="folder-section-buttons">
                <button class="btn-new-category" onclick="showNewCategoryModal()" title="Nouvelle cat√©gorie">üìÅ</button>
                <button class="btn-new-folder" onclick="showNewFolderModal()" title="Nouveau cours">+</button>
            </div>
        </div>
        <div id="categoryList"></div>
    </div>
</div>
<div class="main-content" id="mainContent">
    <div class="app-header" style="padding:10px 40px;">
        <button class="btn-comparator" onclick="openComparator()">
            üîç Comparateur de texte
        </button>
        <button class="btn-comparator" onclick="openThemeModal()">üé® Th√®me</button>
    </div>
    <div id="homePage" class="page active">
        <div class="container home-page">
            <div class="home-hero"><h1>Bienvenue ! üëã</h1><p>Apprends efficacement avec ton syst√®me de flashcards.</p></div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-card-value" id="totalCourses">0</div><div class="stat-card-label">Cours cr√©√©s</div></div>
                <div class="stat-card"><div class="stat-card-value" id="totalCards">0</div><div class="stat-card-label">Cartes totales</div></div>
            </div>
            <div class="quick-actions">
                <button class="btn-action" onclick="showNewFolderModal()">‚ûï Cr√©er un cours</button>
                <button class="btn-action btn-action-secondary" onclick="importCards()">üì• Importer</button>
                <button class="btn-export-all" onclick="exportAll()">üì¶ Exporter tout</button>
            </div>
            <div class="recent-courses"><h2>Mes cours</h2><div class="course-list" id="courseList"></div></div>
        </div>
    </div>
    <div id="listsPage" class="page">
        <div class="container lists-page">
            <div class="lists-page-header"><h2 id="listsTitle">Cours</h2><button class="btn-edit-page-title" onclick="showRenameFolderModal()">‚úèÔ∏è</button><button class="btn-edit-page-title" title="Int√©grer ce cours" onclick="copyFolderEmbed()">üîó</button></div>
            <p class="lists-page-subtitle">S√©lectionne une liste √† r√©viser</p>
            <div class="lists-grid" id="listsGrid"></div>
            <button class="btn-new-list" onclick="showNewListModal()">‚ûï Cr√©er une nouvelle liste</button>
        </div>
    </div>
<div id="manageCardsPage" class="page">
    <div class="container manage-cards-page">
        <div class="breadcrumb"><a id="backToLists">‚Üê Retour aux listes</a></div>
        <h2 id="manageTitle">G√©rer les cartes</h2>
        
        <div class="manage-section">
            <!-- Disposition en deux colonnes -->
            <div style="display: grid; grid-template-columns: 1fr 110px; gap: 15px; margin-bottom: 25px;">
                <!-- Colonne gauche : √âditeurs c√¥te √† c√¥te avec num√©rotation -->
                <div>
                    <h3 style="margin-bottom: 12px; color: var(--text); font-size: 15px;">Ajouter une carte</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <!-- Recto - TERME -->
                        <div class="input-group">
                            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                <div style="background: var(--primary); color: white; width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; margin-right: 5px;">1</div>
                                <label style="font-weight: 600; color: var(--text); font-size: 13px;">TERME</label>
                            </div>
                            <div class="editor-content" id="newQuestion" contenteditable="true" style="height: 100px; border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 13px; background: var(--panel); overflow-y: auto; resize: vertical; line-height: 1.4;"></div>
                        </div>
                        
                        <!-- Verso - D√âFINITION -->
                        <div class="input-group">
                            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                <div style="background: var(--primary); color: white; width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; margin-right: 5px;">2</div>
                                <label style="font-weight: 600; color: var(--text); font-size: 13px;">D√âFINITION</label>
                            </div>
                            <div class="editor-content" id="newAnswer" contenteditable="true" style="height: 100px; border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 13px; background: var(--panel); overflow-y: auto; resize: vertical; line-height: 1.4;"></div>
                        </div>
                    </div>
                    
                    <!-- Bouton Ajouter -->
                    <button class="btn-add" onclick="addCard()" style="margin-top: 8px; padding: 8px 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; border: none; border-radius: 5px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <span>‚ûï</span>
                        <span>Ajouter la carte</span>
                    </button>
                </div>
                
                <!-- Colonne droite : Options tr√®s compactes -->
                <div>
                    <div style="background: var(--panel-muted); padding: 8px; border-radius: 6px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 4px;">
                        <!-- Titre FORMAT -->
                        <div style="font-size: 11px; color: var(--text-soft); font-weight: 600; text-align: center; margin-bottom: 2px; text-transform: uppercase;">
                            FORMAT
                        </div>
                        
                        <!-- Boutons G I S -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; margin-bottom: 4px;">
                            <button class="editor-btn" onclick="formatText('bold','Q')" title="Gras" aria-label="Gras"><b>G</b></button>
							<button class="editor-btn" onclick="formatText('italic','Q')" title="Italique" aria-label="Italique"><i>I</i></button>
							<button class="editor-btn" onclick="formatText('underline','Q')" title="Soulign√©" aria-label="Soulign√©"><u>S</u></button>
                        </div>
                        
                        <!-- Couleurs -->
                        <div style="margin-bottom: 4px;">
                            <div style="font-size: 9px; color: var(--text-soft); margin-bottom: 2px; text-align: center;">Couleurs</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px;">
                                <div>
                                    <div style="font-size: 8px; color: var(--text-soft); margin-bottom: 1px; text-align: center;">Texte</div>
                                    <input type="color" id="textColorQ" value="#000000" title="Couleur du texte" style="width: 100%; height: 22px; border: 1px solid var(--border); border-radius: 2px; cursor: pointer; padding: 0;">
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-soft); margin-bottom: 1px; text-align: center;">Fond</div>
                                    <input type="color" id="bgColorQ" value="#ffff00" title="Couleur de fond" style="width: 100%; height: 22px; border: 1px solid var(--border); border-radius: 2px; cursor: pointer; padding: 0;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Niveau d'importance -->
                        <div style="margin-bottom: 4px;">
                            <div style="font-size: 9px; color: var(--text-soft); margin-bottom: 2px; text-align: center;">Importance</div>
                            <select id="importanceSelect" style="width: 100%; padding: 3px 4px; border: 1px solid var(--border); border-radius: 2px; font-size: 10px; background: var(--panel); cursor: pointer; height: 22px;">
                                <option value="important">Important</option>
                                <option value="normal" selected>Normal</option>
                                <option value="pas important">Pas important</option>
                                <option value="explication">Explication</option>
                            </select>
                        </div>
                        
                        <!-- Boutons Image et Effacer -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-top: 2px;">
                            <button class="editor-btn" onclick="insertImage('Q')" style="padding: 3px; font-size: 9px; height: 22px; display: flex; align-items: center; justify-content: center; gap: 2px; border: 1px solid var(--border); border-radius: 2px; background: var(--panel);">
                                <span>üñºÔ∏è</span>
                                <span style="font-size: 8px;">Image</span>
                            </button>
                            <button class="editor-btn" onclick="clearFormat('Q')" title="Effacer la mise en forme" aria-label="Effacer la mise en forme">‚úñ</button>
                                <span>‚úñ</span>
                                <span style="font-size: 8px;">Effacer</span>
                            </button>
                        </div>
                        
                        <!-- Indication -->
                        <div style="margin-top: 4px; padding: 3px; background: var(--panel); border-radius: 2px; border: 1px dashed var(--border);">
                            <p style="font-size: 7px; color: var(--text-soft); text-align: center; line-height: 1.1; margin: 0;">
                                S√©lectionnez du texte<br>puis cliquez
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="manage-section">
            <h3 style="margin-bottom: 10px; color: var(--text); font-size: 15px;">üìã Cartes existantes (<span id="cardCount">0</span>)</h3>
            <div class="cards-list" id="cardsList"></div>
        </div>
        
        <div class="save-section" style="margin-top: 25px; padding-top: 12px; border-top: 1px solid var(--border);">
            <h2 style="margin-bottom:10px;color:var(--text); font-size: 15px;">üíæ Gestion des cartes</h2>
            <div class="save-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn-export" onclick="exportCards()" style="padding: 6px 12px; font-size: 12px; border-radius: 3px; height: 30px;">üì• Exporter</button>
                <button class="btn-clear" onclick="clearCurrentList()" style="padding: 6px 12px; font-size: 12px; border-radius: 3px; height: 30px;">üóëÔ∏è Vider</button>
                <button class="btn-action" onclick="importCards()" style="padding: 6px 12px; font-size: 12px; border-radius: 3px; height: 30px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);">üì• Importer JSON</button>
                <button class="btn-action btn-action-secondary" onclick="showImportTextModal()" style="padding: 6px 12px; font-size: 12px; border-radius: 3px; height: 30px;">üìã Importer Texte/CSV</button>
            </div>
        </div>
    </div>
</div>
    <div id="studyPage" class="page">
        <div class="container study-page">
            <div class="breadcrumb"><a id="backToListsStudy">‚Üê Retour aux listes</a></div>
            <div class="study-controls"> <div> <h2 id="studyTitle" style="display:inline">Liste</h2> <span id="studyModeIndicator" class="study-mode-indicator" style="display:none">üîÑ Mode r√©vision</span> </div> <button class="btn-edit-current" id="btnEditCurrent" onclick="editCurrentCard()">‚úèÔ∏è √âditer cette carte</button></div>
            <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
            <div id="cardSection">
                <div class="flip-hint">üëÜ Clique pour retourner (molette pour scroller)</div>
                <div class="card-container">
                    <div class="card" id="flashcard" onclick="flipCard()">
                        <div class="card-face card-front"><div class="card-text" id="question"></div></div>
                        <div class="card-face card-back"><div class="card-text" id="answer"></div></div>
                    </div>
                </div>
                <div class="buttons">
                    <button class="btn-known" onclick="answer('known')">‚úì Connu</button>
                    <button class="btn-partial" onclick="answer('partial')">~ Partiellement</button>
                    <button class="btn-unknown" onclick="answer('unknown')">‚úó Pas connu</button>
                </div>
                <div class="stats" id="stats"></div>
            </div>
            <div id="emptyState" class="empty-state" style="display:none"><div class="empty-state-icon">üìù</div><h3>Aucune carte</h3></div>
            <div id="endSection" style="display:none">
                <div class="end-message">
                    <h2>üéâ Session termin√©e !</h2>
                    <div class="chart-container">
                        <div class="stat-bar-container">
                            <div class="stat-bar-item">
                                <div class="stat-bar-label"><div class="stat-bar-label-left"><div class="stat-bar-icon legend-known"></div><span id="legendKnown">Connu: 0 (0%)</span></div></div>
                                <div class="stat-bar-track"><div class="stat-bar-fill stat-bar-fill-known" id="barKnown" style="width:0%">0</div></div>
                            </div>
                            <div class="stat-bar-item">
                                <div class="stat-bar-label"><div class="stat-bar-label-left"><div class="stat-bar-icon legend-partial"></div><span id="legendPartial">Partiel: 0 (0%)</span></div></div>
                                <div class="stat-bar-track"><div class="stat-bar-fill stat-bar-fill-partial" id="barPartial" style="width:0%">0</div></div>
                            </div>
                            <div class="stat-bar-item">
                                <div class="stat-bar-label"><div class="stat-bar-label-left"><div class="stat-bar-icon legend-unknown"></div><span id="legendUnknown">Pas connu: 0 (0%)</span></div></div>
                                <div class="stat-bar-track"><div class="stat-bar-fill stat-bar-fill-unknown" id="barUnknown" style="width:0%">0</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="quick-actions">
    <button class="btn-action" onclick="showNewFolderModal()">‚ûï Cr√©er un cours</button>
    <button class="btn-action btn-action-secondary" onclick="showImportTextModal()">üìã Importer (Texte/CSV)</button>
    <button class="btn-action btn-action-secondary" onclick="importCards()">üì• Restaurer (JSON)</button>
    <button class="btn-export-all" onclick="exportAll()">üì¶ Exporter tout</button>
</div>
                    <div id="resultGif" class="result-gif"><img id="resultGifImg" src="" alt="Bravo !"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="file" id="fileInput" accept=".json">
<input type="file" id="imageInput" accept="image/*">
<div class="modal" id="newCategoryModal"><div class="modal-content"><div class="modal-header">Nouvelle cat√©gorie</div><div class="input-group"><label for="categoryNameInput">Nom de la cat√©gorie :</label><input type="text" id="categoryNameInput" placeholder="Ex: Droit S3"></div><div class="modal-buttons"><button class="btn-cancel" onclick="closeNewCategoryModal()">Annuler</button><button class="btn-add" onclick="createCategory()">Cr√©er</button></div></div></div>
<div class="modal" id="newFolderModal"><div class="modal-content"><div class="modal-header">Nouveau cours</div><div class="input-group"><label for="folderCategorySelect">Cat√©gorie :</label><select id="folderCategorySelect"></select></div><div class="input-group"><label for="folderNameInput">Nom du cours :</label><input type="text" id="folderNameInput" placeholder="Ex: Droit Administratif"></div><div class="modal-buttons"><button class="btn-cancel" onclick="closeNewFolderModal()">Annuler</button><button class="btn-add" onclick="createFolder()">Cr√©er</button></div></div></div>
<div class="modal" id="newListModal"><div class="modal-content"><div class="modal-header">Nouvelle liste</div><div class="input-group"><label for="listNameInput">Nom de la liste :</label><input type="text" id="listNameInput" placeholder="Ex: Chapitre 1"></div><div class="modal-buttons"><button class="btn-cancel" onclick="closeNewListModal()">Annuler</button><button class="btn-add" onclick="createList()">Cr√©er</button></div></div></div>
<div class="modal" id="renameCategoryModal"><div class="modal-content"><div class="modal-header">Renommer la cat√©gorie</div><div class="input-group"><label for="renameCategoryInput">Nouveau nom :</label><input type="text" id="renameCategoryInput" placeholder="Nouveau nom"></div><div class="modal-buttons"><button class="btn-cancel" onclick="closeRenameCategoryModal()">Annuler</button><button class="btn-add" onclick="renameCategory()">Renommer</button></div></div></div>
<div class="modal" id="renameFolderModal"><div class="modal-content"><div class="modal-header">Renommer le cours</div><div class="input-group"><label for="renameFolderInput">Nouveau nom :</label><input type="text" id="renameFolderInput" placeholder="Nouveau nom du cours"></div><div class="modal-buttons"><button class="btn-cancel" onclick="closeRenameFolderModal()">Annuler</button><button class="btn-add" onclick="renameFolder()">Renommer</button></div></div></div>
<div class="modal" id="renameListModal"><div class="modal-content"><div class="modal-header">Renommer la liste</div><div class="input-group"><label for="renameListInput">Nouveau nom :</label><input type="text" id="renameListInput" placeholder="Nouveau nom de la liste"></div><div class="modal-buttons"><button class="btn-cancel" onclick="closeRenameListModal()">Annuler</button><button class="btn-add" onclick="renameList()">Renommer</button></div></div></div>
<div class="modal" id="themeModal">
    <div class="modal-content">
        <div class="modal-header">Th√®me</div>
        <div class="input-group">
            <label>D√©grad√© de fond ‚Äî d√©part</label>
            <input type="color" id="th_bg_from">
        </div>
        <div class="input-group">
            <label>D√©grad√© de fond ‚Äî fin</label>
            <input type="color" id="th_bg_to">
        </div>
        <div class="input-group">
            <label>Couleur primaire</label>
            <input type="color" id="th_primary">
        </div>
        <div class="input-group">
            <label>Couleur primaire 2</label>
            <input type="color" id="th_primary2">
        </div>
        <div class="input-group">
            <label>Accent</label>
            <input type="color" id="th_accent">
        </div>
        <div class="input-group">
            <label>Accent 2</label>
            <input type="color" id="th_accent2">
        </div>
        <div class="input-group">
            <label>Texte principal</label>
            <input type="color" id="th_text">
        </div>
        <div class="input-group">
            <label>Texte secondaire</label>
            <input type="color" id="th_text_soft">
        </div>
        <div class="input-group">
            <label>Fond des panneaux</label>
            <input type="color" id="th_panel">
        </div>
        <div class="input-group">
            <label>Fond att√©nu√©</label>
            <input type="color" id="th_panel_muted">
        </div>
        <div class="input-group">
            <label>Bordures</label>
            <input type="color" id="th_border">
        </div>
        <div class="input-group">
            <label>Fond des cartes d'√©tude</label>
            <input type="color" id="th_card_bg">
        </div>
        <div class="input-group">
            <label>Couleur "Connu"</label>
            <input type="color" id="th_known">
        </div>
        <div class="input-group">
            <label>Couleur "Partiel"</label>
            <input type="color" id="th_partial">
        </div>
        <div class="input-group">
            <label>Couleur "Pas connu"</label>
            <input type="color" id="th_unknown">
        </div>
        <div class="modal-buttons" style="flex-wrap:wrap">
            <button class="btn-add" onclick="saveTheme()">Enregistrer</button>
            <button class="btn-cancel" onclick="closeThemeModal()">Fermer</button>
            <button class="btn-clear" onclick="resetTheme()">R√©initialiser</button>
            <button class="btn-export" onclick="exportTheme()">Exporter</button>
            <label class="btn-action btn-action-secondary" style="cursor:pointer">
                Importer
                <input type="file" id="themeImportInput" accept="application/json" style="display:none">
            </label>
        </div>
        <div class="input-group" style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn-action btn-action-secondary" type="button" onclick="applyPreset('Clair')">Clair</button>
            <button class="btn-action btn-action-secondary" type="button" onclick="applyPreset('Sombre')">Sombre</button>
        </div>
    </div>
</div>
<div id="comparatorModal">
    <div class="comparator-container">
        <div class="comparator-header" style="padding:10px 20px;">
            <button class="btn-close-comparator" onclick="closeComparator()">‚úï Fermer</button>
        </div>
        <div class="comparator-main">
            <div class="comparator-section">
                <div class="comp-panel">
                    <h2>Texte r√©cent annot√©</h2>
                    <div id="diffOutput"></div>
                </div>
            </div>
            <button id="backToSelected" title="Aller √† la carte s√©lectionn√©e">‚¨Ö Aller √† la s√©lection</button>
        </div>
        <div class="comp-controls">
            <div>
                <label for="oldText">Texte ancien</label>
                <textarea id="oldText" placeholder="Colle ici l'ancienne version‚Ä¶"></textarea>
            </div>
            <div>
                <label for="newText">Texte r√©cent</label>
                <textarea id="newText" placeholder="Colle ici la nouvelle version‚Ä¶"></textarea>
            </div>
            <div class="comp-split">
                <button id="compareBtn">Comparer</button>
                <button id="copyBtn" class="secondary">Copier le r√©sultat</button>
            </div>
        </div>
        <div class="comparator-aside">
            <div class="comp-summary">
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
                    <code class="badge">Insertions: <span id="insCount">0</span></code>
                    <code class="badge">Suppressions: <span id="delCount">0</span></code>
                    <code class="badge">Remplacements: <span id="repCount">0</span></code>
                </div>
                <small id="hint">Colle tes textes puis clique sur ¬´ Comparer ¬ª.</small>
            </div>
            <div class="comp-toolbar">
                <strong>Changements</strong>
                <span style="flex:1"></span>
                <button id="toggleOnlyDeletions" class="btn-filter-del">‚ûñ Suppressions uniquement</button>
                <button id="toggleContext" class="secondary">¬± Contexte</button>
            </div>
            <div id="changesList" class="comp-changes"></div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <div class="modal" id="importTextModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">Importer depuis Texte / Quizlet</div>
       
        <div class="input-group">
            <label>1. Destination :</label>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select id="importCatSelect" onchange="updateImportFolderSelect()" style="flex:1"></select>
                <select id="importFolderSelect" style="flex:1"></select>
            </div>
            <input type="text" id="importListName" placeholder="Nom de la liste (ex: Chapitre 1)">
        </div>
        <div class="input-group">
            <label>2. S√©parateur entre Question et R√©ponse :</label>
            <select id="importSeparator">
                <option value="tab">Tabulation (Quizlet par d√©faut)</option>
                <option value=",">Virgule (,)</option>
                <option value=";">Point-virgule (;)</option>
                <option value=":">Deux-points (:)</option>
                <option value="-">Tiret (-)</option>
                <option value="|">Barre verticale (|)</option>
            </select>
        </div>
        <div class="input-group">
            <label>3. Collez votre texte ici :</label>
            <textarea id="importTextContent" style="width:100%; height:200px; padding:10px; border:2px solid var(--border); border-radius:8px; font-family:monospace; resize:vertical;" placeholder="Terme 1 D√©finition 1&#10;Terme 2 D√©finition 2"></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeImportTextModal()">Annuler</button>
            <button class="btn-add" onclick="performTextImport()">Importer les cartes</button>
        </div>
    </div>
</div>
<script>
    // VARIABLES GLOBALES FLASHCARDS
    let categories = {}, results = {}, currentCategory = null, currentFolder = null, currentList = null, currentPage = 'home', currentIndex = 0, isFlipped = false, isReviewMode = false, reviewIndices = [], stats = {known: 0, partial: 0, unknown: 0}, currentEditingSide = null, renameTarget = null, openCategories = {};
    let currentEditingExisting = { idx: null, side: null };
   
    // ‚Äî‚Äî‚Äî GIF "majorit√© connu" ‚Äî‚Äî‚Äî
    const GIF_KNOWN_URL = 'https://media.giphy.com/media/111ebonMs90YLu/giphy.gif';
   
    // ====== THEME ======
    const THEME_KEY = 'flashcards_theme_v1';
    const themeVars = [
        ['--bg-gradient-from','th_bg_from'],
        ['--bg-gradient-to','th_bg_to'],
        ['--primary','th_primary'],
        ['--primary-2','th_primary2'],
        ['--accent','th_accent'],
        ['--accent-2','th_accent2'],
        ['--text','th_text'],
        ['--text-soft','th_text_soft'],
        ['--panel','th_panel'],
        ['--panel-muted','th_panel_muted'],
        ['--border','th_border'],
        ['--card-bg','th_card_bg'],
        ['--known','th_known'],
        ['--partial','th_partial'],
        ['--unknown','th_unknown'],
    ];
    const THEME_PRESETS = {
        Clair: {
            '--bg-gradient-from':'#667eea','--bg-gradient-to':'#764ba2',
            '--primary':'#667eea','--primary-2':'#764ba2',
            '--accent':'#11998e','--accent-2':'#38ef7d',
            '--text':'#333333','--text-soft':'#666666',
            '--panel':'#ffffff','--panel-muted':'#f5f7fa',
            '--border':'#e0e0e0','--card-bg':'#ffffff',
            '--known':'#38ef7d','--partial':'#f5a623','--unknown':'#ff6b6b'
        },
        Sombre: {
            '--bg-gradient-from':'#0f172a','--bg-gradient-to':'#1f2937',
            '--primary':'#4f46e5','--primary-2':'#7c3aed',
            '--accent':'#10b981','--accent-2':'#34d399',
            '--text':'#e5e7eb','--text-soft':'#9ca3af',
            '--panel':'#111827','--panel-muted':'#0b1220',
            '--border':'#374151','--card-bg':'#0b1220',
            '--known':'#22c55e','--partial':'#f59e0b','--unknown':'#ef4444'
        }
    };
    function applyPreset(name){
        const preset = THEME_PRESETS[name];
        if (!preset) return;
        Object.entries(preset).forEach(([cssVar,val]) => setVar(cssVar,val));
        // R√©percute dans les inputs si le modal est ouvert
        for (const [cssVar, inputId] of themeVars) {
            const el = document.getElementById(inputId);
            if (el && preset[cssVar]) el.value = toColor(preset[cssVar]) || el.value;
        }
        // Sauvegarde
        localStorage.setItem(THEME_KEY, JSON.stringify(preset));
    }
    function getComputedVar(name){
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }
    function setVar(name, value){
        document.documentElement.style.setProperty(name, value);
    }
    function openThemeModal(){
        // 1) Pr√©-remplir + live preview
        for (const [cssVar, inputId] of themeVars) {
            const input = document.getElementById(inputId);
            if (!input) continue;
            const cur = getComputedVar(cssVar) || '';
            input.value = toColor(cur) || input.value || '#000000';
            input.oninput = (e) => {
                const val = e.target.value;
                if (val && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(val)) {
                    setVar(cssVar, val); // aper√ßu en direct
                }
            };
        }
        // 2) Branche l'auto‚Äësave
        bindThemeAutoSave();
        // 3) Ouvre le modal
        document.getElementById('themeModal').classList.add('show');
    }
    function closeThemeModal(){
        document.getElementById('themeModal').classList.remove('show');
    }
    // Convertit rgb(...) ou vide -> #rrggbb si possible
    function toColor(v){
        if(!v) return null;
        const s=v.trim();
        if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(s)) return s;
        const m = s.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i);
        if(m){
            const r = (+m[1]).toString(16).padStart(2,'0');
            const g = (+m[2]).toString(16).padStart(2,'0');
            const b = (+m[3]).toString(16).padStart(2,'0');
            return '#'+r+g+b;
        }
        return null;
    }
    function saveTheme(){
        const theme = {};
        for (const [cssVar, inputId] of themeVars) {
            const input = document.getElementById(inputId);
            if (input && input.value && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(input.value)) {
                theme[cssVar] = input.value;
            }
        }
        localStorage.setItem(THEME_KEY, JSON.stringify(theme));
        alert('Th√®me enregistr√© ‚úì');
    }
    function loadTheme(){
        try{
            const raw = localStorage.getItem(THEME_KEY);
            if(!raw) return;
            const theme = JSON.parse(raw);
            Object.entries(theme).forEach(([cssVar, value]) => setVar(cssVar, value));
        }catch(e){ console.warn('Theme load error', e); }
    }
    function resetTheme(){
        localStorage.removeItem(THEME_KEY);
        // Supprime les overrides inline, retombe sur les valeurs par d√©faut du :root
        for(const [cssVar] of themeVars){
            document.documentElement.style.removeProperty(cssVar);
        }
        alert('Th√®me r√©initialis√©');
    }
    let themeAutoSaveTimer = null;
    function autoSaveThemeSoon(){
        clearTimeout(themeAutoSaveTimer);
        themeAutoSaveTimer = setTimeout(() => {
            const theme = {};
            for (const [cssVar, inputId] of themeVars) {
                const el = document.getElementById(inputId);
                if (el && el.value) theme[cssVar] = el.value;
            }
            localStorage.setItem(THEME_KEY, JSON.stringify(theme));
        }, 400);
    }
    function bindThemeAutoSave(){
        for (const [, inputId] of themeVars) {
            const el = document.getElementById(inputId);
            if (!el) continue;
            el.addEventListener('input', autoSaveThemeSoon);
        }
    }
    function exportTheme(){
        try{
            const raw = localStorage.getItem(THEME_KEY) || '{}';
            const blob = new Blob([raw], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'theme.json';
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }catch(e){ alert('Export impossible'); }
    }
    document.getElementById('themeImportInput')?.addEventListener('change', e=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ev=>{
            try{
                const theme = JSON.parse(ev.target.result);
                Object.entries(theme).forEach(([cssVar, value]) => setVar(cssVar, value));
                localStorage.setItem(THEME_KEY, JSON.stringify(theme));
                alert('Th√®me import√© ‚úì');
            }catch(err){ alert('Fichier invalide.'); }
            e.target.value = '';
        };
        reader.readAsText(file);
    });
    // --- MODE INT√âGR√â (iframe) ---
    function getQueryParams() {
        const p = new URLSearchParams(window.location.search);
        return {
            embed: p.get('embed') === '1',
            cat: p.get('cat') || null,
            folder: p.get('folder') || null,
            list: p.get('list') || null,
            view: p.get('view') || null // "manage" | "study" | "lists" (optionnel)
        };
    }
	// Fonction pour appliquer le formatage
function formatText(command, side) {
	const el = document.getElementById('new' + (side === 'Q' ? 'Question' : 'Answer'));
	if (!el) return;

	// force le focus dans l'√©diteur
	el.focus();

	// essaie execCommand
	let ok = false;
	try { ok = document.execCommand(command, false, null); } catch(e) { ok = false; }

	// fallback moderne si execCommand ne fait rien
	if (!ok && document.queryCommandSupported && document.queryCommandSupported(command)) {
		try { document.execCommand(command, false, null); } catch(e) {}
	}

	el.focus();
}
// Fonction pour effacer le formatage
function clearFormat() { 
    const activeEditor = document.activeElement;
    if (activeEditor && (activeEditor.id === 'newQuestion' || activeEditor.id === 'newAnswer')) {
        // Sauvegarder la position du curseur
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        const startOffset = range.startOffset;
        const endOffset = range.endOffset;
        
        // Remplacer le HTML par le texte brut
        const text = activeEditor.innerText;
        activeEditor.innerHTML = text;
        
        // Restaurer la position du curseur
        const textNode = activeEditor.firstChild || activeEditor;
        const newRange = document.createRange();
        newRange.setStart(textNode, Math.min(startOffset, text.length));
        newRange.setEnd(textNode, Math.min(endOffset, text.length));
        selection.removeAllRanges();
        selection.addRange(newRange);
        
        activeEditor.focus();
    }
}

// Gestionnaires pour les couleurs
document.addEventListener('DOMContentLoaded', function() {
    const textColorInput = document.getElementById('textColorQ');
    const bgColorInput = document.getElementById('bgColorQ');
    
    if (textColorInput) {
        textColorInput.addEventListener('change', function(e) { 
            applyColorToSelection('foreColor', e.target.value); 
        });
    }
    
    if (bgColorInput) {
        bgColorInput.addEventListener('change', function(e) { 
            applyColorToSelection('backColor', e.target.value); 
        });
    }
});

// Fonction pour appliquer la couleur
function applyColorToSelection(command, color) {
    const activeEditor = document.activeElement;
    if (activeEditor && (activeEditor.id === 'newQuestion' || activeEditor.id === 'newAnswer')) {
        document.execCommand(command, false, color);
        activeEditor.focus();
    }
}

// Fonction pour ins√©rer une image (doit d√©j√† exister)
function insertImage(side) {
    // Marquer quel √©diteur est actif
    const activeEditor = document.activeElement;
    if (activeEditor && (activeEditor.id === 'newQuestion' || activeEditor.id === 'newAnswer')) {
        window.currentEditingSide = activeEditor.id === 'newQuestion' ? 'Q' : 'A';
    } else {
        window.currentEditingSide = side;
    }
    
    // D√©clencher le s√©lecteur de fichier
    document.getElementById('imageInput').click();
}

// Assurez-vous que la fonction addCard() fonctionne
function addCard() {
    const q = document.getElementById('newQuestion').innerHTML.trim();
    const a = document.getElementById('newAnswer').innerHTML.trim();
    const impEl = document.getElementById('importanceSelect');
    const importance = impEl ? (impEl.value || 'normal') : 'normal';
    
    if (!q || !a || q === '<br>' || a === '<br>') {
        alert('Veuillez remplir la question et la r√©ponse.');
        return;
    }
    
    if (!currentCategory || !currentFolder || !currentList) {
        alert("S√©lectionne d'abord une liste.");
        return;
    }
    
    categories[currentCategory][currentFolder][currentList].push({
        question: q,
        answer: a,
        importance: importance
    });
    
    saveData();
    document.getElementById('newQuestion').innerHTML = '';
    document.getElementById('newAnswer').innerHTML = '';
    
    if (impEl) impEl.value = 'normal';
    updateCategoryList();
    
    if (currentPage === 'manage') loadManageCardsPage();
}
    function bootstrapEmbedIfAny() {
        try {
            const qp = getQueryParams();
            if (!qp.embed) return;
            document.getElementById('toggleSidebarBtn')?.classList.add('sidebar-hidden');
            document.getElementById('sidebar')?.classList.add('hidden');
            document.getElementById('mainContent')?.classList.add('sidebar-hidden');
            if (qp.cat && qp.folder && qp.list) {
                if (qp.view === 'manage') {
                    showManageCardsPage(qp.cat, qp.folder, qp.list);
                } else if (qp.view === 'lists') {
                    showListsPage(qp.cat, qp.folder);
                } else {
                    showStudyPage(qp.cat, qp.folder, qp.list, false);
                }
            } else if (qp.cat && qp.folder) {
                showListsPage(qp.cat, qp.folder);
            } else {
                showPage('home');
            }
        } catch(e) {
            console.error('Erreur embed:', e);
        }
    }
    // FONCTIONS FLASHCARDS
    function toggleSidebar() { const sidebar = document.getElementById('sidebar'); const mainContent = document.getElementById('mainContent'); const toggleBtn = document.getElementById('toggleSidebarBtn'); sidebar.classList.toggle('hidden'); mainContent.classList.toggle('sidebar-hidden'); toggleBtn.classList.toggle('sidebar-hidden'); }
    function formatText(command) { 
    const activeEditor = document.activeElement;
    if (activeEditor && (activeEditor.id === 'newQuestion' || activeEditor.id === 'newAnswer')) {
        document.execCommand(command, false, null);
        activeEditor.focus();
    }
}

function clearFormat() { 
    const activeEditor = document.activeElement;
    if (activeEditor && (activeEditor.id === 'newQuestion' || activeEditor.id === 'newAnswer')) {
        activeEditor.innerHTML = activeEditor.innerText;
        activeEditor.focus();
    }
}
    function insertImage(side) { currentEditingSide = side; document.getElementById('imageInput').click(); }
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = document.createElement('img');
            img.src = event.target.result;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.display = 'inline-block';
            img.style.margin = '5px';
            img.style.borderRadius = '8px';
           
            let editor, targetId;
            if (currentEditingExisting.idx !== null) {
                targetId = (currentEditingExisting.side === 'Q' ? 'editQ-' : 'editA-') + currentEditingExisting.idx;
                editor = document.getElementById(targetId);
            } else {
                editor = document.getElementById('new' + (currentEditingSide === 'Q' ? 'Question' : 'Answer'));
            }
            if (!editor) {
                console.error("√âditeur introuvable.");
                return;
            }
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(img);
                const space = document.createTextNode('\u00A0');
                range.setStartAfter(img);
                range.insertNode(space);
                range.setStartAfter(space);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                editor.appendChild(img);
            }
           
            editor.focus();
            currentEditingExisting = { idx: null, side: null };
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    });
    // Gestionnaires pour les couleurs
document.getElementById('textColorQ').addEventListener('change', function(e) { 
    applyColorToSelection('foreColor', e.target.value); 
});
document.getElementById('bgColorQ').addEventListener('change', function(e) { 
    applyColorToSelection('backColor', e.target.value); 
});

// Fonction pour appliquer la couleur √† la s√©lection active
function applyColorToSelection(command, color) {
    const activeEditor = document.activeElement;
    if (activeEditor && (activeEditor.id === 'newQuestion' || activeEditor.id === 'newAnswer')) {
        document.execCommand(command, false, color);
        activeEditor.focus();
    }
}
    function showPage(e) { document.querySelectorAll('.page').forEach(e => e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); if (e === 'home') { document.getElementById('homePage').classList.add('active'); document.querySelector('.nav-item').classList.add('active'); currentPage = 'home'; currentCategory = null; currentFolder = null; currentList = null; updateHomeStats(); } }
    function showListsPage(category, folder) { currentCategory = category; currentFolder = folder; currentList = null; currentPage = 'lists'; document.querySelectorAll('.page').forEach(e => e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); document.getElementById('listsPage').classList.add('active'); document.getElementById('listsTitle').textContent = folder; updateCategoryList(); loadListsPage(); }
    function showManageCardsPage(category, folderName, listName) { currentCategory = category; currentFolder = folderName; currentList = listName; currentPage = 'manage'; document.querySelectorAll('.page').forEach(e => e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); document.getElementById('manageCardsPage').classList.add('active'); document.getElementById('manageTitle').textContent = 'G√©rer : ' + listName; document.getElementById('backToLists').onclick = function() { showListsPage(currentCategory, currentFolder); }; updateCategoryList(); loadManageCardsPage(); }
    function showStudyPage(category, folderName, listName, reviewMode) {
        if (reviewMode === undefined) reviewMode = false;
        currentCategory = category;
        currentFolder = folderName;
        currentList = listName;
        currentIndex = 0;
        stats = {known: 0, partial: 0, unknown: 0};
        isReviewMode = reviewMode;
       
        if (isReviewMode) {
            reviewIndices = getCardsToReview();
            if (reviewIndices.length === 0) {
                alert('Aucune carte √† revoir !');
                return;
            }
        } else {
            reviewIndices = [];
        }
       
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('studyPage').classList.add('active');
        document.getElementById('studyTitle').textContent = listName;
        document.getElementById('studyModeIndicator').style.display = isReviewMode ? 'inline-block' : 'none';
        document.getElementById('backToListsStudy').onclick = function() { showListsPage(currentCategory, currentFolder); };
        currentPage = 'study';
        updateCategoryList();
        loadCurrentList();
    }
    function getCardsToReview() { if (!currentCategory || !currentFolder || !currentList || !results[currentCategory] || !results[currentCategory][currentFolder] || !results[currentCategory][currentFolder][currentList]) return []; const e = results[currentCategory][currentFolder][currentList], t = []; Object.keys(e).forEach(r => { const o = e[r]; if (o === 'partial' || o === 'unknown') t.push(parseInt(r)); }); return t; }
    function getNextList() { if (!currentCategory || !currentFolder || !categories[currentCategory] || !categories[currentCategory][currentFolder]) return null; const lists = Object.keys(categories[currentCategory][currentFolder]); const currentIndex = lists.indexOf(currentList); if (currentIndex === -1 || currentIndex === lists.length - 1) return null; return lists[currentIndex + 1]; }
    function goToNextList() { const nextList = getNextList(); if (nextList) { showStudyPage(currentCategory, currentFolder, nextList, false); } }
    function loadData() {
        const catData = localStorage.getItem('flashcards_categories_v3');
        if (catData) {
            try {
                categories = JSON.parse(catData);
            } catch (e) {
                console.error('Erreur:', e); categories = {};
            }
        } else {
            categories = {};
        }
       
        const openData = localStorage.getItem('flashcards_open_categories');
        if (openData) {
            try {
                openCategories = JSON.parse(openData);
            } catch (e) {
                openCategories = {};
            }
        }
       
        const resData = localStorage.getItem('flashcards_results_v3');
        if (resData) {
            try {
                results = JSON.parse(resData);
            } catch (e) {
                results = {};
            }
        }
       
        if (Object.keys(categories).length === 0) {
            categories = {'üìö Mes cours': {'Droit Administratif': {'Chapitre 1': [{question: "Qu'est-ce que le principe de l√©galit√© ?", answer: "Le principe selon lequel l'administration doit agir conform√©ment aux r√®gles de droit."}]}}};
            openCategories['üìö Mes cours'] = true;
        }
        updateCategoryList();
        updateHomeStats();
    }
    function saveData() { localStorage.setItem('flashcards_categories_v3', JSON.stringify(categories)); localStorage.setItem('flashcards_open_categories', JSON.stringify(openCategories)); updateHomeStats(); }
    function saveResults() { localStorage.setItem('flashcards_results_v3', JSON.stringify(results)); }
    function toggleCategory(catName) { openCategories[catName] = !openCategories[catName]; localStorage.setItem('flashcards_open_categories', JSON.stringify(openCategories)); updateCategoryList(); }
    function updateCategoryList() {
        const container = document.getElementById('categoryList');
        container.innerHTML = '';
        Object.keys(categories).forEach(catName => {
            const catDiv = document.createElement('div');
            catDiv.className = 'category-item';
            const catHeader = document.createElement('div');
            catHeader.className = 'category-header';
            if (catName === currentCategory && (currentPage === 'lists' || currentPage === 'study' || currentPage === 'manage')) {
                catHeader.classList.add('active');
            }
           
            let totalCards = 0;
            Object.values(categories[catName]).forEach(folder => {
                Object.values(folder).forEach(lists => {
                    totalCards += lists.length;
                });
            });
           
            const leftDiv = document.createElement('div');
            leftDiv.className = 'category-left';
            const isOpen = openCategories[catName];
            const toggleSpan = document.createElement('span');
            toggleSpan.className = 'category-toggle' + (isOpen ? ' open' : '');
            toggleSpan.innerHTML = '‚ñ∂';
            toggleSpan.onclick = function(e) { e.stopPropagation(); toggleCategory(catName); };
            const nameSpan = document.createElement('span');
            nameSpan.className = 'category-name';
            nameSpan.textContent = catName;
            const countSpan = document.createElement('span');
            countSpan.className = 'category-count';
            countSpan.textContent = totalCards;
            leftDiv.appendChild(toggleSpan);
            leftDiv.appendChild(nameSpan);
            leftDiv.appendChild(countSpan);
           
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'category-actions';
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-edit-category';
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.onclick = function(e) { e.stopPropagation(); showEditCategoryModal(catName); };
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-delete-category';
            deleteBtn.innerHTML = '‚úï';
            deleteBtn.onclick = function(e) { e.stopPropagation(); deleteCategory(catName); };
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
           
            catHeader.appendChild(leftDiv);
            catHeader.appendChild(actionsDiv);
            catDiv.appendChild(catHeader);
           
            const foldersDiv = document.createElement('div');
            foldersDiv.className = 'category-folders' + (isOpen ? ' open' : '');
           
            Object.keys(categories[catName]).forEach(folderName => {
                let cardCount = 0;
                Object.values(categories[catName][folderName]).forEach(lists => {
                    cardCount += lists.length;
                });
               
                const folderDiv = document.createElement('div');
                folderDiv.className = 'folder-item';
                if (catName === currentCategory && folderName === currentFolder && (currentPage === 'lists' || currentPage === 'study' || currentPage === 'manage')) {
                    folderDiv.classList.add('active');
                }
               
                const folderInfo = document.createElement('div');
                folderInfo.className = 'folder-info';
                folderInfo.onclick = function() { showListsPage(catName, folderName); };
                folderInfo.innerHTML = '<span>üìñ</span><span style="flex:1">' + escapeHtml(folderName) + '</span><span class="folder-badge">' + cardCount + '</span>';
               
                const folderActions = document.createElement('div');
                folderActions.className = 'folder-actions';
                const folderEditBtn = document.createElement('button');
                folderEditBtn.className = 'btn-edit-folder';
                folderEditBtn.innerHTML = '‚úèÔ∏è';
                folderEditBtn.onclick = function(e) { e.stopPropagation(); showEditFolderModal(catName, folderName); };
                const folderDeleteBtn = document.createElement('button');
                folderDeleteBtn.className = 'btn-delete-folder';
                folderDeleteBtn.innerHTML = '‚úï';
                folderDeleteBtn.onclick = function(e) { e.stopPropagation(); deleteFolder(catName, folderName); };
                folderActions.appendChild(folderEditBtn);
                folderActions.appendChild(folderDeleteBtn);
               
                folderDiv.appendChild(folderInfo);
                folderDiv.appendChild(folderActions);
                foldersDiv.appendChild(folderDiv);
            });
           
            catDiv.appendChild(foldersDiv);
            container.appendChild(catDiv);
        });
    }
    function escapeHtml(text) { const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return text.replace(/[&<>"']/g, m => map[m]); }
    function loadListsPage() {
        const container = document.getElementById('listsGrid');
        container.innerHTML = '';
        if (!currentCategory || !currentFolder || !categories[currentCategory] || !categories[currentCategory][currentFolder]) return;
        const lists = categories[currentCategory][currentFolder];
        Object.keys(lists).forEach(listName => {
            const cards = lists[listName];
            const cardCount = cards.length;
            let toReviewCount = 0;
            if (results[currentCategory] && results[currentCategory][currentFolder] && results[currentCategory][currentFolder][listName]) {
                const listResults = results[currentCategory][currentFolder][listName];
                Object.values(listResults).forEach(result => {
                    if (result === 'partial' || result === 'unknown') toReviewCount++;
                });
            }
           
            const card = document.createElement('div');
            card.className = 'list-card';
           
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'list-card-buttons';
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-edit-list';
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.onclick = function(e) { e.stopPropagation(); showEditListModal(listName); };
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-delete-list';
            deleteBtn.innerHTML = '‚úï';
            deleteBtn.onclick = function(e) { e.stopPropagation(); deleteList(listName); };
            buttonsDiv.appendChild(editBtn);
            buttonsDiv.appendChild(deleteBtn);
           
            const integrateBtn = document.createElement('button');
            integrateBtn.className = 'btn-edit-list';
            integrateBtn.title = 'Int√©grer cette liste';
            integrateBtn.textContent = 'üîó';
            integrateBtn.onclick = function(e) {
                e.stopPropagation();
                copyListEmbed(listName);
            };
            buttonsDiv.appendChild(integrateBtn);
           
            let progressHTML = '';
            if (toReviewCount > 0) {
                progressHTML = '<div class="list-card-progress">üîÑ ' + toReviewCount + ' √† revoir</div>';
            }
           
            card.innerHTML = '<div class="list-card-left"><div class="list-card-title">' + escapeHtml(listName) + '</div><div class="list-card-count">' + cardCount + ' carte' + (cardCount > 1 ? 's' : '') + '</div>' + progressHTML + '</div><div class="list-card-actions"><button class="btn-list-action btn-study" onclick="showStudyPage(\'' + escapeHtml(currentCategory).replace(/'/g, "\\'") + '\',\'' + escapeHtml(currentFolder).replace(/'/g, "\\'") + '\',\'' + escapeHtml(listName).replace(/'/g, "\\'") + '\')">üìñ R√©viser</button><button class="btn-list-action btn-manage" onclick="showManageCardsPage(\'' + escapeHtml(currentCategory).replace(/'/g, "\\'") + '\',\'' + escapeHtml(currentFolder).replace(/'/g, "\\'") + '\',\'' + escapeHtml(listName).replace(/'/g, "\\'") + '\')">‚úèÔ∏è G√©rer</button></div>';
            card.appendChild(buttonsDiv);
            container.appendChild(card);
        });
    }
    function loadManageCardsPage() {
        if (!currentCategory || !currentFolder || !currentList || !categories[currentCategory] || !categories[currentCategory][currentFolder] || !categories[currentCategory][currentFolder][currentList]) return;
        const cards = categories[currentCategory][currentFolder][currentList];
        const container = document.getElementById('cardsList');
        document.getElementById('cardCount').textContent = cards.length;
       
        if (cards.length === 0) {
            container.innerHTML = '<div class="empty-cards-message">Aucune carte. Ajoute-en une ci-dessus !</div>';
            return;
        }
       
        container.innerHTML = '';
        cards.forEach((card, idx) => {
            const div = document.createElement('div');
            div.className = 'card-edit-item';
           
            const questionPreview = (card.question || '').replace(/<[^>]*>/g, '').substring(0, 100);
            const answerPreview = (card.answer || '').replace(/<[^>]*>/g, '').substring(0, 100);
           
            div.innerHTML =
              '<div class="card-edit-header">' +
                '<div class="card-edit-number">Carte #' + (idx + 1) + '</div>' +
                '<div class="card-edit-actions">' +
                  '<button class="btn-edit-card" onclick="startEditCard(' + idx + ')">‚úèÔ∏è</button>' +
                  '<button class="btn-delete-card" onclick="deleteCard(' + idx + ')">‚úï</button>' +
                '</div>' +
              '</div>' +
              '<div class="card-edit-content">' +
                '<div class="card-edit-text"><span class="card-edit-label">Q:</span> ' + questionPreview + '...</div>' +
                '<div class="card-edit-text"><span class="card-edit-label">R:</span> ' + answerPreview + '...</div>' +
              '</div>' +
              '<div class="card-inline-editor" id="editor-' + idx + '" style="display:none">' +
                '<div class="editor-row">' +
                  '<label class="card-edit-label" style="display:block;margin-bottom:6px">Question / Recto :</label>' +
                  '<div class="editor-toolbar">' +
                    '<button class="editor-btn" onclick="formatExistingCard(' + idx + ', \'bold\', \'Q\')"><b>G</b></button>' +
                    '<button class="editor-btn" onclick="formatExistingCard(' + idx + ', \'italic\', \'Q\')"><i>I</i></button>' +
                    '<button class="editor-btn" onclick="formatExistingCard(' + idx + ', \'underline\', \'Q\')"><u>S</u></button>' +
                    '<input type="color" class="color-picker" onchange="colorExistingCard(' + idx + ', this.value, \'fore\', \'Q\')" value="#000000" title="Couleur">' +
                    '<input type="color" class="color-picker" onchange="colorExistingCard(' + idx + ', this.value, \'back\', \'Q\')" value="#ffff00" title="Surlignage">' +
                    '<button class="editor-btn" onclick="insertImageExisting(' + idx + ', \'Q\')">üñºÔ∏è</button>' +
                    '<button class="editor-btn" onclick="clearFormatExisting(' + idx + ', \'Q\')">‚úñ</button>' +
                  '</div>' +
                  '<div class="editor-content" id="editQ-' + idx + '" contenteditable="true"></div>' +
                '</div>' +
                '<div class="editor-row">' +
                  '<label class="card-edit-label" style="display:block;margin-bottom:6px">R√©ponse / Verso :</label>' +
                  '<div class="editor-toolbar">' +
                    '<button class="editor-btn" onclick="formatExistingCard(' + idx + ', \'bold\', \'A\')"><b>G</b></button>' +
                    '<button class="editor-btn" onclick="formatExistingCard(' + idx + ', \'italic\', \'A\')"><i>I</i></button>' +
                    '<button class="editor-btn" onclick="formatExistingCard(' + idx + ', \'underline\', \'A\')"><u>S</u></button>' +
                    '<input type="color" class="color-picker" onchange="colorExistingCard(' + idx + ', this.value, \'fore\', \'A\')" value="#000000" title="Couleur">' +
                    '<input type="color" class="color-picker" onchange="colorExistingCard(' + idx + ', this.value, \'back\', \'A\')" value="#ffff00" title="Surlignage">' +
                    '<button class="editor-btn" onclick="insertImageExisting(' + idx + ', \'A\')">üñºÔ∏è</button>' +
                    '<button class="editor-btn" onclick="clearFormatExisting(' + idx + ', \'A\')">‚úñ</button>' +
                  '</div>' +
                  '<div class="editor-content" id="editA-' + idx + '" contenteditable="true"></div>' +
                '</div>' +
                '<div class="actions">' +
                  '<button class="btn-save-card" onclick="saveEditedCard(' + idx + ')">Enregistrer</button>' +
                  '<button class="btn-cancel-card" onclick="cancelEditCard(' + idx + ')">Annuler</button>' +
                '</div>' +
              '</div>';
            container.appendChild(div);
        });
    }
    function updateHomeStats() { let totalCourses = 0; let totalCards = 0; Object.values(categories).forEach(cat => { Object.values(cat).forEach(folder => { totalCourses++; Object.values(folder).forEach(lists => { totalCards += lists.length; }); }); }); document.getElementById('totalCourses').textContent = totalCourses; document.getElementById('totalCards').textContent = totalCards; const list = document.getElementById('courseList'); list.innerHTML = ''; if (totalCourses === 0) { list.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Aucun cours cr√©√©.</p>'; return; } Object.keys(categories).forEach(catName => { Object.keys(categories[catName]).forEach(folderName => { let cardCount = 0; const listCount = Object.keys(categories[catName][folderName]).length; Object.values(categories[catName][folderName]).forEach(lists => { cardCount += lists.length; }); const div = document.createElement('div'); div.className = 'course-card'; div.onclick = () => showListsPage(catName, folderName); div.innerHTML = '<div class="course-card-left"><div class="course-card-title">' + escapeHtml(folderName) + '</div><div class="course-card-info">' + listCount + ' liste' + (listCount > 1 ? 's' : '') + ' ‚Ä¢ ' + cardCount + ' carte' + (cardCount > 1 ? 's' : '') + '</div></div><div class="course-card-arrow">‚Üí</div>'; list.appendChild(div); }); }); }
    function loadCurrentList() { if (!currentCategory || !currentFolder || !currentList || !categories[currentCategory] || !categories[currentCategory][currentFolder] || !categories[currentCategory][currentFolder][currentList]) { showEmptyState(); return; } const cards = categories[currentCategory][currentFolder][currentList]; if (isReviewMode && reviewIndices.length === 0) { showEmptyState(); return; } if (cards.length === 0) { showEmptyState(); } else { hideEmptyState(); loadCard(); } }
    function showEmptyState() { document.getElementById('cardSection').style.display = 'none'; document.getElementById('endSection').style.display = 'none'; document.getElementById('emptyState').style.display = 'block'; document.getElementById('progressBar').style.width = '0%'; }
    function hideEmptyState() { document.getElementById('cardSection').style.display = 'block'; document.getElementById('endSection').style.display = 'none'; document.getElementById('emptyState').style.display = 'none'; }
    function loadCard() { if (!currentCategory || !currentFolder || !currentList || !categories[currentCategory] || !categories[currentCategory][currentFolder] || !categories[currentCategory][currentFolder][currentList]) return; const cards = categories[currentCategory][currentFolder][currentList]; if (isReviewMode) { if (currentIndex >= reviewIndices.length) { showEndScreen(); return; } const idx = reviewIndices[currentIndex]; const card = cards[idx]; document.getElementById('question').innerHTML = card.question; document.getElementById('answer').innerHTML = card.answer; } else { if (currentIndex >= cards.length) { showEndScreen(); return; } const card = cards[currentIndex]; document.getElementById('question').innerHTML = card.question; document.getElementById('answer').innerHTML = card.answer; } window.currentImportance = card.importance || 'normal'; document.getElementById('flashcard').classList.remove('flipped'); isFlipped = false; updateProgress(); updateStats(); }
    function flipCard() { document.getElementById('flashcard').classList.toggle('flipped'); isFlipped = !isFlipped; }
    function editCurrentCard() {
        if (!currentCategory || !currentFolder || !currentList) { alert("Aucune liste s√©lectionn√©e."); return; }
        const cards = categories[currentCategory][currentFolder][currentList] || [];
        if (cards.length === 0) { alert("Aucune carte dans cette liste."); return; }
       
        let idx;
        if (isReviewMode) {
            if (reviewIndices.length === 0) { alert("Aucune carte en mode r√©vision."); return; }
            const pos = Math.min(currentIndex, Math.max(0, reviewIndices.length - 1));
            idx = reviewIndices[pos];
        } else {
            idx = Math.min(currentIndex, Math.max(0, cards.length - 1));
        }
       
        showManageCardsPage(currentCategory, currentFolder, currentList);
        setTimeout(() => startEditCard(idx), 0);
    }
    function answer(type) { if (!results[currentCategory]) results[currentCategory] = {}; if (!results[currentCategory][currentFolder]) results[currentCategory][currentFolder] = {}; if (!results[currentCategory][currentFolder][currentList]) results[currentCategory][currentFolder][currentList] = {}; const idx = isReviewMode ? reviewIndices[currentIndex] : currentIndex; results[currentCategory][currentFolder][currentList][idx] = type; saveResults(); stats[type]++; currentIndex++; loadCard(); }
    function updateProgress() { const cards = categories[currentCategory][currentFolder][currentList]; const total = isReviewMode ? reviewIndices.length : cards.length; const current = currentIndex; const percent = current / total * 100; document.getElementById('progressBar').style.width = percent + '%'; }
    function updateStats() { 
        const cards = categories[currentCategory][currentFolder][currentList]; 
        const total = isReviewMode ? reviewIndices.length : cards.length; 
        document.getElementById('stats').textContent =
            'Carte ' + (currentIndex + 1) + '/' + total +
            ' | Niveau: ' + (window.currentImportance || 'normal') +
            ' | Connu: ' + stats.known +
            ' | Partiel: ' + stats.partial +
            ' | Pas connu: ' + stats.unknown;
    }
    function showEndScreen() {
        document.getElementById('cardSection').style.display = 'none';
        document.getElementById('endSection').style.display = 'block';
        const total = stats.known + stats.partial + stats.unknown;
        const knownPercent = total > 0 ? Math.round(stats.known / total * 100) : 0;
        const partialPercent = total > 0 ? Math.round(stats.partial / total * 100) : 0;
        const unknownPercent = total > 0 ? Math.round(stats.unknown / total * 100) : 0;
        document.getElementById('legendKnown').textContent = 'Connu: ' + stats.known + ' (' + knownPercent + '%)';
        document.getElementById('legendPartial').textContent = 'Partiel: ' + stats.partial + ' (' + partialPercent + '%)';
        document.getElementById('legendUnknown').textContent = 'Pas connu: ' + stats.unknown + ' (' + unknownPercent + '%)';
        drawPieChart();
        
        // Afficher le GIF si majorit√© de "Connu"
        const majorityKnown = (stats.known > stats.partial + stats.unknown);
        const gifWrap = document.getElementById('resultGif');
        const gifImg = document.getElementById('resultGifImg');
        if (majorityKnown && GIF_KNOWN_URL) {
            gifImg.src = GIF_KNOWN_URL;
            gifWrap.classList.add('show');
        } else {
            gifWrap.classList.remove('show');
            gifImg.src = '';
        }
    }
    function drawPieChart() {
        const total = stats.known + stats.partial + stats.unknown;
        if (total === 0) {
            document.getElementById('barKnown').style.width = '0%';
            document.getElementById('barKnown').textContent = '0';
            document.getElementById('barPartial').style.width = '0%';
            document.getElementById('barPartial').textContent = '0';
            document.getElementById('barUnknown').style.width = '0%';
            document.getElementById('barUnknown').textContent = '0';
            return;
        }
        const knownPercent = Math.round(stats.known / total * 100);
        const partialPercent = Math.round(stats.partial / total * 100);
        const unknownPercent = Math.round(stats.unknown / total * 100);
        document.getElementById('barKnown').style.width = knownPercent + '%';
        document.getElementById('barKnown').textContent = stats.known;
        document.getElementById('barPartial').style.width = partialPercent + '%';
        document.getElementById('barPartial').textContent = stats.partial;
        document.getElementById('barUnknown').style.width = unknownPercent + '%';
        document.getElementById('barUnknown').textContent = stats.unknown;
    }
    function restartSession() { currentIndex = 0; stats = {known: 0, partial: 0, unknown: 0}; isReviewMode = false; reviewIndices = []; document.getElementById('studyModeIndicator').style.display = 'none'; document.getElementById('endSection').style.display = 'none'; document.getElementById('cardSection').style.display = 'block'; loadCard(); }
    function reviewWrongCards() { showStudyPage(currentCategory, currentFolder, currentList, true); }
    function addCard() {
        const q = document.getElementById('newQuestion').innerHTML.trim();
        const a = document.getElementById('newAnswer').innerHTML.trim();
        const impEl = document.getElementById('importanceSelect');
        const importance = impEl ? (impEl.value || 'normal') : 'normal';
        if (!q || !a || q === '<br>' || a === '<br>') {
            alert('Veuillez remplir la question et la r√©ponse.');
            return;
        }
        if (!currentCategory || !currentFolder || !currentList) {
            alert("S√©lectionne d'abord une liste.");
            return;
        }
        categories[currentCategory][currentFolder][currentList].push({
            question: q,
            answer: a,
            importance: importance
        });
        saveData();
        document.getElementById('newQuestion').innerHTML = '';
        document.getElementById('newAnswer').innerHTML = '';
        if (impEl) impEl.value = 'normal';
        updateCategoryList();
        if (currentPage === 'manage') loadManageCardsPage();
    }
    // Fonctions pour les nouvelles options de mise en forme
function applyPresetFormat(type) {
    const activeEditor = document.activeElement;
    if (!activeEditor || !activeEditor.classList.contains('editor-content')) return;
    
    switch(type) {
        case 'highlight':
            document.execCommand('backColor', false, '#fff3cd');
            document.execCommand('foreColor', false, '#856404');
            break;
        case 'code':
            document.execCommand('formatBlock', false, '<pre>');
            document.execCommand('backColor', false, '#f8f9fa');
            document.execCommand('foreColor', false, '#e83e8c');
            break;
        case 'quote':
            document.execCommand('formatBlock', false, '<blockquote>');
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('foreColor', false, '#6c757d');
            break;
    }
    activeEditor.focus();
}

function insertSpecialChar(type) {
    const activeEditor = document.activeElement;
    if (!activeEditor || !activeEditor.classList.contains('editor-content')) return;
    
    let text = '';
    switch(type) {
        case 'bullet':
            text = '‚Ä¢ ';
            break;
        case 'number':
            text = '1. ';
            break;
        case 'divider':
            text = '\n---\n';
            break;
    }
    
    document.execCommand('insertText', false, text);
    activeEditor.focus();
}

function duplicateCurrentCard() {
    if (!currentCategory || !currentFolder || !currentList) return;
    const cards = categories[currentCategory][currentFolder][currentList];
    if (cards.length === 0) {
        alert("Aucune carte √† dupliquer.");
        return;
    }
    
    const lastCard = cards[cards.length - 1];
    document.getElementById('newQuestion').innerHTML = lastCard.question;
    document.getElementById('newAnswer').innerHTML = lastCard.answer;
    
    // Copier aussi l'importance si elle existe
    if (lastCard.importance) {
        const impSelect = document.getElementById('importanceSelect');
        if (impSelect) impSelect.value = lastCard.importance;
    }
    
    alert("Derni√®re carte dupliqu√©e dans les champs d'√©dition !");
}

function clearAllFormats() {
    const qEditor = document.getElementById('newQuestion');
    const aEditor = document.getElementById('newAnswer');
    
    if (qEditor) qEditor.innerHTML = qEditor.innerText;
    if (aEditor) aEditor.innerHTML = aEditor.innerText;
    
    // R√©initialiser aussi l'importance
    const impSelect = document.getElementById('importanceSelect');
    if (impSelect) impSelect.value = 'normal';
    
    alert("Tous les formats ont √©t√© effac√©s.");
}

function previewCard() {
    const question = document.getElementById('newQuestion').innerHTML.trim();
    const answer = document.getElementById('newAnswer').innerHTML.trim();
    
    if (!question && !answer) {
        alert("Aucun contenu √† pr√©visualiser.");
        return;
    }
    
    const previewWindow = window.open('', '_blank', 'width=600,height=400');
    previewWindow.document.write(`
        <html>
        <head>
            <title>Aper√ßu de la carte</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .card { border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
                .front { background: #f8f9fa; }
                .back { background: #e8ebff; }
                .label { font-weight: bold; color: #667eea; margin-bottom: 10px; }
                .content { margin-bottom: 10px; }
				/* --- UI COMPACT (force) --- */
#importanceSelect,
#folderCategorySelect,
#importSeparator,
#importCatSelect,
#importFolderSelect,
.input-group select {
	font-size: 12px !important;
	padding: 6px 8px !important;
	height: 32px !important;
}

.editor-toolbar {
	padding: 6px !important;
	gap: 6px !important;
}

.editor-btn {
	font-size: 12px !important;
	padding: 5px 8px !important;
	line-height: 1 !important;
}

.color-picker {
	width: 26px !important;
	height: 26px !important;
	padding: 0 !important;
}

.input-group input[type="text"]{
	font-size: 12px !important;
	padding: 6px 8px !important;
	height: 32px !important;
}
            </style>
        </head>
        <body>
            <h2>üëÅÔ∏è Aper√ßu de la carte</h2>
            <div class="card front">
                <div class="label">Question / Recto :</div>
                <div class="content">${question || '(vide)'}</div>
            </div>
            <div class="card back">
                <div class="label">R√©ponse / Verso :</div>
                <div class="content">${answer || '(vide)'}</div>
            </div>
            <button onclick="window.close()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Fermer
            </button>
        </body>
        </html>
    `);
    previewWindow.document.close();
}
    function deleteCard(idx) { if (!confirm('Supprimer cette carte ?')) return; categories[currentCategory][currentFolder][currentList].splice(idx, 1); if (results[currentCategory] && results[currentCategory][currentFolder] && results[currentCategory][currentFolder][currentList]) { delete results[currentCategory][currentFolder][currentList][idx]; const newResults = {}; Object.keys(results[currentCategory][currentFolder][currentList]).forEach(key => { const i = parseInt(key); if (i > idx) newResults[i - 1] = results[currentCategory][currentFolder][currentList][key]; else if (i < idx) newResults[i] = results[currentCategory][currentFolder][currentList][key]; }); results[currentCategory][currentFolder][currentList] = newResults; saveResults(); } saveData(); updateCategoryList(); if (currentPage === 'manage') loadManageCardsPage(); }
    // --- √âDITION DE CARTES EXISTANTES ---
    function startEditCard(idx) {
        if (!currentCategory || !currentFolder || !currentList) return;
        const card = categories[currentCategory][currentFolder][currentList][idx];
        const q = document.getElementById('editQ-' + idx);
        const a = document.getElementById('editA-' + idx);
       
        document.querySelectorAll('.card-inline-editor').forEach(panel => {
            if (panel.id !== 'editor-' + idx) {
                panel.style.display = 'none';
            }
        });
        if (!q || !a) return;
       
        q.innerHTML = card.question || '';
        a.innerHTML = card.answer || '';
       
        const panel = document.getElementById('editor-' + idx);
        if (panel) {
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            q.focus();
        }
    }
    function cancelEditCard(idx) {
        const panel = document.getElementById('editor-' + idx);
        if (panel) panel.style.display = 'none';
    }
    function saveEditedCard(idx) {
        if (!currentCategory || !currentFolder || !currentList) { alert("Erreur de contexte."); return; }
        const qEl = document.getElementById('editQ-' + idx);
        const aEl = document.getElementById('editA-' + idx);
        if (!qEl || !aEl) return;
       
        const newQ = (qEl.innerHTML || '').trim();
        const newA = (aEl.innerHTML || '').trim();
       
        if (!newQ || !newA || newQ === '<br>' || newA === '<br>') {
            alert('Veuillez remplir la question et la r√©ponse.');
            return;
        }
       
        categories[currentCategory][currentFolder][currentList][idx] = { question: newQ, answer: newA };
        saveData();
        updateCategoryList();
        loadManageCardsPage();
    }
    function formatExistingCard(idx, command, side) {
        const el = document.getElementById((side === 'Q' ? 'editQ-' : 'editA-') + idx);
        if (!el) return;
        el.focus();
        document.execCommand(command, false, null);
    }
    function colorExistingCard(idx, value, kind, side) {
        const el = document.getElementById((side === 'Q' ? 'editQ-' : 'editA-') + idx);
        if (!el) return;
        el.focus();
        if (kind === 'fore') document.execCommand('foreColor', false, value);
        else document.execCommand('backColor', false, value);
    }
    function clearFormatExisting(idx, side) {
        const el = document.getElementById((side === 'Q' ? 'editQ-' : 'editA-') + idx);
        if (!el) return;
        el.innerHTML = el.innerText;
        el.focus();
    }
    function insertImageExisting(idx, side) {
        currentEditingExisting = { idx, side };
        document.getElementById('imageInput').click();
    }
    // MODALS FLASHCARDS
    function showNewCategoryModal() { document.getElementById('newCategoryModal').classList.add('show'); const input = document.getElementById('categoryNameInput'); input.value = ''; setTimeout(() => input.focus(), 150); }
    function closeNewCategoryModal() { document.getElementById('newCategoryModal').classList.remove('show'); document.getElementById('categoryNameInput').value = ''; }
    function createCategory() { const input = document.getElementById('categoryNameInput'); const name = input.value.trim(); if (!name) { alert('Veuillez entrer un nom.'); setTimeout(() => input.focus(), 150); return; } if (categories[name]) { alert('Cette cat√©gorie existe d√©j√†.'); input.value = ''; setTimeout(() => input.focus(), 150); return; } categories[name] = {}; openCategories[name] = true; saveData(); updateCategoryList(); closeNewCategoryModal(); }
    function deleteCategory(catName) { if (!confirm('Supprimer "' + catName + '" et tous ses cours ?')) return; delete categories[catName]; delete results[catName]; delete openCategories[catName]; saveData(); saveResults(); if (currentCategory === catName) showPage('home'); updateCategoryList(); }
    function showEditCategoryModal(catName) { renameTarget = catName; document.getElementById('renameCategoryModal').classList.add('show'); const input = document.getElementById('renameCategoryInput'); input.value = catName; setTimeout(() => input.focus(), 150); }
    function closeRenameCategoryModal() { document.getElementById('renameCategoryModal').classList.remove('show'); document.getElementById('renameCategoryInput').value = ''; renameTarget = null; }
    function renameCategory() { const input = document.getElementById('renameCategoryInput'); const newName = input.value.trim(); if (!newName) { alert('Veuillez entrer un nom.'); setTimeout(() => input.focus(), 150); return; } if (categories[newName] && newName !== renameTarget) { alert('Ce nom existe d√©j√†.'); input.value = ''; setTimeout(() => input.focus(), 150); return; } if (renameTarget && categories[renameTarget]) { categories[newName] = categories[renameTarget]; delete categories[renameTarget]; if (results[renameTarget]) { results[newName] = results[renameTarget]; delete results[renameTarget]; saveResults(); } if (openCategories[renameTarget]) { openCategories[newName] = openCategories[renameTarget]; delete openCategories[renameTarget]; } if (currentCategory === renameTarget) currentCategory = newName; saveData(); updateCategoryList(); closeRenameCategoryModal(); } }
    function updateFolderCategorySelect() { const select = document.getElementById('folderCategorySelect'); select.innerHTML = ''; const catNames = Object.keys(categories); if (catNames.length === 0) { const opt = document.createElement('option'); opt.value = ''; opt.textContent = 'Aucune cat√©gorie - Cr√©ez-en une !'; select.appendChild(opt); } else { catNames.forEach(catName => { const opt = document.createElement('option'); opt.value = catName; opt.textContent = catName; if (catName === currentCategory) opt.selected = true; select.appendChild(opt); }); } }
    function showNewFolderModal() { updateFolderCategorySelect(); document.getElementById('newFolderModal').classList.add('show'); const input = document.getElementById('folderNameInput'); input.value = ''; setTimeout(() => input.focus(), 150); }
    function closeNewFolderModal() { document.getElementById('newFolderModal').classList.remove('show'); document.getElementById('folderNameInput').value = ''; }
    function createFolder() { const input = document.getElementById('folderNameInput'); const name = input.value.trim(); const catSelect = document.getElementById('folderCategorySelect'); const selectedCat = catSelect.value; if (!selectedCat) { alert('Veuillez cr√©er une cat√©gorie d\'abord.'); return; } if (!name) { alert('Veuillez entrer un nom de cours.'); setTimeout(() => input.focus(), 150); return; } if (categories[selectedCat][name]) { alert('Ce cours existe d√©j√† dans cette cat√©gorie.'); input.value = ''; setTimeout(() => input.focus(), 150); return; } categories[selectedCat][name] = {'Liste par d√©faut': []}; saveData(); updateCategoryList(); closeNewFolderModal(); showListsPage(selectedCat, name); }
    function deleteFolder(catName, folderName) { if (!confirm('Supprimer "' + folderName + '" ?')) return; delete categories[catName][folderName]; if (results[catName]) { delete results[catName][folderName]; saveResults(); } if (Object.keys(categories[catName]).length === 0) { delete categories[catName]; delete openCategories[catName]; } saveData(); if (currentCategory === catName && currentFolder === folderName) showPage('home'); updateCategoryList(); }
    function showEditFolderModal(catName, folderName) { renameTarget = {cat: catName, folder: folderName}; document.getElementById('renameFolderModal').classList.add('show'); const input = document.getElementById('renameFolderInput'); input.value = folderName; setTimeout(() => input.focus(), 150); }
    function closeRenameFolderModal() { document.getElementById('renameFolderModal').classList.remove('show'); document.getElementById('renameFolderInput').value = ''; renameTarget = null; }
    function showRenameFolderModal() { if (!currentCategory || !currentFolder) return; showEditFolderModal(currentCategory, currentFolder); }
    function renameFolder() { const input = document.getElementById('renameFolderInput'); const newName = input.value.trim(); if (!newName) { alert('Veuillez entrer un nom.'); setTimeout(() => input.focus(), 150); return; } const catName = renameTarget.cat; const oldName = renameTarget.folder; if (categories[catName][newName] && newName !== oldName) { alert('Ce nom existe d√©j√†.'); input.value = ''; setTimeout(() => input.focus(), 150); return; } if (categories[catName][oldName]) { categories[catName][newName] = categories[catName][oldName]; delete categories[catName][oldName]; if (results[catName] && results[catName][oldName]) { results[catName][newName] = results[catName][oldName]; delete results[catName][oldName]; saveResults(); } if (currentCategory === catName && currentFolder === oldName) currentFolder = newName; saveData(); updateCategoryList(); if (currentPage === 'lists') { document.getElementById('listsTitle').textContent = newName; } closeRenameFolderModal(); } }
    function showNewListModal() { if (!currentCategory || !currentFolder) { alert('Erreur : aucun cours s√©lectionn√©.'); return; } document.getElementById('newListModal').classList.add('show'); const input = document.getElementById('listNameInput'); input.value = ''; setTimeout(() => input.focus(), 150); }
    function closeNewListModal() { document.getElementById('newListModal').classList.remove('show'); document.getElementById('listNameInput').value = ''; }
    function createList() { const input = document.getElementById('listNameInput'); const name = input.value.trim(); if (!name) { alert('Veuillez entrer un nom de liste.'); setTimeout(() => input.focus(), 150); return; } if (!currentCategory || !currentFolder || !categories[currentCategory] || !categories[currentCategory][currentFolder]) { alert('Erreur.'); return; } if (categories[currentCategory][currentFolder][name]) { alert('Cette liste existe d√©j√†.'); input.value = ''; setTimeout(() => input.focus(), 150); return; } categories[currentCategory][currentFolder][name] = []; saveData(); updateCategoryList(); closeNewListModal(); loadListsPage(); }
    function deleteList(listName) { if (!confirm('Supprimer "' + listName + '" ?')) return; delete categories[currentCategory][currentFolder][listName]; if (results[currentCategory] && results[currentCategory][currentFolder]) { delete results[currentCategory][currentFolder][listName]; saveResults(); } if (Object.keys(categories[currentCategory][currentFolder]).length === 0) { categories[currentCategory][currentFolder]['Liste par d√©faut'] = []; } saveData(); updateCategoryList(); loadListsPage(); }
    function showEditListModal(listName) { renameTarget = listName; document.getElementById('renameListModal').classList.add('show'); const input = document.getElementById('renameListInput'); input.value = listName; setTimeout(() => input.focus(), 150); }
    function closeRenameListModal() { document.getElementById('renameListModal').classList.remove('show'); document.getElementById('renameListInput').value = ''; renameTarget = null; }
    function renameList() { const input = document.getElementById('renameListInput'); const newName = input.value.trim(); if (!newName) { alert('Veuillez entrer un nom.'); setTimeout(() => input.focus(), 150); return; } if (!currentCategory || !currentFolder || !categories[currentCategory] || !categories[currentCategory][currentFolder]) { alert('Erreur.'); return; } if (categories[currentCategory][currentFolder][newName] && newName !== renameTarget) { alert('Ce nom existe d√©j√†.'); input.value = ''; setTimeout(() => input.focus(), 150); return; } if (renameTarget && categories[currentCategory][currentFolder][renameTarget]) { categories[currentCategory][currentFolder][newName] = categories[currentCategory][currentFolder][renameTarget]; delete categories[currentCategory][currentFolder][renameTarget]; if (results[currentCategory] && results[currentCategory][currentFolder] && results[currentCategory][currentFolder][renameTarget]) { results[currentCategory][currentFolder][newName] = results[currentCategory][currentFolder][renameTarget]; delete results[currentCategory][currentFolder][renameTarget]; saveResults(); } if (currentList === renameTarget) currentList = newName; saveData(); updateCategoryList(); loadListsPage(); closeRenameListModal(); } }
    function exportCards() { if (!currentCategory || !currentFolder || !currentList) { alert('S√©lectionne une liste.'); return; } const data = {categoryName: currentCategory, folderName: currentFolder, listName: currentList, cards: categories[currentCategory][currentFolder][currentList]}; const json = JSON.stringify(data, null, 2); const blob = new Blob([json], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = currentCategory.replace(/[^a-z0-9]/gi, '_') + '_' + currentFolder.replace(/[^a-z0-9]/gi, '_') + '_' + currentList.replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    function baseAppUrl() {
        const u = new URL(window.location.href);
        u.search = '';
        u.hash = '';
        return u.toString();
    }
    function buildEmbedUrl({cat, folder, list, view}) {
        const u = new URL(baseAppUrl());
        u.searchParams.set('embed', '1');
        if (cat) u.searchParams.set('cat', cat);
        if (folder) u.searchParams.set('folder', folder);
        if (list) u.searchParams.set('list', list);
        if (view) u.searchParams.set('view', view);
        return u.toString();
    }
    function buildIframeCode(src, opts) {
        const width = (opts && opts.width) || '100%';
        const height = (opts && opts.height) || '600';
        const style = (opts && opts.style) || 'border:1px solid #e5e7eb;border-radius:12px;';
        return `<iframe src="${src}" width="${width}" height="${height}" style="${style}" allowfullscreen loading="lazy"></iframe>`;
    }
    function copyFolderEmbed() {
        if (!currentCategory || !currentFolder) { alert('Aucun cours s√©lectionn√©.'); return; }
        const src = buildEmbedUrl({ cat: currentCategory, folder: currentFolder, view: 'lists' });
        const code = buildIframeCode(src, { height: '700' });
        copyText(code);
    }
    function copyListEmbed(listName) {
        const cat = currentCategory;
        const folder = currentFolder;
        const list = listName;
        if (!cat || !folder || !list) { alert('S√©lection invalide.'); return; }
        const src = buildEmbedUrl({ cat, folder, list, view: 'study' });
        const code = buildIframeCode(src, { height: '700' });
        copyText(code);
    }
    async function copyText(text) {
        try {
            await navigator.clipboard.writeText(text);
            alert('Code d\'int√©gration copi√© ‚úì');
        } catch (e) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); alert('Code d\'int√©gration copi√© ‚úì'); }
            catch { alert('Impossible de copier automatiquement. S√©lectionne et copie manuellement.'); }
            document.body.removeChild(ta);
        }
    }
    function exportAll() {
        if (!categories || typeof categories !== 'object') {
            alert("Aucune donn√©e √† exporter.");
            return;
        }
        const snapshot = {
            exportVersion: "1.0",
            exportedAt: new Date().toISOString(),
            summary: {
                categories: 0,
                courses: 0,
                lists: 0,
                cards: 0
            },
            data: [],
            results: results || {}
        };
       
        Object.keys(categories).forEach(catName => {
            const cat = categories[catName] || {};
            const catOut = { categoryName: catName, courses: [] };
            snapshot.summary.categories++;
            Object.keys(cat).forEach(folderName => {
                const folder = cat[folderName] || {};
                const folderOut = { folderName, lists: [] };
                snapshot.summary.courses++;
                Object.keys(folder).forEach(listName => {
                    const cards = Array.isArray(folder[listName]) ? folder[listName] : [];
                    const listOut = { listName, cards };
                    snapshot.summary.lists++;
                    snapshot.summary.cards += cards.length;
                    folderOut.lists.push(listOut);
                });
                catOut.courses.push(folderOut);
            });
            snapshot.data.push(catOut);
        });
       
        const json = JSON.stringify(snapshot, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const safe = s => (s || '').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-zA-Z0-9_-]+/g, '_');
        const filename = `flashcards_export_all_${safe(new Date().toISOString().split('T')[0])}.json`;
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    function importCards() { document.getElementById('fileInput').click(); }
    document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        console.log('[IMPORT] name:', file.name, 'type:', file.type, 'size:', file.size);
        const reader = new FileReader();
        reader.onerror = () => alert('Lecture de fichier impossible (FileReader).');
        reader.onload = function(e) {
            try {
                let raw = e.target.result || '';
                // 1) Nettoyage basique: supprime BOM et fences markdown √©ventuels
                raw = raw.replace(/^\uFEFF/, '').trim();
                if (raw.startsWith('```')) {
                    // retire fences ```json ... ```
                    raw = raw.replace(/^```[a-zA-Z0-9]*\s*/, '').replace(/```$/, '').trim();
                }
                // 2) Parse JSON
                let data;
                try {
                    data = JSON.parse(raw);
                } catch (err) {
                    console.error('[IMPORT] JSON.parse error:', err);
                    alert('JSON invalide (√©chec du parsing). V√©rifie qu\'il n\'y a pas de ``` ou de guillemets simples.');
                    event.target.value = '';
                    return;
                }
                // 3) D√©tection format + import
                const isList = data && data.categoryName && data.folderName && data.listName && Array.isArray(data.cards);
                const isAll = data && data.exportVersion && Array.isArray(data.data);
                if (!isList && !isAll) {
                    console.warn('[IMPORT] Format non reconnu. Aper√ßu des cl√©s:', Object.keys(data||{}));
                    alert('Format non reconnu. Fichier attendu: "liste unique" ou "export tout".');
                    event.target.value = '';
                    return;
                }
                if (isList) {
                    const { categoryName, folderName, listName, cards } = data;
                    if (!categories[categoryName]) categories[categoryName] = {};
                    if (!categories[categoryName][folderName]) categories[categoryName][folderName] = {};
                    if (categories[categoryName][folderName][listName]) {
                        if (!confirm(`La liste "${listName}" existe d√©j√†. √âcraser ?`)) {
                            event.target.value = '';
                            return;
                        }
                    }
                    categories[categoryName][folderName][listName] = Array.isArray(cards) ? cards : [];
                    saveData();
                    updateCategoryList();
                    if (currentPage === 'home') updateHomeStats();
                    alert('Import de la liste termin√© ‚úì');
                    event.target.value = '';
                    return;
                }
                if (isAll) {
                    // Import "export tout"
                    let catCount=0, courseCount=0, listCount=0, cardCount=0;
                    (data.data || []).forEach(cat => {
                        const catName = cat.categoryName;
                        if (!catName) return;
                        catCount++;
                        if (!categories[catName]) categories[catName] = {};
                        (cat.courses || []).forEach(course => {
                            const folderName = course.folderName;
                            if (!folderName) return;
                            courseCount++;
                            if (!categories[catName][folderName]) categories[catName][folderName] = {};
                            (course.lists || []).forEach(lst => {
                                const listName = lst.listName;
                                if (!listName) return;
                                const cards = Array.isArray(lst.cards) ? lst.cards : [];
                                listCount++;
                                cardCount += cards.length;
                                if (categories[catName][folderName][listName]) {
                                    const ok = confirm(`"${listName}" existe dans "${folderName}". √âcraser ?`);
                                    if (!ok) return;
                                }
                                categories[catName][folderName][listName] = cards;
                            });
                        });
                    });
                    if (data.results && typeof data.results === 'object') {
                        // merge non destructif des r√©sultats
                        function deepMerge(dst, src){
                            Object.keys(src).forEach(k=>{
                                if (src[k] && typeof src[k] === 'object' && !Array.isArray(src[k])) {
                                    if (!dst[k] || typeof dst[k] !== 'object') dst[k] = {};
                                    deepMerge(dst[k], src[k]);
                                } else {
                                    if (dst[k] === undefined) dst[k] = src[k];
                                }
                            });
                        }
                        if (!results || typeof results !== 'object') results = {};
                        deepMerge(results, data.results);
                        saveResults();
                    }
                    saveData();
                    updateCategoryList();
                    if (currentPage === 'home') updateHomeStats();
                    alert(`Import complet termin√© ‚úì\nCat√©gories:${catCount} ‚Ä¢ Cours:${courseCount} ‚Ä¢ Listes:${listCount} ‚Ä¢ Cartes:${cardCount}`);
                    event.target.value = '';
                    return;
                }
            } catch (err) {
                console.error('[IMPORT] Exception:', err);
                alert('Erreur impr√©vue pendant l\'import. Regarde la console pour le d√©tail.');
            }
            event.target.value = '';
        };
        reader.readAsText(file);
    });
    function clearCurrentList() { if (!currentCategory || !currentFolder || !currentList) return; if (!confirm('‚ö†Ô∏è Vider la liste ?')) return; categories[currentCategory][currentFolder][currentList] = []; if (results[currentCategory] && results[currentCategory][currentFolder]) { delete results[currentCategory][currentFolder][currentList]; saveResults(); } saveData(); currentIndex = 0; stats = {known: 0, partial: 0, unknown: 0}; updateCategoryList(); loadManageCardsPage(); }
    document.getElementById('categoryNameInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') createCategory(); });
    document.getElementById('folderNameInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') createFolder(); });
    document.getElementById('listNameInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') createList(); });
    document.getElementById('renameCategoryInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') renameCategory(); });
    document.getElementById('renameFolderInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') renameFolder(); });
    document.getElementById('renameListInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') renameList(); });
    document.getElementById('newCategoryModal').addEventListener('click', function(e) { if (e.target === this) closeNewCategoryModal(); });
    document.getElementById('newFolderModal').addEventListener('click', function(e) { if (e.target === this) closeNewFolderModal(); });
    document.getElementById('newListModal').addEventListener('click', function(e) { if (e.target === this) closeNewListModal(); });
    document.getElementById('renameCategoryModal').addEventListener('click', function(e) { if (e.target === this) closeRenameCategoryModal(); });
    document.getElementById('renameFolderModal').addEventListener('click', function(e) { if (e.target === this) closeRenameFolderModal(); });
    document.getElementById('renameListModal').addEventListener('click', function(e) { if (e.target === this) closeRenameListModal(); });
    // ====== COMPARATEUR DE TEXTE ======
    function openComparator() {
        document.getElementById('comparatorModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    function closeComparator() {
        document.getElementById('comparatorModal').classList.remove('show');
        document.body.style.overflow = 'auto';
    }
    // Variables comparateur
    let showContext = false;
    let lastFocusedId = null;
    let showOnlyDeletions = false;
    let lastFocusedType = null;
    let lastSelectedBtn = null;
    const $ = sel => document.querySelector(sel);
    const oldTA = $("#oldText");
    const newTA = $("#newText");
    const outComp = $("#diffOutput");
    const changesListComp = $("#changesList");
    const insCountComp = $("#insCount");
    const delCountComp = $("#delCount");
    const repCountComp = $("#repCount");
    const hintComp = $("#hint");
    const copyBtnComp = $("#copyBtn");
    const toggleContextBtnComp = $("#toggleContext");
    const backBtn = $("#backToSelected");
    const onlyDelBtn = document.getElementById("toggleOnlyDeletions");
    function escapeHtmlComp(s) { return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function normalizeSpaces(s) {
        return s.replace(/\r\n|\r/g, '\n').replace(/([^\n])\n/g, '$1 ').replace(/\t/g, ' ');
    }
    function emojiFor(t) { return t==='insertion' ? '‚ûï' : t==='suppression' ? '‚ûñ' : '‚ôªÔ∏è'; }
    function cap(s) { return s.charAt(0).toUpperCase()+s.slice(1); }
    function isOnlySpaces(s) { return !s || /^\s+$/.test(s); }
    function isWhitespaceOnlyChange(removed, added) {
        const r = (removed||"").replace(/\s+/g,'');
        const a = (added||"").replace(/\s+/g,'');
        return r === a && (removed!==added);
    }
    function updateBackButton() {
        if (lastSelectedBtn) {
            backBtn.classList.add('visible');
            backBtn.disabled = false;
        } else {
            backBtn.classList.remove('visible');
            backBtn.disabled = true;
        }
    }
    function clearFocusComp() {
        if (lastFocusedId) {
            const prev = document.getElementById(lastFocusedId);
            if (prev && prev.classList) prev.classList.remove('focused');
            const ghost = document.getElementById(lastFocusedId + '-ghost');
            if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
            const delGhost = document.getElementById(lastFocusedId + '-delghost');
            if (delGhost && delGhost.parentNode) delGhost.parentNode.removeChild(delGhost);
        }
        lastFocusedId = null;
        lastFocusedType = null;
    }
    function showDeletionGhostAfter(anchorEl, id, removedText) {
        const old = document.getElementById(id + '-delghost');
        if (old && old.parentNode) old.parentNode.removeChild(old);
        const ghost = document.createElement('span');
        ghost.id = id + '-delghost';
        ghost.className = 'del-ghost';
        const content = (removedText || '').replace(/\r\n|\r/g, '\n').replace(/\n/g, '‚Üµ');
        ghost.innerHTML = `<mark class="del">(${escapeHtmlComp(content)})</mark>`;
        anchorEl.insertAdjacentElement('afterend', ghost);
    }
    function focusChangeComp(id, type, options) {
        clearFocusComp();
        const el = document.getElementById(id);
        if (!el) return;
           
        if (el.tagName === 'MARK') {
            el.classList.add('focused');
            lastFocusedId = id;
            lastFocusedType = type || null;
        } else {
            lastFocusedId = id;
            lastFocusedType = type || 'suppression';
                   
            if ((type === 'suppression') && options && options.removedText) {
                showDeletionGhostAfter(el, id, options.removedText);
            } else {
                let ghost = document.getElementById(id + '-ghost');
                if (!ghost) {
                    ghost = document.createElement('span');
                    ghost.id = id + '-ghost';
                    ghost.className = 'focus-ghost';
                    el.insertAdjacentElement('afterend', ghost);
                }
            }
        }
           
        (el.tagName === 'MARK' ? el : document.getElementById(id)).scrollIntoView({behavior:'smooth', block:'center'});
    }
    function computeComp() {
        const oldTxt = oldTA.value || "";
        const newTxt = newTA.value || "";
        const parts = (window.Diff && Diff.diffWordsWithSpace) ? Diff.diffWordsWithSpace(oldTxt, newTxt) : [{removed:true,value:oldTxt},{added:true,value:newTxt}];
       
        let html = "";
        let changes = [];
        let ins=0, del=0, rep=0, idxChange=0;
       
        for (let i=0; i<parts.length; i++) {
            const p = parts[i];
           
            if (p.removed && !p.added) {
                const next = parts[i+1];
               
                if (next && next.added && !next.removed) {
                    const isWhitespaceOnly = isWhitespaceOnlyChange(p.value, next.value);
                   
                    if (!isOnlySpaces(next.value) && !isOnlySpaces(p.value) && !isWhitespaceOnly) {
                        const anchorId = `chg-${++idxChange}`;
                       
                        const removedHtml = `<mark class="del" id="${anchorId}-del">${escapeHtmlComp(normalizeSpaces(p.value))}</mark>`;
                        const addedHtml = `<mark class="ins" id="${anchorId}">${escapeHtmlComp(normalizeSpaces(next.value))}</mark>`;
                       
                        html += removedHtml + addedHtml;
                        rep++;
                        changes.push({id: anchorId, type: 'remplacement', added: next.value, removed: p.value, isWhitespaceOnly: false});
                        i++;
                        continue;
                    } else {
                        if (isWhitespaceOnly) {
                            html += escapeHtmlComp(normalizeSpaces(next.value));
                            rep++;
                            changes.push({id: `chg-${++idxChange}`, type: 'remplacement', added: next.value, removed: p.value, isWhitespaceOnly: true});
                            i++;
                            continue;
                        }
                    }
                }
               
                if (isOnlySpaces(p.value)) continue;
               
                const anchorId = `chg-${++idxChange}`;
                html += `<mark class="del" id="${anchorId}">${escapeHtmlComp(normalizeSpaces(p.value))}</mark>`;
                del++;
                changes.push({id: anchorId, type: 'suppression', added: '', removed: p.value, isWhitespaceOnly: false});
                continue;
            }
            if (p.added && !p.removed) {
                if (isOnlySpaces(p.value)) continue;
                const anchorId = `chg-${++idxChange}`;
                html += `<mark class="ins" id="${anchorId}">${escapeHtmlComp(normalizeSpaces(p.value))}</mark>`;
                ins++;
                changes.push({id: anchorId, type: 'insertion', added: p.value, removed: '', isWhitespaceOnly: false});
                continue;
            }
           
            html += escapeHtmlComp(normalizeSpaces(p.value));
        }
       
        outComp.innerHTML = html.replace(/\n/g, '<br>');
        const finalChanges = changes.filter(c => !c.isWhitespaceOnly);
       
        renderChangesListComp(finalChanges);
       
        insCountComp.textContent = finalChanges.filter(c => c.type === 'insertion').length;
        delCountComp.textContent = finalChanges.filter(c => c.type === 'suppression').length;
        repCountComp.textContent = finalChanges.filter(c => c.type === 'remplacement').length;
       
        hintComp.textContent = `${finalChanges.length} modifications d√©tect√©es${rep? " ‚Ä¢ remplacements: "+rep : ""}.`;
    }
    // --- LOGIQUE IMPORT TEXTE / CSV ---
    function showImportTextModal() {
        const modal = document.getElementById('importTextModal');
        const catSelect = document.getElementById('importCatSelect');
        const listInput = document.getElementById('importListName');
        const txtArea = document.getElementById('importTextContent');
       
        // Reset des champs
        listInput.value = '';
        txtArea.value = '';
        catSelect.innerHTML = '';
       
        // Remplir les cat√©gories
        const catNames = Object.keys(categories);
        if (catNames.length === 0) {
            alert("Cr√©ez d'abord une cat√©gorie et un cours via le bouton 'Cr√©er un cours'.");
            return;
        }
       
        catNames.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            catSelect.appendChild(opt);
        });
        // S√©lectionner la cat√©gorie courante si elle existe
        if (currentCategory && categories[currentCategory]) {
            catSelect.value = currentCategory;
        }
        updateImportFolderSelect();
        modal.classList.add('show');
        setTimeout(() => listInput.focus(), 100);
    }
    function updateImportFolderSelect() {
        const catSelect = document.getElementById('importCatSelect');
        const folderSelect = document.getElementById('importFolderSelect');
        const catName = catSelect.value;
       
        folderSelect.innerHTML = '';
       
        if (catName && categories[catName]) {
            const folders = Object.keys(categories[catName]);
            if (folders.length === 0) {
                const opt = document.createElement('option');
                opt.text = "(Aucun cours)";
                folderSelect.appendChild(opt);
            } else {
                folders.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f;
                    opt.textContent = f;
                    folderSelect.appendChild(opt);
                });
                // Pr√©-s√©lectionner le dossier courant si pertinent
                if (currentCategory === catName && currentFolder && categories[catName][currentFolder]) {
                    folderSelect.value = currentFolder;
                }
            }
        }
    }
    function closeImportTextModal() {
        document.getElementById('importTextModal').classList.remove('show');
    }
    function performTextImport() {
        const catName = document.getElementById('importCatSelect').value;
        const folderName = document.getElementById('importFolderSelect').value;
        const listName = document.getElementById('importListName').value.trim();
        const rawText = document.getElementById('importTextContent').value;
        const sepType = document.getElementById('importSeparator').value;
        // Validations
        if (!catName || !folderName || folderName === "(Aucun cours)") {
            alert("Veuillez s√©lectionner une cat√©gorie et un cours valides.");
            return;
        }
        if (!listName) {
            alert("Veuillez donner un nom √† la liste.");
            return;
        }
        if (!rawText.trim()) {
            alert("Le texte √† importer est vide.");
            return;
        }
        // D√©termination du s√©parateur r√©el
        let separator = sepType;
        if (sepType === 'tab') separator = '\t';
        // Analyse du texte ligne par ligne
        const lines = rawText.split(/\r?\n/);
        let importedCount = 0;
        const newCards = [];
        lines.forEach(line => {
            if (!line.trim()) return; // Ignorer lignes vides
           
            // On s√©pare la ligne en 2 parties maximum (Question / Reste)
            // Si la r√©ponse contient le s√©parateur, on ne veut pas couper encore
            const parts = line.split(separator);
           
            if (parts.length >= 2) {
                const q = parts[0].trim();
                // On rejoint le reste au cas o√π le s√©parateur serait dans la r√©ponse
                const a = parts.slice(1).join(separator).trim();
               
                if (q && a) {
                    newCards.push({ question: q, answer: a });
                    importedCount++;
                }
            }
        });
        if (importedCount === 0) {
            alert("Aucune carte d√©tect√©e. V√©rifiez le s√©parateur (ex: Tabulation vs Virgule).");
            return;
        }
        // Sauvegarde dans la structure de donn√©es
        if (!categories[catName][folderName][listName]) {
            // Cr√©ation nouvelle liste
            categories[catName][folderName][listName] = [];
        } else {
            // La liste existe, on demande si on fusionne
            if (!confirm(`La liste "${listName}" existe d√©j√†. Voulez-vous ajouter ces ${importedCount} cartes √† la suite ?`)) {
                return;
            }
        }
        // Ajout des cartes
        categories[catName][folderName][listName].push(...newCards);
       
        saveData();
        updateCategoryList(); // Met √† jour la barre lat√©rale
       
        // Si on est sur l'accueil, mettre √† jour les stats
        if (currentPage === 'home') updateHomeStats();
       
        // Feedback et fermeture
        alert(`${importedCount} cartes import√©es avec succ√®s dans "${listName}" !`);
        closeImportTextModal();
       
        // Redirection imm√©diate vers la liste cr√©√©e
        showListsPage(catName, folderName);
    }
    function flashSidebarCard(btn) {
        const prevShadow = btn.style.boxShadow;
        btn.style.boxShadow = '0 0 0 3px rgba(255,209,102,0.45)';
        setTimeout(() => { btn.style.boxShadow = prevShadow; }, 750);
    }
    function renderChangesListComp(changes) {
        changesListComp.innerHTML = "";
       
        let filtered = changes;
        if (showOnlyDeletions) {
            filtered = changes.filter(c => c.type === 'suppression' || c.type === 'remplacement');
        }
        if (!filtered.length) {
            changesListComp.innerHTML = '<div style="color:#8b93a6;padding:8px">Aucun changement.</div>';
            updateBackButton();
            return;
        }
        const ctxSpan = showContext ? 24 : 0;
        let toRestoreId = (lastSelectedBtn && lastSelectedBtn.dataset.id) ? lastSelectedBtn.dataset.id : null;
        lastSelectedBtn = null;
        for (const c of filtered) {
            const btn = document.createElement('button');
            btn.className = 'comp-change';
            btn.type = 'button';
            btn.dataset.id = c.id;
            btn.dataset.type = c.type;
            if (c.type === 'suppression' || c.type === 'remplacement') {
                btn.dataset.removed = c.removed;
            }
            let tokenHtml = '';
            if (c.type === 'insertion') {
                tokenHtml = `<mark class="token">${escapeHtmlComp(c.added.replace(/\n/g, '‚Üµ'))}</mark>`;
            } else if (c.type === 'suppression') {
                tokenHtml = `<mark class="token del">${escapeHtmlComp(c.removed.replace(/\n/g, '‚Üµ'))}</mark>`;
            } else {
                tokenHtml = `<mark class="token del">${escapeHtmlComp(c.removed.replace(/\n/g, '‚Üµ'))}</mark> <span style="display:inline-block;width:6px"></span> <mark class="token">${escapeHtmlComp(c.added.replace(/\n/g, '‚Üµ'))}</mark>`;
            }
            let ctx = '';
            if (ctxSpan > 0) {
                const src = c.type==='suppression' ? (oldTA.value||"") : (newTA.value||"");
                const needle = (c.type==='suppression' ? c.removed : c.added) || "";
               
                const pos = needle.length > 0 ? src.indexOf(needle) : -1;
               
                if (pos>=0) {
                    const start = Math.max(0,pos-ctxSpan);
                    const end = Math.min(src.length, pos+needle.length+ctxSpan);
                    ctx = (start>0?'‚Ä¶':'') + src.slice(start,end).replace(/\r\n|\r/g, '\n').replace(/\n/g, '‚Üµ').replace(/\s+/g,' ') + (end<src.length?'‚Ä¶':'');
                }
            }
           
            btn.innerHTML = `<span class="type">${emojiFor(c.type)} ${cap(c.type)}</span> ${tokenHtml} ${ctx ? `<span class="ctx">${escapeHtmlComp(ctx)}</span>` : ``}`;
            btn.addEventListener('click', () => {
                const prev = document.querySelector('.comp-change.selected');
                if (prev) prev.classList.remove('selected');
                btn.classList.add('selected');
                lastSelectedBtn = btn;
                let focusId = btn.dataset.id;
                let focusType = btn.dataset.type;
                const isReplacement = focusType === 'remplacement';
               
                if (isReplacement) focusType = 'insertion';
                const opts = (btn.dataset.type === 'suppression') ? { removedText: btn.dataset.removed || '' } : undefined;
               
                focusChangeComp(isReplacement ? focusId : focusId, focusType, opts);
                updateBackButton();
            });
            changesListComp.appendChild(btn);
            if (toRestoreId && c.id === toRestoreId) {
                btn.classList.add('selected');
                lastSelectedBtn = btn;
            }
        }
        updateBackButton();
    }
    document.getElementById("compareBtn").addEventListener('click', () => {
        if (lastSelectedBtn) { lastSelectedBtn.classList.remove('selected'); lastSelectedBtn = null; }
        clearFocusComp();
        computeComp();
        updateBackButton();
    });
    document.getElementById("toggleContext").addEventListener('click', () => {
        showContext = !showContext;
        document.getElementById("toggleContext").textContent = showContext ? "Contexte ‚Äî" : "¬± Contexte";
        const prevSelectedId = lastSelectedBtn ? lastSelectedBtn.dataset.id : null;
        const prevFocused = lastFocusedId;
        computeComp();
        if (prevSelectedId) {
            const candidate = Array.from(document.querySelectorAll('.comp-change')).find(b => b.dataset.id === prevSelectedId);
            if (candidate) {
                candidate.classList.add('selected');
                lastSelectedBtn = candidate;
            } else {
                lastSelectedBtn = null;
            }
        }
        if (prevFocused) {
            const el = document.getElementById(prevFocused);
            if (el && el.tagName === 'MARK') {
                el.classList.add('focused');
                lastFocusedId = prevFocused;
            } else {
                lastFocusedId = null;
                lastFocusedType = null;
            }
        }
        updateBackButton();
    });
    document.getElementById("copyBtn").addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(outComp.innerHTML);
            copyBtnComp.textContent = 'Copi√© ‚úì';
            setTimeout(() => copyBtnComp.textContent = 'Copier le r√©sultat', 900);
        } catch(e) {
            alert("Impossible de copier. S√©lectionne et copie manuellement.");
        }
    });
    backBtn.addEventListener('click', () => {
        if (!lastSelectedBtn) return;
        lastSelectedBtn.scrollIntoView({behavior:'smooth', block:'center'});
        flashSidebarCard(lastSelectedBtn);
    });
    onlyDelBtn.addEventListener('click', () => {
        showOnlyDeletions = !showOnlyDeletions;
        onlyDelBtn.classList.toggle('active', showOnlyDeletions);
        onlyDelBtn.textContent = showOnlyDeletions ? '‚ûñ Suppressions (ON)' : '‚ûñ Suppressions uniquement';
        const prevSelectedId = lastSelectedBtn ? lastSelectedBtn.dataset.id : null;
        const prevFocused = lastFocusedId;
        computeComp();
       
        if (prevSelectedId) {
            const cand = Array.from(document.querySelectorAll('.comp-change')).find(b => b.dataset.id === prevSelectedId);
            if (cand) {
                cand.classList.add('selected');
                lastSelectedBtn = cand;
            } else {
                lastSelectedBtn = null;
            }
        }
        if (prevFocused) {
            const el = document.getElementById(prevFocused);
            if (el && el.tagName === 'MARK') {
                el.classList.add('focused');
                lastFocusedId = prevFocused;
            } else {
                lastFocusedId = null;
                lastFocusedType = null;
            }
        }
        updateBackButton();
    });
    oldTA.value = "Le contrat entre en vigueur le 1er janvier 2024.\nLe prix est de 100‚Ç¨.\nLe client accepte les conditions.";
    newTA.value = "Le contrat prend effet le 1er janvier 2025.\nLe prix est de 120 ‚Ç¨.\nLe client accepte pleinement les conditions g√©n√©rales.";
    loadTheme();
    loadData();
    bootstrapEmbedIfAny();
    </script>
</body>
</html>
